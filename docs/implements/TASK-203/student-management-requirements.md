# TASK-203: 受講者管理機能 - TDD要件定義書

**タスクID**: TASK-203  
**作成日**: 2025-08-24  
**フェーズ**: TDD Requirements Definition  
**実装対象**: 受講者管理機能の完全実装

## 1. 要件概要

### 【主要機能】
受講者情報の総合管理システムを実装し、以下の機能を提供する：

- **受講者CRUD操作**: 受講者の登録・参照・更新・削除機能
- **企業別受講者管理**: 企業に紐づく受講者の一元管理
- **受講者検索機能**: 名前・メール・企業による受講者検索
- **役割管理統合**: student/company_adminの役割タイプ管理
- **RBAC統合**: 役割ベースのアクセス制御統合
- **監査ログ**: 受講者操作の完全な監査追跡

### 【既存実装状況】
- **85%実装済み**: 基本的な受講者エンティティモデルとリレーション機能
- **必要な追加実装**: RBAC統合、API層（Controller）、View層、高度な検索機能

## 2. 機能要件 (EARS形式)

### 【R-203-001】受講者作成機能 🟢
**要件**: システムは、管理者または企業管理者が受講者情報を作成した際に、受講者データをデータベースに保存しなければならない。

**詳細条件**:
- 受講者名、メール、企業ID、役割タイプ、所属組織は必須項目
- UUID主キーの自動生成
- 作成日時・更新日時の自動設定
- 入力値検証（メール形式、文字数制限）
- 企業内でのメール一意性制約（UNIQUE(email, company_id)）

**RBAC要件**: Admin権限または対象企業のCompanyAdmin権限が必要

### 【R-203-002】受講者参照機能 🟢
**要件**: システムは、認証済みユーザーが受講者情報を参照した際に、権限に応じた受講者データを返却しなければならない。

**詳細条件**:
- 全受講者一覧取得（管理者のみ）
- 企業別受講者一覧取得（企業管理者は自社のみ）
- 受講者ID指定での単体取得
- 受講者名での部分一致検索
- メールアドレスでの検索
- 企業IDでの絞り込み検索

**RBAC要件**: 
- Admin: 全受講者アクセス可能
- CompanyAdmin: 自社受講者のみアクセス可能
- Trainer/Instructor: 担当研修の受講者のみアクセス可能

### 【R-203-003】受講者更新機能 🟢
**要件**: システムは、管理者または企業管理者が受講者情報を更新した際に、変更内容をデータベースに反映しなければならない。

**詳細条件**:
- 受講者名、メール、役割タイプ、所属組織の更新
- 企業IDの変更（管理者のみ）
- updated_atの自動更新（データベーストリガー）
- 楽観的排他制御による競合状態の回避
- 更新前後の差分による監査ログ生成
- メール変更時の一意性制約チェック

**RBAC要件**: Admin権限または対象企業のCompanyAdmin権限が必要

### 【R-203-004】受講者削除機能（制約付き） 🟢
**要件**: システムは、管理者または企業管理者が受講者削除を実行した際に、関連データの整合性を確認してから削除処理を実行しなければならない。

**詳細条件**:
- **制約チェック**: 進行中の研修プロジェクトに参加している場合は削除拒否
- **関連データ確認**: Projects参加状況、Interview予定の関連チェック
- **エラーレスポンス**: 削除不可理由の明確な提示
- **監査ログ**: 削除試行と結果の記録

**RBAC要件**: Admin権限または対象企業のCompanyAdmin権限が必要

### 【R-203-005】企業別受講者検索機能 🟢
**要件**: システムは、ユーザーが受講者検索を実行した際に、権限に応じた検索結果を返却しなければならない。

**詳細条件**:
- 受講者名での部分一致検索
- メールアドレスでの完全一致検索
- 企業名での受講者絞り込み
- 役割タイプでの絞り込み（student/company_admin）
- 複合条件検索（名前 + 企業 + 役割）
- ソート機能（作成日順、名前順、企業順）

**RBAC要件**: 権限に応じたデータスコープ制限

### 【R-203-006】受講者企業移管機能 🟢
**要件**: システムは、管理者が受講者の所属企業変更を実行した際に、関連データの整合性を保持して移管処理を実行しなければならない。

**詳細条件**:
- 移管先企業でのメール一意性制約チェック
- 進行中の研修プロジェクトの処理方針確認
- 移管履歴の監査ログ記録
- 関連データの適切な更新

**RBAC要件**: Admin権限のみ

## 3. 技術要件

### 【データベース制約】
- **主キー**: UUID型（自動生成）
- **外部キー制約**: Students → Companies (RESTRICT)
- **一意制約**: UNIQUE(email, company_id)
- **インデックス**: name, email, company_id, role_type
- **トリガー**: updated_at自動更新

### 【バリデーション要件】
```rust
struct StudentValidator {
    name: String,           // 必須、1-100文字
    email: String,          // 必須、有効なメール形式
    company_id: Uuid,       // 必須、有効な企業ID
    role_type: String,      // 必須、"student" または "company_admin"
    organization: String,   // 必須、1-100文字
}
```

### 【エラーハンドリング】
- **422 Unprocessable Entity**: バリデーションエラー
- **403 Forbidden**: 権限不足
- **409 Conflict**: メール一意制約違反、削除制約違反
- **404 Not Found**: 受講者・企業が存在しない

## 4. テストケース設計

### 【TC-203-001】受講者作成テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_受講者作成機能正常() {
    // 管理者権限での受講者作成が成功すること
    // UUID主キー、タイムスタンプが自動生成されること
    // 企業との関連が正常に設定されること
}
```

### 【TC-203-002】メール一意制約テスト 🟢
```rust
#[tokio::test]
#[serial] 
async fn test_同一企業内メール重複エラー() {
    // 同一企業内での重複メールアドレスでエラーになること
    // 異なる企業間では同じメールアドレスが許可されること
}
```

### 【TC-203-003】企業別受講者検索テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業別受講者検索() {
    // 指定企業の受講者一覧が正常取得されること  
    // 他企業の受講者が混入しないこと
}
```

### 【TC-203-004】RBAC統合テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_受講者管理RBAC制御() {
    // Admin権限で全受講者管理が可能なこと
    // CompanyAdmin権限で自社受講者のみ管理可能なこと
    // Trainer権限で読み取り専用アクセスなこと
}
```

### 【TC-203-005】受講者企業移管テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_受講者企業移管機能() {
    // 管理者による受講者の企業移管が正常動作すること
    // 移管先での一意制約チェックが機能すること
}
```

### 【TC-203-006】受講者削除制約テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_進行中研修参加受講者削除拒否() {
    // 進行中の研修に参加する受講者の削除が拒否されること
    // 適切なエラーメッセージが返却されること
}
```

## 5. 実装対象ファイル

### 【必要な実装・修正】
```
src/models/students.rs          # RBAC統合、削除制約ビジネスロジック追加
src/controllers/students.rs    # 新規作成（API層）
src/views/students.rs           # 新規作成（View層）
tests/models/students.rs        # テストケース追加
tests/controllers/students.rs  # 新規作成（Controller テスト）
```

### 【既存ファイル状況】
- `src/models/students.rs`: 85%実装済み（基本CRUD、リレーション機能実装済み）
- `src/models/_entities/students.rs`: 完全実装済み（SeaORM生成）
- `tests/models/students.rs`: 基本テスト実装済み（3テストケース）
- Database Schema: 完全実装済み（制約・インデックス設定済み）

## 6. APIエンドポイント仕様

### 【受講者管理API】
```
GET    /api/students                    # 受講者一覧取得
GET    /api/students/{id}               # 受講者詳細取得  
POST   /api/students                    # 受講者作成 [Admin/CompanyAdmin]
PUT    /api/students/{id}               # 受講者更新 [Admin/CompanyAdmin]
DELETE /api/students/{id}               # 受講者削除 [Admin/CompanyAdmin]
GET    /api/students/search             # 受講者検索
GET    /api/companies/{id}/students     # 企業別受講者一覧
PUT    /api/students/{id}/transfer      # 受講者企業移管 [Admin]
```

## 7. 成功条件

### 【実装完了基準】
- [ ] 全テストケースが通過（6件）
- [ ] RBAC統合テストが成功
- [ ] メール一意制約テストが成功  
- [ ] 企業別検索テストが成功
- [ ] 受講者削除制約テストが成功
- [ ] 企業移管機能テストが成功

### 【品質基準】
- [ ] コードカバレッジ: 95%以上
- [ ] セキュリティレビュー: 合格
- [ ] パフォーマンステスト: 合格
- [ ] TASK-202企業管理機能との統合テスト: 合格

## 8. リスク・注意事項

### 【技術的リスク】
- **データ整合性**: 受講者削除時の研修プロジェクト参加状況チェックの複雑性
- **パフォーマンス**: 大量受講者データでの企業別検索性能
- **RBAC複雑性**: 企業管理者の権限スコープ制御の実装難易度

### 【ビジネスリスク】
- **運用影響**: 受講者企業移管機能による運用フローへの影響
- **データ整合性**: 企業間移管時の関連データ処理の複雑性

## 9. 実装順序

1. **Phase 1**: Model層の高度なビジネスロジック追加（削除制約、企業移管）
2. **Phase 2**: RBAC統合実装（権限チェック、スコープ制限）
3. **Phase 3**: API層（Controller）実装
4. **Phase 4**: View層実装
5. **Phase 5**: テストケース実装・検証
6. **Phase 6**: TASK-202企業管理機能との統合テスト

## 10. 依存関係・前提条件

### 【前提条件】
- TASK-202企業管理機能が完全実装済み ✅
- セッション認証システムが稼働中 ✅
- PostgreSQLスキーマが設定済み ✅

### 【統合ポイント】
- TASK-202で実装された企業検索機能との連携
- TASK-202で実装された企業削除制約との整合性確認
- セッション認証におけるRBAC権限確認の統一化

---
**信頼性レベル説明**:
- 🟢 青信号: 既存実装・スキーマ・要件書から確実に確認できる仕様
- 🟡 黄信号: 推測だが高い確率で正しいと思われる仕様  
- 🔴 赤信号: 推測で確証がない仕様（実装時要確認）