# TASK-101: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼å®Ÿè£… - TDDè¦ä»¶å®šç¾©æ›¸

## 1. æ©Ÿèƒ½ã®æ¦‚è¦ï¼ˆEARSè¦ä»¶å®šç¾©æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ãƒ™ãƒ¼ã‚¹ï¼‰

### ğŸŸ¡ **é»„ä¿¡å·**: EARSè¦ä»¶å®šç¾©æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬

**æ©Ÿèƒ½å**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼å®Ÿè£…

**ä½•ã‚’ã™ã‚‹æ©Ÿèƒ½ã‹**:
- æ—¢å­˜JWTãƒ™ãƒ¼ã‚¹èªè¨¼ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã¸ã®ç§»è¡Œ
- å®‰å…¨ãªãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã®å®Ÿè£…
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨CSRFä¿è­·æ©Ÿèƒ½ã®æä¾›
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ã‚ˆã‚‹èªè¨¼ãƒã‚§ãƒƒã‚¯

**è§£æ±ºã™ã‚‹å•é¡Œ**:
- JWTãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ä¿å­˜ã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯è»½æ¸›
- ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡ï¼ˆå¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰
- CSRFæ”»æ’ƒé˜²å¾¡ã®å¼·åŒ–
- ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ã®æŸ”è»Ÿãªç®¡ç†

**æƒ³å®šã•ã‚Œã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼**:
- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼ˆadminï¼‰
- ç ”ä¿®æ‹…å½“è€…ï¼ˆtrainerï¼‰  
- è¬›å¸«ï¼ˆinstructorï¼‰

**ã‚·ã‚¹ãƒ†ãƒ å†…ã§ã®ä½ç½®ã¥ã‘**:
- ãƒ•ã‚§ãƒ¼ã‚º2èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ ã®åŸºç›¤æ©Ÿèƒ½
- å…¨ã¦ã®ã‚³ã‚¢æ©Ÿèƒ½ï¼ˆãƒ•ã‚§ãƒ¼ã‚º3ï¼‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡åŸºç›¤
- TASK-102ï¼ˆRBACï¼‰ã®å‰ææ¡ä»¶

**å‚ç…§ã—ãŸEARSè¦ä»¶**: REQ-001ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼‰, REQ-002ï¼ˆå½¹å‰²ãƒ™ãƒ¼ã‚¹èªè¨¼ï¼‰, REQ-407ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰, NFR-102ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ï¼‰
**å‚ç…§ã—ãŸè¨­è¨ˆæ–‡æ›¸**: CLAUDE.mdï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®æ–¹é‡ï¼‰

## 2. å…¥åŠ›ãƒ»å‡ºåŠ›ã®ä»•æ§˜ï¼ˆEARSæ©Ÿèƒ½è¦ä»¶ãƒ»TypeScriptå‹å®šç¾©ãƒ™ãƒ¼ã‚¹ï¼‰

### ğŸŸ¢ **é’ä¿¡å·**: æ—¢å­˜å®Ÿè£…ã‹ã‚‰æŠ½å‡º

### å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

**ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†**:
```rust
// æ—¢å­˜ã®LoginParamsæ§‹é€ ä½“ã‚’æ´»ç”¨
pub struct LoginParams {
    pub email: String,        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: emailå½¢å¼
    pub password: String,     // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: æœ€å°8æ–‡å­—
}
```

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå‡¦ç†**:
```rust
pub struct SessionCreateParams {
    pub user_id: i32,         // usersãƒ†ãƒ¼ãƒ–ãƒ«ã®ID
    pub session_token: String, // æš—å·å­¦çš„ã«å®‰å…¨ãªä¹±æ•°
    pub expires_at: DateTimeWithTimeZone, // ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™
}
```

### å‡ºåŠ›å€¤

**ãƒ­ã‚°ã‚¤ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```rust
// ã‚»ãƒƒã‚·ãƒ§ãƒ³æ–¹å¼ã«å¤‰æ›´ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
pub struct SessionLoginResponse {
    pub success: bool,
    pub user: UserInfo,       // ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±
    pub csrf_token: String,   // CSRFä¿è­·ãƒˆãƒ¼ã‚¯ãƒ³
}
```

**ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèªãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```rust
pub struct SessionCurrentResponse {
    pub user: UserInfo,       // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
    pub csrf_token: String,   // æ–°ã—ã„CSRFãƒˆãƒ¼ã‚¯ãƒ³
}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼**: POST /api/auth/login â†’ èªè¨¼æƒ…å ±æ¤œè¨¼ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ â†’ Cookieã‚»ãƒƒãƒˆ
2. **èªè¨¼ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ³¨å…¥
3. **ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ•ãƒ­ãƒ¼**: POST /api/auth/logout â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ â†’ Cookieå‰Šé™¤

**å‚ç…§ã—ãŸEARSè¦ä»¶**: REQ-001, REQ-407
**å‚ç…§ã—ãŸè¨­è¨ˆæ–‡æ›¸**: src/controllers/auth.rsï¼ˆæ—¢å­˜JWTå®Ÿè£…ï¼‰, src/models/users.rsï¼ˆèªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

## 3. åˆ¶ç´„æ¡ä»¶ï¼ˆEARSéæ©Ÿèƒ½è¦ä»¶ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆãƒ™ãƒ¼ã‚¹ï¼‰

### ğŸŸ¢ **é’ä¿¡å·**: EARSè¦ä»¶å®šç¾©æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ã‚’å‚è€ƒ

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ï¼ˆNFR-102ï¼‰

**CSRFä¿è­·**:
- å…¨ã¦ã®çŠ¶æ…‹å¤‰æ›´æ“ä½œã§CSRFãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
- ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**:
- ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™: 24æ™‚é–“ï¼ˆè¨­å®šå¯èƒ½ï¼‰
- ã‚¢ã‚¤ãƒ‰ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: last_accessed_at ã®è‡ªå‹•æ›´æ–°
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šæ”»æ’ƒå¯¾ç­–ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³å†ç”Ÿæˆï¼‰

**Cookieã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**:
- HttpOnlyå±æ€§: JavaScript ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢
- Secureå±æ€§: HTTPSé€šä¿¡å¿…é ˆï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
- SameSite=Strict: CSRFæ”»æ’ƒé˜²æ­¢

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

**ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢æ€§èƒ½**:
- session_tokenã§ã®æ¤œç´¢: ä¸€æ„åˆ¶ç´„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: æœŸé™åˆ‡ã‚Œã‚»ãƒƒã‚·ãƒ§ãƒ³å®šæœŸå‰Šé™¤
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æœ€é©åŒ–: å¿…è¦æœ€å°é™ã®æƒ…å ±ã®ã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ ¼ç´

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ¶ç´„

**Loco.rs 0.16.3ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯åˆ¶ç´„**:
- AxumãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãƒ‘ã‚¿ãƒ¼ãƒ³æº–æ‹ 
- SeaORM 1.1.12 ORMæ´»ç”¨
- æ—¢å­˜Authenticableãƒˆãƒ¬ã‚¤ãƒˆå®Ÿè£…ã®æ´»ç”¨

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„**:
- æ—¢å­˜sessionsãƒ†ãƒ¼ãƒ–ãƒ«æ´»ç”¨ï¼ˆCSRFãƒˆãƒ¼ã‚¯ãƒ³è¿½åŠ ãŒå¿…è¦ï¼‰
- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„: users.id â†’ sessions.user_id
- session_tokenã®ä¸€æ„åˆ¶ç´„æ´»ç”¨

**APIåˆ¶ç´„**:
- æ—¢å­˜auth ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ§‹é€ ç¶­æŒ
- JWTãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³å½¢å¼ã¸ã®å¤‰æ›´
- å¾Œæ–¹äº’æ›æ€§ã®ç¶­æŒï¼ˆæ®µéšçš„ç§»è¡Œï¼‰

**å‚ç…§ã—ãŸEARSè¦ä»¶**: NFR-102ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰, REQ-407ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰
**å‚ç…§ã—ãŸè¨­è¨ˆæ–‡æ›¸**: CLAUDE.mdï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ¶ç´„ï¼‰, src/models/_entities/sessions.rsï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ï¼‰

## 4. æƒ³å®šã•ã‚Œã‚‹ä½¿ç”¨ä¾‹ï¼ˆEARSEdgeã‚±ãƒ¼ã‚¹ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼‰

### ğŸŸ¡ **é»„ä¿¡å·**: EARSè¦ä»¶å®šç¾©æ›¸ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬

### åŸºæœ¬çš„ãªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³

**æ­£å¸¸ãƒ­ã‚°ã‚¤ãƒ³ã‚·ãƒŠãƒªã‚ª**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«èªè¨¼æƒ…å ±å…¥åŠ›
2. POST /api/auth/login ã§ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é€ä¿¡
3. users::Model::verify_password ã«ã‚ˆã‚‹èªè¨¼æ¤œè¨¼
4. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆsessions ãƒ†ãƒ¼ãƒ–ãƒ«ã¸INSERTï¼‰
5. HttpOnly Cookieã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š
6. CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§è¿”å´

**èªè¨¼ãŒå¿…è¦ãªæ“ä½œ**:
1. ä¿è­·ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§Cookieã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
3. sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã§ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒ»æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
4. last_accessed_at ã®æ›´æ–°
5. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ³¨å…¥

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

**EDGE-001: ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œ**:
- expires_at è¶…éæ™‚ã®è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
- æœŸé™åˆ‡ã‚Œæ¤œå‡ºæ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
- ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ã®é©åˆ‡ãªãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**EDGE-002: ä¸æ­£ã‚»ãƒƒã‚·ãƒ§ãƒ³**:
- å­˜åœ¨ã—ãªã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã§ã®ã‚¢ã‚¯ã‚»ã‚¹
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³æ”¹ã–ã‚“ã®æ¤œå‡º
- ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²

**EDGE-003: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç«¶åˆ**:
- åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨±å¯
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸Šé™ç®¡ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Šæœ€å¤§5ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰
- å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è‡ªå‹•ç„¡åŠ¹åŒ–

**EDGE-004: CSRFæ”»æ’ƒé˜²å¾¡**:
- çŠ¶æ…‹å¤‰æ›´æ“ä½œã§ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- ãƒˆãƒ¼ã‚¯ãƒ³ä¸ä¸€è‡´æ™‚ã®å‡¦ç†æ‹’å¦
- æ”»æ’ƒè©¦è¡Œã®ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

**ERR-001: ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—**:
- ä¸æ­£ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
- è¤‡æ•°å›å¤±æ•—æ™‚ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯æ©Ÿèƒ½
- ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒå¯¾ç­–

**ERR-002: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå¤±æ•—**:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªå‡¦ç†
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ä¸€æ™‚çš„ãªéšœå®³æ™‚ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹

**å‚ç…§ã—ãŸEARSè¦ä»¶**: TASK-101å®Œäº†æ¡ä»¶ï¼ˆæ­£ã—ã„èªè¨¼æƒ…å ±ã§ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã€ä¸æ­£ãªèªè¨¼æƒ…å ±ã§ãƒ­ã‚°ã‚¤ãƒ³æ‹’å¦ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æ­£å¸¸å‹•ä½œã€CSRFæ”»æ’ƒé˜²å¾¡ï¼‰
**å‚ç…§ã—ãŸè¨­è¨ˆæ–‡æ›¸**: æ—¢å­˜src/controllers/auth.rs ã®èªè¨¼ãƒ•ãƒ­ãƒ¼

## 5. EARSè¦ä»¶ãƒ»è¨­è¨ˆæ–‡æ›¸ã¨ã®å¯¾å¿œé–¢ä¿‚

### å‚ç…§ã—ãŸãƒ¦ãƒ¼ã‚¶ã‚¹ãƒˆãƒ¼ãƒªãƒ¼
- ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨è€…ã®å®‰å…¨ãªãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½

### å‚ç…§ã—ãŸæ©Ÿèƒ½è¦ä»¶
- **REQ-001**: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½
- **REQ-002**: å½¹å‰²ãƒ™ãƒ¼ã‚¹èªè¨¼ï¼ˆå¾Œç¶šTASK-102ã®å‰æï¼‰
- **REQ-407**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½

### å‚ç…§ã—ãŸéæ©Ÿèƒ½è¦ä»¶
- **NFR-102**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ï¼ˆCSRFä¿è­·ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰

### å‚ç…§ã—ãŸEdgeã‚±ãƒ¼ã‚¹
- TASK-101 å®Œäº†æ¡ä»¶ã«åŸºã¥ãåŸºæœ¬çš„ãªã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹æƒ³å®š

### å‚ç…§ã—ãŸå—ã‘å…¥ã‚ŒåŸºæº–
- æ­£ã—ã„èªè¨¼æƒ…å ±ã§ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
- ä¸æ­£ãªèªè¨¼æƒ…å ±ã§ãƒ­ã‚°ã‚¤ãƒ³æ‹’å¦  
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒæ­£å¸¸å‹•ä½œ
- CSRFæ”»æ’ƒãŒé˜²å¾¡ã•ã‚Œã‚‹

### å‚ç…§ã—ãŸè¨­è¨ˆæ–‡æ›¸
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: CLAUDE.mdï¼ˆLoco.rs 0.16.3ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼æ–¹é‡ï¼‰
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: src/models/_entities/sessions.rsï¼ˆæ—¢å­˜sessionsãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- **æ—¢å­˜å®Ÿè£…**: src/controllers/auth.rsï¼ˆJWTã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ã®ç§»è¡Œå¯¾è±¡ï¼‰, src/models/users.rsï¼ˆèªè¨¼ãƒ­ã‚¸ãƒƒã‚¯æ´»ç”¨ï¼‰
- **ORM**: SeaORM 1.1.12 ã«ã‚ˆã‚‹æ—¢å­˜ãƒ¢ãƒ‡ãƒ«æ§‹é€ 

## æŠ€è¡“å®Ÿè£…ä»•æ§˜

### å¿…è¦ãªå®Ÿè£…å¤‰æ›´

**1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ **:
```rust
// src/models/sessions.rs ã«è¿½åŠ 
impl Model {
    pub async fn create_session(db: &DatabaseConnection, user_id: i32) -> ModelResult<Self>
    pub async fn find_by_token(db: &DatabaseConnection, token: &str) -> ModelResult<Self>
    pub async fn invalidate_session(db: &DatabaseConnection, token: &str) -> ModelResult<()>
    pub async fn cleanup_expired_sessions(db: &DatabaseConnection) -> ModelResult<()>
}
```

**2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…**:
```rust
// src/middleware/session_auth.rsï¼ˆæ–°è¦ä½œæˆï¼‰
pub async fn session_auth_middleware(
    State(ctx): State<AppContext>,
    mut req: Request,
    next: Next,
) -> Result<Response, StatusCode>
```

**3. èªè¨¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä¿®æ­£**:
```rust
// src/controllers/auth.rs ã®ä¿®æ­£
// JWTãƒ¬ã‚¹ãƒãƒ³ã‚¹ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‹CSRFæ–¹å¼ã¸ã®å¤‰æ›´
async fn login(State(ctx): State<AppContext>, Json(params): Json<LoginParams>) -> Result<Response>
async fn logout(State(ctx): State<AppContext>) -> Result<Response>
async fn current(State(ctx): State<AppContext>) -> Result<Response>
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒæ´»ç”¨
æ—¢å­˜ã®sessionsãƒ†ãƒ¼ãƒ–ãƒ«:
- id (UUID): ä¸»ã‚­ãƒ¼
- user_id (i32): å¤–éƒ¨ã‚­ãƒ¼ï¼ˆusers.idï¼‰ 
- session_token (String): ã‚»ãƒƒã‚·ãƒ§ãƒ³è­˜åˆ¥å­ï¼ˆä¸€æ„åˆ¶ç´„ï¼‰
- expires_at (DateTimeWithTimeZone): ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™
- created_at (DateTimeWithTimeZone): ä½œæˆæ—¥æ™‚
- last_accessed_at (DateTimeWithTimeZone): æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ—¥æ™‚

**æ³¨æ„**: CSRFä¿è­·ã®ãŸã‚ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§csrf_tokenã‚«ãƒ©ãƒ ã®è¿½åŠ ãŒå¿…è¦ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### å¿…è¦ãªä¾å­˜é–¢ä¿‚
```toml
# Cargo.toml ã¸ã®è¿½åŠ ï¼ˆæš—å·å­¦çš„æ©Ÿèƒ½ç”¨ï¼‰
cookie = "0.18"      # ã‚»ã‚­ãƒ¥ã‚¢Cookieç®¡ç†
rand = "0.8"         # æš—å·å­¦çš„ã«å®‰å…¨ãªä¹±æ•°ç”Ÿæˆ
```

---

**è¦ä»¶å®šç¾©å®Œäº†æ—¥**: 2025-08-23  
**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: `/tdd-testcases` ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ´—ã„å‡ºã—ã‚’å®Ÿè¡Œ