# TASK-101: セッションベース認証実装 - TDDテストケース一覧

## 開発言語・フレームワーク

### 🟢 **青信号**: 既存実装との整合性から確実に決定

- **プログラミング言語**: Rust
  - **言語選択の理由**: プロジェクト全体がRustで実装されており、既存のLoco.rs 0.16.3 フレームワークとの整合性
  - **テストに適した機能**: 型安全性、コンパイル時チェック、パフォーマンス
- **テストフレームワーク**: Rust標準cargo test + serial_test, rstest, insta
  - **フレームワーク選択の理由**: TASK-004で既に使用実績があり、43テストケース全通過の実績
  - **テスト実行環境**: 既存データベース（PostgreSQL）と統合したテスト環境

## 1. 正常系テストケース（基本的な動作）

### TC-001: 正常ログイン処理
🟢 **青信号**: TASK-101完了条件「正しい認証情報でログイン成功」から直接抽出

- **テスト名**: 有効なメールアドレスとパスワードでのログイン成功
  - **何をテストするか**: LoginParamsによる正常なログイン処理フロー
  - **期待される動作**: セッション作成、Cookieセット、CSRFトークン生成が正常実行
- **入力値**: 
  ```rust
  LoginParams {
      email: "admin@example.com",
      password: "valid_password123"
  }
  ```
  - **入力データの意味**: 既存のテストユーザーを使用し、実運用での正常パターンを代表
- **期待される結果**: 
  ```rust
  SessionLoginResponse {
      success: true,
      user: UserInfo { /* 有効なユーザー情報 */ },
      csrf_token: "生成されたCSRFトークン"
  }
  ```
  - **期待結果の理由**: セッション方式への移行により、JWTではなくセッション+CSRF方式を採用
- **テストの目的**: 基本的なログイン機能の正常動作確認
  - **確認ポイント**: セッションテーブルへの正常なINSERT、Cookieの適切な設定、CSRFトークン生成

### TC-002: セッション作成とデータベース保存
🟢 **青信号**: 要件定義書のセッション管理仕様から直接抽出

- **テスト名**: ログイン成功時のセッション情報正常保存
  - **何をテストするか**: sessions::Model::create_session によるデータベースへの永続化
  - **期待される動作**: UUIDセッションID生成、有効期限設定、外部キー関係の正常設定
- **入力値**:
  ```rust
  SessionCreateParams {
      user_id: 1, // 既存テストユーザーID
      session_token: "暗号学的に安全な乱数生成トークン",
      expires_at: Local::now() + Duration::hours(24)
  }
  ```
  - **入力データの意味**: 24時間の有効期限設定による標準的なセッション作成パターン
- **期待される結果**: sessionsテーブルに正常にレコードが作成される
  - **期待結果の理由**: セッション管理の基盤となるデータ永続化の確実性確保
- **テストの目的**: セッション管理機能の基本動作確認
  - **確認ポイント**: UUID主キーの自動生成、外部キー制約の正常動作、タイムスタンプの適切な設定

### TC-003: セッション検証とミドルウェア通過
🟡 **黄信号**: 要件定義書のセッションミドルウェア仕様から推測

- **テスト名**: 有効なセッショントークンでの認証通過
  - **何をテストするか**: session_auth_middleware による正常な認証チェック
  - **期待される動作**: Cookieからトークン取得、データベース検証、ユーザー情報注入
- **入力値**: 
  ```rust
  // HTTPリクエストヘッダー
  Cookie: session_token=valid_session_token_12345
  ```
  - **入力データの意味**: ログイン済みユーザーからの後続リクエストを模擬
- **期待される結果**: リクエストコンテキストにユーザー情報が注入され、次の処理に継続
  - **期待結果の理由**: セッションベース認証の本質的な機能である認証状態の継続性確保
- **テストの目的**: セッションミドルウェアの正常動作確認
  - **確認ポイント**: セッション検索性能、last_accessed_at の自動更新、ユーザー情報の適切な注入

### TC-004: CSRF保護機能の正常動作
🟢 **青信号**: 要件定義書のCSRF保護仕様から直接抽出

- **テスト名**: 有効なCSRFトークンでの状態変更操作許可
  - **何をテストするか**: 状態変更操作時のCSRFトークン検証機能
  - **期待される動作**: CSRFトークン検証後の操作許可
- **入力値**:
  ```rust
  // POST リクエストボディ
  csrf_token: "session作成時に生成されたトークン"
  // その他の状態変更データ
  ```
  - **入力データの意味**: ログイン時に発行されたトークンによる正規リクエストを代表
- **期待される結果**: 状態変更操作が正常に実行される
  - **期待結果の理由**: CSRF攻撃防御の前提として、正規操作は阻害されない必要がある
- **テストの目的**: CSRF保護機能の正常動作確認
  - **確認ポイント**: トークン検証ロジック、ワンタイムトークンの適切な管理

### TC-005: ログアウト処理
🟡 **黄信号**: 要件定義書のログアウトフローから推測

- **テスト名**: ログアウト時のセッション削除とCookie無効化
  - **何をテストするか**: POST /api/auth/logout によるセッション終了処理
  - **期待される動作**: セッションレコード削除、Cookie無効化、適切なレスポンス
- **入力値**: 有効なセッションでのログアウトリクエスト
  - **入力データの意味**: ログイン済みユーザーからの明示的なログアウト操作
- **期待される結果**: セッションが削除され、Cookieが無効化される
  - **期待結果の理由**: セキュリティ観点からのセッション確実な終了
- **テストの目的**: セッション生涯管理の完全性確認
  - **確認ポイント**: データベースからのレコード削除、HttpOnly Cookie の適切な削除

## 2. 異常系テストケース（エラーハンドリング）

### TC-006: 不正な認証情報でのログイン拒否
🟢 **青信号**: TASK-101完了条件「不正な認証情報でログイン拒否」から直接抽出

- **テスト名**: 存在しないメールアドレスでのログイン試行拒否
  - **エラーケースの概要**: データベースに存在しないユーザーでのログイン試行
  - **エラー処理の重要性**: 不正アクセス防止とセキュリティログ記録
- **入力値**:
  ```rust
  LoginParams {
      email: "nonexistent@example.com",
      password: "any_password"
  }
  ```
  - **不正な理由**: usersテーブルに存在しないメールアドレス
  - **実際の発生シナリオ**: ブルートフォース攻撃、タイポ、退職したユーザーのアクセス試行
- **期待される結果**: HTTP 401 Unauthorized、適切なエラーメッセージ
  - **エラーメッセージの内容**: 「認証に失敗しました」（詳細情報を露呈しない）
  - **システムの安全性**: アカウント存在有無の情報漏洩防止
- **テストの目的**: 不正ログイン試行の適切な拒否確認
  - **品質保証の観点**: セキュリティ要件NFR-102への準拠確認

### TC-007: パスワード不一致でのログイン拒否
🟢 **青信号**: users::Model::verify_password 既存実装から抽出

- **テスト名**: 正しいメールアドレスだが間違ったパスワードでのログイン拒否
  - **エラーケースの概要**: ユーザーは存在するが認証情報が不正なケース
  - **エラー処理の重要性**: パスワード総当たり攻撃の防御
- **入力値**:
  ```rust
  LoginParams {
      email: "admin@example.com", // 存在するユーザー
      password: "wrong_password"   // 不正なパスワード
  }
  ```
  - **不正な理由**: bcrypt ハッシュ検証の失敗
  - **実際の発生シナリオ**: パスワード忘却、ソーシャルエンジニアリング攻撃
- **期待される結果**: HTTP 401 Unauthorized、セキュリティログ記録
  - **エラーメッセージの内容**: 「認証に失敗しました」（メール存在有無を露呈しない）
  - **システムの安全性**: ログイン試行の記録と分析可能性確保
- **テストの目的**: パスワード認証機能の堅牢性確認
  - **品質保証の観点**: ブルートフォース攻撃対策の有効性確認

### TC-008: 期限切れセッションでの認証失敗
🟡 **黄信号**: 要件定義書のEDGE-001から推測

- **テスト名**: expires_at を超過したセッションでの認証拒否
  - **エラーケースの概要**: 24時間の有効期限を超過したセッション使用
  - **エラー処理の重要性**: セッション生涯管理とセキュリティ確保
- **入力値**: 
  ```rust
  // 期限切れのセッションCookie
  Cookie: session_token=expired_session_token
  // データベース上のexpires_atが現在時刻より過去
  ```
  - **不正な理由**: セッションの時間的有効性失効
  - **実際の発生シナリオ**: 長時間放置後のアクセス、システム時刻設定ミス
- **期待される結果**: HTTP 401 Unauthorized、セッション自動削除
  - **エラーメッセージの内容**: 「セッションが期限切れです。再ログインしてください。」
  - **システムの安全性**: 期限切れセッションの自動クリーンアップ
- **テストの目的**: セッション有効期限管理の確実性確認
  - **品質保証の観点**: セッションハイジャック攻撃の時間的制限効果確認

### TC-009: 不正セッショントークンでの認証失敗
🟡 **黄信号**: 要件定義書のEDGE-002から推測

- **テスト名**: 存在しないセッショントークンでの認証拒否
  - **エラーケースの概要**: データベースに存在しないセッショントークン使用
  - **エラー処理の重要性**: セッショントークン偽造攻撃の防御
- **入力値**:
  ```rust
  Cookie: session_token=invalid_forged_token_12345
  ```
  - **不正な理由**: sessionsテーブルに存在しないトークン
  - **実際の発生シナリオ**: セッショントークン偽造、手動Cookieファイル編集
- **期待される結果**: HTTP 401 Unauthorized、セキュリティログ記録
  - **エラーメッセージの内容**: 「無効なセッションです。」
  - **システムの安全性**: 不正アクセス試行の監査ログ記録
- **テストの目的**: セッショントークン完全性検証の確実性確認
  - **品質保証の観点**: セッション偽造攻撃の検出・防御機能確認

### TC-010: CSRF攻撃の防御
🟢 **青信号**: TASK-101完了条件「CSRF攻撃が防御される」から直接抽出

- **テスト名**: CSRFトークン不一致での状態変更操作拒否
  - **エラーケースの概要**: 悪意のあるサイトからの状態変更リクエスト
  - **エラー処理の重要性**: OWASP Top 10 A01: Broken Access Control 対策
- **入力値**:
  ```rust
  // 不正なCSRFトークン
  csrf_token: "malicious_forged_token"
  ```
  - **不正な理由**: セッション作成時のトークンとの不一致
  - **実際の発生シナリオ**: 外部サイトから埋め込まれた悪意のあるフォーム送信
- **期待される結果**: HTTP 403 Forbidden、操作拒否
  - **エラーメッセージの内容**: 「CSRF検証に失敗しました。」
  - **システムの安全性**: 状態変更の確実な防止、攻撃試行ログ記録
- **テストの目的**: CSRF攻撃防御機能の有効性確認
  - **品質保証の観点**: Web セキュリティ脆弱性対策の実装確認

## 3. 境界値テストケース（最小値、最大値、null等）

### TC-011: セッション有効期限境界値テスト
🟡 **黄信号**: 要件定義書の24時間有効期限仕様から推測

- **テスト名**: セッション有効期限の境界（23:59:59 vs 24:00:00）
  - **境界値の意味**: 24時間有効期限の正確な境界での動作
  - **境界値での動作保証**: 1秒差での認証可否の確実性
- **入力値**:
  ```rust
  // ケース1: 23時間59分59秒経過（有効）
  expires_at: created_at + Duration::hours(24) - Duration::seconds(1)
  // ケース2: 24時間ちょうど経過（無効）
  expires_at: created_at + Duration::hours(24)
  ```
  - **境界値選択の根拠**: セッション管理仕様の24時間制限
  - **実際の使用場面**: 長時間作業するユーザーのセッション継続性
- **期待される結果**: 23:59:59では認証成功、24:00:00では認証失敗
  - **境界での正確性**: 時刻比較ロジックの秒単位精度確認
  - **一貫した動作**: expires_at の厳密な比較実装
- **テストの目的**: セッション有効期限管理の正確性確認
  - **堅牢性の確認**: 時刻境界での予測可能な動作保証

### TC-012: セッショントークン長の境界値テスト
🔴 **赤信号**: セキュリティベストプラクティスから推測

- **テスト名**: 最小・最大長のセッショントークンでの動作確認
  - **境界値の意味**: トークン長がセキュリティと性能に与える影響
  - **境界値での動作保証**: 極端な長さでのシステム安定性
- **入力値**:
  ```rust
  // 最小長（セキュリティ下限）
  session_token: "a".repeat(32) // 32文字
  // 最大長（データベース制限）
  session_token: "a".repeat(255) // VARCHAR(255)制限
  ```
  - **境界値選択の根拠**: 暗号学的強度とデータベース制約の両立
  - **実際の使用場面**: トークン生成ライブラリの設定ミス
- **期待される結果**: 両方のケースで正常なセッション管理動作
  - **境界での正確性**: データベースカラム制限内での確実な保存
  - **一貫した動作**: トークン長によらない検索・照合性能
- **テストの目的**: セッショントークン実装の堅牢性確認
  - **堅牢性の確認**: 極端なトークン長でのパフォーマンス劣化回避

### TC-013: 最大同時セッション数の境界値テスト
🟡 **黄信号**: 要件定義書のEDGE-003（5セッション上限）から推測

- **テスト名**: ユーザーあたり最大5セッション制限の境界動作
  - **境界値の意味**: セッション上限管理による古いセッション自動削除
  - **境界値での動作保証**: 5個目 vs 6個目セッション作成の動作差
- **入力値**:
  ```rust
  // 同一ユーザーでの連続ログイン
  user_id: 1
  // 5回のログイン（上限内）
  // 6回目のログイン（上限超過）
  ```
  - **境界値選択の根拠**: 要件定義書のセッション管理制限仕様
  - **実際の使用場面**: 複数デバイス・ブラウザでの同時ログイン
- **期待される結果**: 6回目ログイン時に最古セッション自動削除
  - **境界での正確性**: 5セッション制限の厳密な実施
  - **一貫した動作**: FIFO（First In, First Out）での古いセッション削除
- **テストの目的**: セッション上限管理機能の確実性確認
  - **堅牢性の確認**: メモリリーク防止とセキュリティ管理の両立

### TC-014: 空・null値での境界テスト
🟢 **青信号**: 入力検証の基本パターンから確実に抽出

- **テスト名**: 空文字列・null値での入力検証確認
  - **境界値の意味**: 必須フィールドの入力検証境界
  - **境界値での動作保証**: 不正入力の確実な検出と拒否
- **入力値**:
  ```rust
  // 空のメールアドレス
  LoginParams { email: "", password: "valid_pass" }
  // 空のパスワード  
  LoginParams { email: "valid@example.com", password: "" }
  // 空のセッショントークン
  Cookie: session_token=""
  ```
  - **境界値選択の根拠**: フォーム入力の最小値制約
  - **実際の使用場面**: JavaScript無効化、不正フォーム送信、API直接呼び出し
- **期待される結果**: HTTP 400 Bad Request、バリデーションエラー
  - **境界での正確性**: 必須項目チェックの確実な実行
  - **一貫した動作**: 空値での処理継続防止
- **テストの目的**: 入力検証機能の完全性確認
  - **堅牢性の確認**: 不正入力による予期せぬエラー防止

## 実装ファイル構成

### テストファイル構造
```
tests/
├── models/
│   └── sessions.rs           # セッション管理ロジックテスト
├── requests/
│   └── auth.rs              # 認証エンドポイント統合テスト
└── middleware/
    └── session_auth.rs      # セッションミドルウェアテスト
```

### テスト実行コマンド
🟢 **青信号**: 既存TASK-004の実績から確実

```bash
# 全テスト実行
cargo test

# セッション関連テストのみ
cargo test session

# データベース統合テスト（シリアル実行）
cargo test --test auth --features testing -- --test-threads=1
```

---

**テストケース一覧作成完了日**: 2025-08-23  
**テストケース総数**: 14ケース（正常系5、異常系5、境界値4）  
**次のステップ**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します