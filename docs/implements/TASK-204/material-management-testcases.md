# TASK-204: 教材管理機能 - TDDテストケース洗い出し

**タスクID**: TASK-204  
**作成日**: 2025-08-24  
**フェーズ**: TDD Test Cases Definition  
**実装対象**: 教材管理機能（Controller層・View層）

## 事前準備完了

✅ **TDD関連ファイル読み込み完了**
- 要件定義書確認：Controller・View層に焦点を当てた8エンドポイント仕様
- 既存実装パターン確認：auth.rs（JSON API）、dashboard.rs（簡易実装）
- 既存テストパターン確認：request::<App, _, _>マクロ、insta snapshot、serial_test
- 既存Model層確認：materials.rs（完全実装済み、7テスト全通過）

## 開発言語・フレームワーク

🟢 **プログラミング言語**: Rust
- **言語選択の理由**: 既存Loco.rsプロジェクトとの統合、型安全性、パフォーマンス
- **テストに適した機能**: 強力なマクロシステム、Result型による安全なエラーハンドリング

🟢 **テストフレームワーク**: 既存パターン踏襲
- **主要フレームワーク**: tokio::test（非同期テスト）、serial_test（DB競合回避）、insta（スナップショットテスト）
- **Loco.rsテストユーティリティ**: request::<App, _, _>、boot_test::<App>
- **フレームワーク選択の理由**: 既存実装との一貫性、Loco.rs標準パターンの活用
- **テスト実行環境**: PostgreSQL開発DB環境（DATABASE_URL設定済み）

## 1. 正常系テストケース（Controller層HTTPエンドポイント）

### 1.1 教材一覧表示テスト
- **テスト名**: `test_教材一覧画面表示成功`
  - **何をテストするか**: GET /materials エンドポイントの正常レスポンス確認
  - **期待される動作**: 認証済みユーザーが教材一覧データを正常取得できる
- **入力値**: 有効なセッショントークン、trainer権限ユーザー
  - **入力データの意味**: 研修担当者として教材管理画面にアクセスする実際の使用シナリオ
- **期待される結果**: HTTP 200、HTMLレスポンス（または教材リストJSON）
  - **期待結果の理由**: 認証済み・適切な権限ユーザーは教材情報を閲覧できる業務要件
- **テストの目的**: Controller層の基本的なGETリクエスト処理確認
  - **確認ポイント**: レスポンスステータス、コンテンツタイプ、データ構造
- 🟢 既存auth.rs実装パターンとLoco.rs標準機能に基づく確実なテストケース

### 1.2 教材作成フォーム表示テスト
- **テスト名**: `test_教材作成フォーム表示成功`
  - **何をテストするか**: GET /materials/new エンドポイントのフォーム表示
  - **期待される動作**: 教材作成フォームが適切に表示される
- **入力値**: trainer権限ユーザーセッション
  - **入力データの意味**: 教材作成権限を持つユーザーの新規作成要求
- **期待される結果**: HTTP 200、フォームテンプレート表示
  - **期待結果の理由**: 権限ユーザーが新規教材を登録できる機能要件
- **テストの目的**: View層テンプレートレンダリング確認
  - **確認ポイント**: フォームフィールドの存在、CSRF トークン設定
- 🟢 requirements.mdのフォーム仕様に基づく確実なテストケース

### 1.3 教材作成処理テスト
- **テスト名**: `test_教材作成処理成功`
  - **何をテストするか**: POST /materials エンドポイントでの教材作成
  - **期待される動作**: 有効なフォームデータで教材がデータベースに作成される
- **入力値**: 有効な教材データ（title, url, description, recommendation_level）
  - **入力データの意味**: 実際のユーザーが入力する標準的な教材情報
- **期待される結果**: HTTP 302（リダイレクト）、データベースに教材レコード保存
  - **期待結果の理由**: 作成成功後は一覧画面または詳細画面にリダイレクトする一般的なWebパターン
- **テストの目的**: Controller→Model層統合、CRUD操作の正常動作確認
  - **確認ポイント**: データベース保存確認、ドメイン自動抽出、created_by設定
- 🟢 既存materials.rsモデルとの統合により確実性が保証されたテストケース

### 1.4 教材詳細表示テスト
- **テスト名**: `test_教材詳細表示成功`
  - **何をテストするか**: GET /materials/{id} エンドポイントでの詳細データ表示
  - **期待される動作**: 指定したIDの教材詳細情報が表示される
- **入力値**: 既存教材ID、認証済みセッション
  - **入力データの意味**: 教材閲覧権限を持つユーザーによる詳細確認要求
- **期待される結果**: HTTP 200、教材詳細情報表示（HTML）
  - **期待結果の理由**: 登録済み教材の詳細確認は基本的な業務要件
- **テストの目的**: パスパラメータ処理、Model層データ取得統合確認
  - **確認ポイント**: URLパラメータ解析、教材データの完全性、権限制御
- 🟢 既存auth.rsのパスパラメータ処理パターンに基づく確実なテストケース

### 1.5 教材更新処理テスト  
- **テスト名**: `test_教材更新処理成功`
  - **何をテストするか**: POST /materials/{id} エンドポイントでの教材更新
  - **期待される動作**: 教材情報が正しく更新され、データベースに反映される
- **入力値**: 既存教材ID、更新データ、trainer権限セッション
  - **入力データの意味**: 教材情報の修正・改善を行う実際の業務シナリオ
- **期待される結果**: HTTP 302、データベースの教材レコード更新
  - **期待結果の理由**: 更新成功後の画面遷移による操作完了フィードバック
- **テストの目的**: 更新処理の正常動作、楽観的排他制御確認
  - **確認ポイント**: updated_at自動更新、変更データの反映確認
- 🟢 既存materials.rsの更新機能とMVCパターンによる確実なテストケース

## 2. 異常系テストケース（エラーハンドリング）

### 2.1 未認証アクセス拒否テスト
- **テスト名**: `test_未認証ユーザー教材アクセス拒否`
  - **エラーケースの概要**: セッションなしでの教材管理画面アクセス
  - **エラー処理の重要性**: セキュリティ基本要件、不正アクセス防止
- **入力値**: セッショントークンなし、各種教材エンドポイント
  - **不正な理由**: 教材管理機能は認証必須の業務機能
  - **実際の発生シナリオ**: セッション期限切れ、直接URL入力での不正アクセス試行
- **期待される結果**: HTTP 401 Unauthorized、ログイン画面リダイレクト
  - **エラーメッセージの内容**: 認証が必要である旨の適切なメッセージ
  - **システムの安全性**: 機密情報の漏洩防止、適切な認証フロー誘導
- **テストの目的**: 認証middleware統合の確認
  - **品質保証の観点**: セキュリティ要件の確実な実装確認
- 🟢 既存RBAC実装と認証フローに基づく確実なエラーハンドリング

### 2.2 権限不足アクセス拒否テスト  
- **テスト名**: `test_instructor権限教材作成拒否`
  - **エラーケースの概要**: 読み取り専用権限での作成・更新・削除操作
  - **エラー処理の重要性**: RBAC統合によるビジネスルール実装
- **入力値**: instructor権限セッション、POST /materials リクエスト
  - **不正な理由**: instructor権限は教材閲覧のみ、CRUD操作権限なし
  - **実際の発生シナリオ**: 権限昇格試行、UI制限の回避試行
- **期待される結果**: HTTP 403 Forbidden、権限不足エラーメッセージ  
  - **エラーメッセージの内容**: 「操作権限がありません」等の明確なメッセージ
  - **システムの安全性**: ビジネスルール違反の確実な防止
- **テストの目的**: RBAC middleware統合の権限チェック確認
  - **品質保証の観点**: ビジネスルール実装の確実性確認
- 🟢 既存RBAC実装と要件定義の権限マトリックスに基づく確実なテスト

### 2.3 無効データバリデーションエラーテスト
- **テスト名**: `test_無効教材データ作成バリデーションエラー`
  - **エラーケースの概要**: フォーム入力値のサーバーサイドバリデーション失敗
  - **エラー処理の重要性**: データ整合性保証、不正データ防止
- **入力値**: 空のタイトル、無効URL、範囲外推奨レベル等
  - **不正な理由**: 業務要件とデータベース制約に違反する不正データ
  - **実際の発生シナリオ**: JavaScriptクライアントバリデーション回避、APIダイレクトアクセス
- **期待される結果**: HTTP 422 Unprocessable Entity、フィールド別エラーメッセージ
  - **エラーメッセージの内容**: 「タイトルは必須です」等の具体的な修正指針
  - **システムの安全性**: 不正データによるデータベース破損防止
- **テストの目的**: サーバーサイドバリデーション統合確認  
  - **品質保証の観点**: 既存materials.rsバリデーションとの統合確認
- 🟢 既存materials.rs Validatorとの統合により確実性が保証されたテスト

### 2.4 存在しない教材アクセスエラーテスト
- **テスト名**: `test_存在しない教材ID指定404エラー`
  - **エラーケースの概要**: 無効なID指定での詳細・編集・削除操作
  - **エラー処理の重要性**: リソース存在確認による安全なアクセス制御
- **入力値**: 存在しないUUID、削除済み教材ID
  - **不正な理由**: データベースに存在しないリソースへの操作要求
  - **実際の発生シナリオ**: URL改ざん、古いブックマークアクセス
- **期待される結果**: HTTP 404 Not Found、適切な404エラーページ
  - **エラーメッセージの内容**: 「指定された教材が見つかりません」  
  - **システムの安全性**: システム内部情報の漏洩防止
- **テストの目的**: リソース存在確認処理の妥当性検証
  - **品質保証の観点**: エラーハンドリングの統一性確認
- 🟢 既存materials.rsのfind_by_idメソッドとエラーハンドリングに基づく確実なテスト

## 3. 境界値テストケース（入力値の限界）

### 3.1 タイトル長制限境界値テスト
- **テスト名**: `test_教材タイトル文字数境界値`
  - **境界値の意味**: データベースVARCHAR(255)制約とバリデーション仕様の境界
  - **境界値での動作保証**: 文字数制限での一貫したバリデーション動作
- **入力値**: 1文字、255文字、256文字のタイトル
  - **境界値選択の根拠**: materials.rsとデータベーススキーマの制約定義
  - **実際の使用場面**: 極端に短い・長いタイトルでの教材登録試行
- **期待される結果**: 1-255文字で成功、256文字でバリデーションエラー
  - **境界での正確性**: 文字数カウントとエラーメッセージの正確性
  - **一貫した動作**: フロントエンド・バックエンドバリデーションの一致
- **テストの目的**: 文字数制限の境界条件確認
  - **堅牢性の確認**: 極端な入力値での安定動作確認
- 🟢 既存materials.rs Validator定義に基づく確実な境界値テスト

### 3.2 推奨レベル境界値テスト
- **テスト名**: `test_推奨レベル1-5境界値`
  - **境界値の意味**: 業務ルール（1-5評価）とデータベースCHECK制約の境界  
  - **境界値での動作保証**: 評価範囲外での確実なエラー検出
- **入力値**: 0, 1, 5, 6の推奨レベル値
  - **境界値選択の根拠**: 業務要件の評価範囲と既存テスト結果
  - **実際の使用場面**: 不正なAPI呼び出し、フォーム改ざんでの範囲外値設定
- **期待される結果**: 1,5で成功、0,6でバリデーションエラー
  - **境界での正確性**: CHECK制約とアプリケーションバリデーションの一致
  - **一貫した動作**: データベース・アプリケーション層での統一エラー
- **テストの目的**: 業務ルール境界の確実な実装確認
  - **堅牢性の確認**: 不正データでの安全な処理確認
- 🟢 既存materials.rsテスト結果とデータベース制約に基づく確実なテスト

### 3.3 URL長制限境界値テスト  
- **テスト名**: `test_教材URL長制限境界値`
  - **境界値の意味**: RFC標準とセキュリティを考慮したURL長制限
  - **境界値での動作保証**: 極端に長いURLでのセキュリティ確保
- **入力値**: 2048文字、2049文字のURL
  - **境界値選択の根拠**: materials.rsで定義されたMAX_URL_LENGTH定数
  - **実際の使用場面**: 長大なクエリパラメータ付きURL、DoS攻撃試行
- **期待される結果**: 2048文字まで成功、2049文字でバリデーションエラー
  - **境界での正確性**: URL解析処理の安全性確保
  - **一貫した動作**: セキュリティ制限の確実な実装
- **テストの目的**: セキュリティ制限の境界確認
  - **堅牢性の確認**: DoS攻撃等への耐性確認
- 🟢 既存materials.rs定数定義とセキュリティ要件に基づく確実なテスト

## 4. HTMX機能テストケース（必要最小限）

### 4.1 検索結果部分更新テスト
- **テスト名**: `test_教材検索結果HTMX部分更新`
  - **何をテストするか**: GET /materials/search-results でのHTMX部分更新
  - **期待される動作**: 検索条件に応じた教材リストの部分HTML生成
- **入力値**: 検索クエリ、HX-Request: true ヘッダー
  - **入力データの意味**: HTMX由来のリクエストによる部分更新要求
- **期待される結果**: HTTP 200、部分HTMLレスポンス（フルページでない）
  - **期待結果の理由**: シームレスなUI更新によるUX向上
- **テストの目的**: HTMX統合の基本動作確認
  - **確認ポイント**: レスポンスヘッダー、部分テンプレート使用確認
- 🟡 architecture.md のHTMXガイドライン「必要最小限利用」に基づくテスト

### 4.2 フォームバリデーション部分更新テスト
- **テスト名**: `test_教材フォームリアルタイムバリデーション`
  - **何をテストするか**: POST /materials/validate でのライブバリデーション
  - **期待される動作**: フォーム入力値の即座のバリデーション結果表示
- **入力値**: 部分フォームデータ、HTMX リクエストヘッダー
  - **入力データの意味**: ユーザー入力途中でのリアルタイム検証要求
- **期待される結果**: バリデーション結果の部分HTMLレスポンス
  - **期待結果の理由**: 入力完了前のエラー検出によるUX改善
- **テストの目的**: HTMXバリデーション統合の確認
  - **確認ポイント**: 部分バリデーション、既存Validator統合
- 🟡 要件定義のHTMX機能仕様に基づくテストケース

## 5. 統合テストケース（Model層統合）

### 5.1 教材CRUD統合テスト
- **テスト名**: `test_教材管理Controller・Model層統合`
  - **何をテストするか**: Controller→Model→Database の完全なデータフロー
  - **期待される動作**: HTTPリクエストからデータベース操作まで一貫した処理
- **入力値**: HTTPリクエストシーケンス（作成→取得→更新→削除）
  - **入力データの意味**: 実際のユーザー操作フローのエンドツーエンド確認
- **期待される結果**: 各段階でのHTTPレスポンスとデータベース状態の整合性
  - **期待結果の理由**: 実際の業務フローでの動作保証
- **テストの目的**: Controller・Model層結合の確実な動作確認
  - **確認ポイント**: データ変換、エラー伝播、トランザクション整合性
- 🟢 既存materials.rsの確実な動作と統合による信頼性の高いテスト

### 5.2 セッション認証・RBAC統合テスト
- **テスト名**: `test_教材管理権限制御統合`
  - **何をテストするか**: 認証・認可→Controller→Model の権限制御チェーン
  - **期待される動作**: 各権限レベルでの適切なアクセス制御動作
- **入力値**: admin/trainer/instructor権限でのCRUD操作要求
  - **入力データの意味**: 権限マトリックスに基づく各種権限での操作試行
- **期待される結果**: 権限に応じた許可・拒否の正確な判定
  - **期待結果の理由**: ビジネスルール要件の確実な実装確認
- **テストの目的**: 認証・認可システム統合の確認
  - **確認ポイント**: 権限判定正確性、エラーレスポンス適切性
- 🟢 既存RBAC実装との統合により確実性が保証されたテスト

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント
```rust
// 【テスト目的】: [このテストで何を確認するかを日本語で明記]
// 【テスト内容】: [具体的にどのような処理をテストするかを説明]
// 【期待される動作】: [正常に動作した場合の結果を説明]
// 🟢🟡🔴 この内容の信頼性レベルを記載
```

### Given（準備フェーズ）のコメント
```rust
// 【テストデータ準備】: [なぜこのデータを用意するかの理由]
// 【初期条件設定】: [テスト実行前の状態を説明]
// 【前提条件確認】: [テスト実行に必要な前提条件を明記]
```

### When（実行フェーズ）のコメント
```rust
// 【実際の処理実行】: [どの機能/メソッドを呼び出すかを説明]
// 【処理内容】: [実行される処理の内容を日本語で説明]
// 【実行タイミング】: [なぜこのタイミングで実行するかを説明]
```

### Then（検証フェーズ）のコメント
```rust
// 【結果検証】: [何を検証するかを具体的に説明]
// 【期待値確認】: [期待される結果とその理由を説明]
// 【品質保証】: [この検証がシステム品質にどう貢献するかを説明]
```

### 各assertステートメントのコメント
```rust
// 【検証項目】: [この検証で確認している具体的な項目]
// 🟢🟡🔴 この内容の信頼性レベルを記載
assert_eq!(response.status_code(), 200); // 【確認内容】: HTTPレスポンスが正常ステータスを返すことを確認
```

## テストケースサマリー

### 分類別カバレッジ
- **正常系テストケース**: 5件（基本CRUD操作網羅）
- **異常系テストケース**: 4件（セキュリティ・バリデーション網羅）
- **境界値テストケース**: 3件（入力制限境界網羅）  
- **HTMX機能テストケース**: 2件（必要最小限機能）
- **統合テストケース**: 2件（層間統合確認）
- **合計**: 16テストケース

### 品質保証カバレッジ
- **セキュリティ**: 認証・認可・入力検証をカバー
- **機能性**: 全CRUD操作とHTMX機能をカバー  
- **信頼性**: 境界値・エラーハンドリングをカバー
- **統合性**: Controller-Model層連携をカバー
- **保守性**: 既存パターン踏襲によるメンテナンス性確保

---

**テストケース品質判定**: ✅ 高品質
- **テストケース分類**: 正常系・異常系・境界値が網羅されている
- **期待値定義**: 各テストケースの期待値が明確
- **技術選択**: プログラミング言語・テストフレームワークが確定
- **実装可能性**: 現在の技術スタックで実現可能

**次のお勧めステップ**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。