# TASK-004: ORM設定とモデル実装 - テストケース仕様書

## テスト実行環境

**プログラミング言語**: Rust
**テストフレームワーク**: Rust標準テスト + rstest + insta + serial_test  
**データベース**: PostgreSQL（training_management_test）
**実装日**: 2025-08-17

## 1. 正常系テストケース（基本的な動作）

### 1.1 Companies エンティティ CRUD操作

#### 企業情報の正常作成テスト
- **何をテストするか**: Companiesモデルの正常な作成処理とデータベース保存
- **期待される動作**: 有効な企業データが正常にデータベースに保存される
- **入力値**: `{ name: "テスト株式会社", contact_person: "田中太郎", contact_email: "tanaka@test.co.jp", chat_link: Some("https://chat.test.co.jp") }`
- **期待される結果**: UUID主キーが自動生成され、created_at/updated_atが設定された企業レコード
- **テストの目的**: 企業エンティティの基本的な作成機能の動作確認
- 🟢 **信頼性レベル**: database-schema.sqlと既存Usersテストパターンに基づく

#### 企業情報の検索テスト
- **何をテストするか**: 企業名による検索機能とIDによる直接検索
- **期待される動作**: 条件に一致する企業情報が正確に取得される
- **入力値**: `name: "テスト株式会社"` または `id: [UUID]`
- **期待される結果**: 該当する企業レコード、存在しない場合はNone
- **テストの目的**: 検索機能の動作確認とインデックス活用
- 🟢 **信頼性レベル**: database-schema.sqlのインデックス定義に基づく

#### 企業情報の更新テスト
- **何をテストするか**: 既存企業情報の部分更新と全項目更新
- **期待される動作**: 指定フィールドのみが更新され、updated_atが自動更新される
- **入力値**: `{ contact_person: "佐藤花子", contact_email: "sato@test.co.jp" }`
- **期待される結果**: 指定フィールドが更新され、updated_atタイムスタンプが更新される
- **テストの目的**: 更新機能とトリガー動作の確認
- 🟢 **信頼性レベル**: database-schema.sqlのupdated_atトリガーに基づく

### 1.2 Students-Companies リレーション

#### 受講者-企業間の1対多リレーションテスト
- **何をテストするか**: StudentsとCompaniesの外部キー関係とリレーション検索
- **期待される動作**: 企業に所属する受講者の正常な作成と検索ができる
- **入力値**: `{ name: "受講者太郎", email: "student@test.co.jp", company_id: [企業UUID], role_type: "student", organization: "開発部" }`
- **期待される結果**: 外部キー制約が正常に機能し、企業情報と紐付いた受講者データ
- **テストの目的**: エンティティ間のリレーション機能の確認
- 🟢 **信頼性レベル**: database-schema.sqlの外部キー定義に基づく

#### 企業所属受講者一覧取得テスト
- **何をテストするか**: 特定企業に所属する全受講者の取得
- **期待される動作**: 企業IDから所属受講者のリストが正確に取得される
- **入力値**: `company_id: [企業UUID]`
- **期待される結果**: 該当企業の受講者リスト（ページネーション対応）
- **テストの目的**: 1対多リレーションの検索機能確認
- 🟢 **信頼性レベル**: database-schema.sqlのリレーション定義に基づく

### 1.3 Training-Material 多対多リレーション

#### 研修コース-教材間の多対多リレーションテスト
- **何をテストするか**: TrainingMaterialsを介した多対多リレーションの作成と検索
- **期待される動作**: 研修コースに複数の教材を順序付きで紐付けできる
- **入力値**: `{ training_id: [研修UUID], material_id: [教材UUID], period_days: 7, order_index: 1 }`
- **期待される結果**: 研修コースから教材リストが順序通りに取得できる
- **テストの目的**: 多対多リレーションと順序管理の確認
- 🟢 **信頼性レベル**: database-schema.sqlの一意制約定義に基づく

#### 研修コース教材順序管理テスト
- **何をテストするか**: order_indexによる教材の順序制御
- **期待される動作**: 教材が指定された順序で取得され、順序変更が可能
- **入力値**: 複数教材のorder_index値（1, 2, 3...）
- **期待される結果**: order_index昇順での教材リスト取得
- **テストの目的**: ビジネスロジックレベルの順序管理確認
- 🟢 **信頼性レベル**: database-schema.sqlの一意制約定義に基づく

### 1.4 バリデーション機能

#### メールアドレス形式バリデーションテスト
- **何をテストするか**: Companies、Students、UsersのemailフィールドのURL形式チェック
- **期待される動作**: 正しいメール形式の場合に保存が成功する
- **入力値**: `"valid.email@example.com"`
- **期待される結果**: バリデーション成功、正常にデータベース保存
- **テストの目的**: フィールドレベルバリデーションの動作確認
- 🟢 **信頼性レベル**: 既存users.rsのバリデーション実装に基づく

#### 日付制約バリデーションテスト
- **何をテストするか**: Projects.start_date <= end_dateの制約チェック
- **期待される動作**: 正しい日付関係の場合に保存が成功する
- **入力値**: `{ start_date: "2025-01-01", end_date: "2025-01-31" }`
- **期待される結果**: CHECK制約クリア、正常にデータベース保存
- **テストの目的**: ビジネスルールレベルのバリデーション確認
- 🟢 **信頼性レベル**: database-schema.sqlのCHECK制約に基づく

## 2. 異常系テストケース（エラーハンドリング）

### 2.1 外部キー制約違反

#### 企業削除時の受講者存在チェックテスト
- **エラーケースの概要**: 受講者が存在する企業を削除しようとした際の制約違反
- **エラー処理の重要性**: データ整合性を保ち、孤立レコードの発生を防ぐ
- **入力値**: 受講者が紐付いている企業のID
- **期待される結果**: `DbErr::ForeignKeyConstraintViolation` エラー
- **テストの目的**: 外部キー制約による参照整合性の確認
- 🟢 **信頼性レベル**: database-schema.sqlのON DELETE RESTRICT制約に基づく

#### 存在しない企業IDでの受講者作成テスト
- **エラーケースの概要**: 無効な企業IDを指定した受講者登録の失敗
- **エラー処理の重要性**: データ整合性を保ち、無効な参照の防止
- **入力値**: `company_id: "00000000-0000-0000-0000-000000000000"`
- **期待される結果**: `DbErr::ForeignKeyConstraintViolation` エラー
- **テストの目的**: 外部キー参照の妥当性確認
- 🟢 **信頼性レベル**: database-schema.sqlの外部キー制約に基づく

### 2.2 一意制約違反

#### 同一企業内での受講者メール重複テスト
- **エラーケースの概要**: 同じ企業内で同じメールアドレスの受講者を登録する異常
- **エラー処理の重要性**: 企業内での受講者の一意性を保証し、混乱を防ぐ
- **入力値**: 既存受講者と同じcompany_id + emailの組み合わせ
- **期待される結果**: `DbErr::RecordNotInserted` または一意制約違反エラー
- **テストの目的**: ビジネスルールレベルの制約確認
- 🟢 **信頼性レベル**: database-schema.sqlのUNIQUE制約定義に基づく

#### 研修コース内での教材順序重複テスト
- **エラーケースの概要**: 同一研修コース内で同じorder_indexを持つ教材の登録
- **エラー処理の重要性**: 教材の学習順序の整合性を保つ
- **入力値**: 同じtraining_id + order_indexの組み合わせ
- **期待される結果**: 一意制約違反エラー
- **テストの目的**: 順序管理ロジックの制約確認
- 🟢 **信頼性レベル**: database-schema.sqlのUNIQUE制約定義に基づく

### 2.3 バリデーション失敗

#### 不正なメールアドレス形式エラーテスト
- **エラーケースの概要**: メールアドレス形式でない文字列での登録試行
- **エラー処理の重要性**: データ品質を保ち、後続の通信処理エラーを防ぐ
- **入力値**: `"invalid-email-format"`
- **期待される結果**: `ModelError::ValidationError` with email field error
- **テストの目的**: 入力データの品質管理機能確認
- 🟢 **信頼性レベル**: 既存users.rsのemailバリデーション実装に基づく

#### 必須フィールド未入力エラーテスト
- **エラーケースの概要**: NOT NULL制約フィールドの未入力
- **エラー処理の重要性**: 必須データの欠損を防ぎ、業務継続性を確保
- **入力値**: `{ name: None, contact_person: "田中太郎", contact_email: "tanaka@test.co.jp" }`
- **期待される結果**: NOT NULL制約違反エラー
- **テストの目的**: 必須項目チェックの確認
- 🟢 **信頼性レベル**: database-schema.sqlのNOT NULL制約に基づく

## 3. 境界値テストケース（最小値、最大値、null等）

### 3.1 文字列長の境界値

#### 企業名最大長境界値テスト
- **境界値の意味**: VARCHAR(255)制約の上限での動作確認
- **境界値での動作保証**: 制限内では正常保存、制限超過では適切なエラー
- **入力値**: 255文字ちょうど/256文字の企業名
- **期待される結果**: 255文字=成功、256文字=失敗
- **テストの目的**: データベーススキーマ制約の確認
- 🟢 **信頼性レベル**: database-schema.sqlのVARCHAR制約に基づく

#### 説明フィールドTEXT型制限テスト
- **境界値の意味**: TEXT型フィールドの大容量データ処理確認
- **境界値での動作保証**: 大容量テキストでもパフォーマンス劣化なし
- **入力値**: 10KB、100KB、1MBのテキストデータ
- **期待される結果**: 全サイズで正常保存、適切なレスポンス時間
- **テストの目的**: 大容量データ処理能力の確認
- 🟡 **信頼性レベル**: 一般的なTEXT型制限から推測

### 3.2 数値境界値

#### 推奨度レベル境界値テスト
- **境界値の意味**: CHECK制約(1-5)の境界での動作確認
- **境界値での動作保証**: 有効範囲内では保存成功、範囲外では制約エラー
- **入力値**: `recommendation_level: 0, 1, 5, 6`
- **期待される結果**: 1,5=成功、0,6=CHECK制約違反エラー
- **テストの目的**: 数値制約の境界条件確認
- 🟢 **信頼性レベル**: database-schema.sqlのCHECK制約定義に基づく

#### 研修期間日数境界値テスト
- **境界値の意味**: period_days > 0 制約の境界値確認
- **境界値での動作保証**: 正の整数では成功、0以下では制約エラー
- **入力値**: `period_days: 0, 1, 365, 366`
- **期待される結果**: 1,365,366=成功、0=CHECK制約違反エラー
- **テストの目的**: 正の整数制約の確認
- 🟢 **信頼性レベル**: database-schema.sqlのCHECK制約に基づく

### 3.3 NULL値扱い

#### オプショナルフィールドNULL値テスト
- **境界値の意味**: chat_linkなどの任意フィールドでのNULL許可確認
- **境界値での動作保証**: NULLで正常保存、NOT NULLフィールドでエラー
- **入力値**: `chat_link: None` vs `name: None`
- **期待される結果**: chat_link=成功、name=NOT NULL制約エラー
- **テストの目的**: NULL制約の正確な実装確認
- 🟢 **信頼性レベル**: database-schema.sqlのNOT NULL制約に基づく

#### 外部キーのNULL値許可テスト
- **境界値の意味**: trainings.company_idなどの任意外部キーのNULL処理
- **境界値での動作保証**: NULLで正常保存、参照時は適切に除外
- **入力値**: `company_id: None` (公開研修の場合)
- **期待される結果**: NULL保存成功、検索時は適切にフィルタリング
- **テストの目的**: 任意参照関係の正確な実装確認
- 🟢 **信頼性レベル**: database-schema.sqlの外部キー定義に基づく

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント
```rust
// 【テスト目的】: 企業エンティティの基本CRUD操作の動作確認
// 【テスト内容】: 正常な企業データでの作成・検索・更新・削除処理
// 【期待される動作】: 全CRUD操作が正常に完了し、データ整合性が保たれる
// 🟢 database-schema.sqlのテーブル定義に基づく確実なテストケース
```

### Given（準備フェーズ）のコメント
```rust
// 【テストデータ準備】: 実際の企業登録で使用される標準的なデータ形式
// 【初期条件設定】: データベーステーブルが空の状態から開始
// 【前提条件確認】: 企業テーブルの制約とインデックスが正常に設定済み
```

### When（実行フェーズ）のコメント
```rust
// 【実際の処理実行】: Company::create()メソッドによる企業データ作成
// 【処理内容】: ActiveModelを使用したSeaORM経由でのデータベース保存
// 【実行タイミング】: トランザクション内での一連のCRUD操作実行
```

### Then（検証フェーズ）のコメント
```rust
// 【結果検証】: 作成された企業データの各フィールド値とタイムスタンプ確認
// 【期待値確認】: UUID主キー生成、created_at/updated_at自動設定の検証
// 【品質保証】: データベース制約とビジネスルールの整合性確認
```

## 実装優先度

### Phase 1: 基本CRUD操作テスト（優先度: 高）
- 全エンティティの作成・検索・更新・削除テスト
- 基本的なバリデーション機能テスト

### Phase 2: リレーション機能テスト（優先度: 高）
- 1対多、多対多リレーションテスト
- 外部キー制約動作テスト

### Phase 3: エラーハンドリングテスト（優先度: 中）
- 制約違反エラーテスト
- バリデーション失敗テスト

### Phase 4: 境界値・パフォーマンステスト（優先度: 中）
- 文字列長・数値範囲の境界値テスト
- 大容量データ処理テスト

### Phase 5: 統合テスト（優先度: 中）
- 複数エンティティを跨いだ複合操作テスト
- トランザクション動作テスト

## 品質基準

- **テストカバレッジ**: 80%以上
- **テスト実行時間**: 全テスト30秒以内
- **データベース状態**: 各テスト後の完全クリーンアップ
- **エラーメッセージ**: ユーザーフレンドリーな日本語メッセージ