# TASK-102: 役割ベースアクセス制御（RBAC）- TDDテストケース定義書

**作成日**: 2025-08-23
**対象機能**: 役割ベースアクセス制御（RBAC）システム
**総テストケース数**: 12個

---

## 技術環境

### プログラミング言語・フレームワーク
- 🟢 **プログラミング言語**: Rust
  - **言語選択の理由**: 既存システム（TASK-101）との一貫性、型安全性によるセキュリティ強化
  - **テストに適した機能**: 強力な型システム、コンパイル時エラー検出、メモリ安全性
- 🟢 **テストフレームワーク**: Rust標準テスト + tokio::test + serial_test
  - **フレームワーク選択の理由**: TASK-101で実績のある構成、データベーステストに対応
  - **テスト実行環境**: PostgreSQL統合テスト、並列実行制御（serial_test）

---

## 1. 正常系テストケース（4個）

### TC-001: 管理者による全機能アクセス許可
- **テスト名**: 管理者による全機能アクセス許可
  - **何をテストするか**: adminユーザーが全ての保護されたリソースにアクセス可能であることを確認
  - **期待される動作**: 管理者権限による無制限アクセスの実現
- **入力値**: `UserRole::Admin`、全権限が必要なエンドポイント（`/api/users`、`/api/admin/*`）
  - **入力データの意味**: 最高権限ユーザーによる管理機能への正当なアクセス要求
- **期待される結果**: `AuthorizationResult { allowed: true, reason: None }`
  - **期待結果の理由**: 管理者は全機能への無制限アクセス権限を持つため
- **テストの目的**: 管理者権限の完全性確認
  - **確認ポイント**: 権限階層の最上位機能が正常動作すること
- 🟢 **信頼性レベル**: 要件定義書から直接抽出した確実な仕様

### TC-002: 研修担当者による教材・研修管理アクセス許可
- **テスト名**: 研修担当者による教材・研修管理アクセス許可
  - **何をテストするか**: trainerユーザーが教材・研修関連機能にアクセス可能であることを確認
  - **期待される動作**: 研修担当者権限による適切なアクセス制御の実現
- **入力値**: `UserRole::Trainer`、教材・研修管理エンドポイント（`/api/materials`、`/api/trainings`）
  - **入力データの意味**: 研修業務に必要な機能への正当なアクセス要求
- **期待される結果**: `AuthorizationResult { allowed: true, reason: None }`
  - **期待結果の理由**: 研修担当者は教材・研修管理権限を持つため
- **テストの目的**: 中間権限レベルの適切な制御確認
  - **確認ポイント**: 役割に応じた適切な機能制限が機能すること
- 🟢 **信頼性レベル**: 要件定義書の役割定義から確実に抽出

### TC-003: 講師による読み取り専用機能アクセス許可
- **テスト名**: 講師による読み取り専用機能アクセス許可
  - **何をテストするか**: instructorユーザーが読み取り専用機能にアクセス可能であることを確認
  - **期待される動作**: 最小権限による安全なアクセス制御の実現
- **入力値**: `UserRole::Instructor`、読み取り専用エンドポイント（`/api/materials` GET、`/api/profile` GET）
  - **入力データの意味**: 講師が必要最小限の情報にアクセスする正当な要求
- **期待される結果**: `AuthorizationResult { allowed: true, reason: None }`
  - **期待結果の理由**: 講師は読み取り専用の限定的な権限を持つため
- **テストの目的**: 最小権限原則の実装確認
  - **確認ポイント**: 権限階層の最下位レベルが適切に制限されること
- 🟢 **信頼性レベル**: 要件定義書の役割制限から確実に抽出

### TC-004: 有効なセッションとの統合認証成功
- **テスト名**: 有効なセッションとの統合認証成功
  - **何をテストするか**: TASK-101のセッション認証とRBAC認可の統合が正常動作することを確認
  - **期待される動作**: セッション認証→RBAC認可の2段階チェックが機能
- **入力値**: 有効なセッション情報 + `UserRole::Trainer` + 許可されたリソース
  - **入力データの意味**: 正当にログインしたユーザーによる権限内でのリソースアクセス
- **期待される結果**: 認証・認可両方が成功し、リソースへのアクセスが許可
  - **期待結果の理由**: セッション有効 + 適切な役割権限 = 正当なアクセス
- **テストの目的**: 統合認証フローの正常動作確認
  - **確認ポイント**: TASK-101との連携が完全に機能すること
- 🟢 **信頼性レベル**: TASK-101実装済みとの統合仕様から確実に抽出

---

## 2. 異常系テストケース（4個）

### TC-005: 権限不足によるアクセス拒否（instructor→admin機能）
- **テスト名**: 権限不足によるアクセス拒否
  - **エラーケースの概要**: 下位役割による上位権限機能へのアクセス試行
  - **エラー処理の重要性**: 権限昇格攻撃の防止とセキュリティ境界の維持
- **入力値**: `UserRole::Instructor` + 管理者専用リソース（`/api/users` POST）
  - **不正な理由**: 講師には管理機能への権限がないため
  - **実際の発生シナリオ**: 講師がURLを直接入力して管理画面にアクセス試行
- **期待される結果**: `AuthorizationError { status: 403, message: "権限が不足しています", required_role: Some("admin") }`
  - **エラーメッセージの内容**: ユーザーに必要な権限レベルを明確に伝える
  - **システムの安全性**: 不正アクセスを確実に阻止し、ログに記録
- **テストの目的**: 権限昇格攻撃の防御確認
  - **品質保証の観点**: セキュリティ境界の確実な維持により信頼性を保証
- 🟢 **信頼性レベル**: セキュリティ要件から確実に抽出

### TC-006: 無効な役割データでのアクセス拒否
- **テスト名**: 無効な役割データでのアクセス拒否
  - **エラーケースの概要**: データベースに不正な役割値が存在する場合の処理
  - **エラー処理の重要性**: データ整合性エラーに対する堅牢な処理による安全性確保
- **入力値**: 不正な役割文字列（`"invalid_role"`、`null`、空文字列）
  - **不正な理由**: システムで定義されていない役割値のため
  - **実際の発生シナリオ**: データベースの直接編集やデータ移行時の不整合
- **期待される結果**: `AuthorizationError { status: 403, message: "無効な役割です", required_role: None }`
  - **エラーメッセージの内容**: 技術的詳細を隠しつつ適切な拒否を通知
  - **システムの安全性**: デフォルトで最小権限を適用し、セキュアフェイル
- **テストの目的**: データ整合性エラーに対する堅牢性確認
  - **品質保証の観点**: 想定外のデータに対してもシステムが安全な状態を維持
- 🟡 **信頼性レベル**: 一般的なセキュリティベストプラクティスから推測

### TC-007: セッション期限切れ時のアクセス拒否
- **テスト名**: セッション期限切れ時のアクセス拒否
  - **エラーケースの概要**: 有効期限切れセッションでのRBACアクセス試行
  - **エラー処理の重要性**: セッション管理とRBACの適切な連携による二重のセキュリティ確保
- **入力値**: 期限切れセッション + 有効な役割 + アクセス可能リソース
  - **不正な理由**: セッションが期限切れのため認証が無効
  - **実際の発生シナリオ**: 長時間画面を開いたままでの操作継続試行
- **期待される結果**: HTTP 401 Unauthorized（セッション認証段階で拒否）
  - **エラーメッセージの内容**: セッション再認証を促すメッセージ
  - **システムの安全性**: RBACチェック前にセッション認証で確実に阻止
- **テストの目的**: 認証・認可の2段階チェックの確実な実行確認
  - **品質保証の観点**: セッション管理との統合による多層防御の確実性
- 🟢 **信頼性レベル**: TASK-101との統合仕様から確実に抽出

### TC-008: データベース接続エラー時のセキュアフェイル
- **テスト名**: データベース接続エラー時のセキュアフェイル
  - **エラーケースの概要**: 権限確認中のデータベース接続失敗
  - **エラー処理の重要性**: インフラエラー時もセキュリティを維持する堅牢な設計
- **入力値**: 正常なリクエスト + データベース接続不可状態
  - **不正な理由**: システム障害により権限確認ができない状況
  - **実際の発生シナリオ**: データベースサーバーの障害やネットワーク分断
- **期待される結果**: `AuthorizationError { status: 403, message: "権限確認に失敗しました" }`
  - **エラーメッセージの内容**: 技術的詳細を隠した一般的なエラーメッセージ
  - **システムの安全性**: 障害時は安全側（アクセス拒否）に倒れる設計
- **テストの目的**: インフラエラー時のセキュアフェイル機能確認
  - **品質保証の観点**: システム障害時もセキュリティが維持される堅牢性
- 🟡 **信頼性レベル**: セキュリティベストプラクティスから推測

---

## 3. 境界値テストケース（4個）

### TC-009: 権限階層の境界値テスト（trainer→admin境界）
- **テスト名**: 権限階層の境界値テスト
  - **境界値の意味**: trainer権限の上限とadmin権限の下限の境界
  - **境界値での動作保証**: 権限階層の厳密な境界制御の確実性
- **入力値**: `UserRole::Trainer` + 管理者専用機能の最も権限の低いリソース
  - **境界値選択の根拠**: trainer権限の上限を明確にするため
  - **実際の使用場面**: 研修担当者による権限昇格試行の検出
- **期待される結果**: `AuthorizationResult { allowed: false, required_role: Some(UserRole::Admin) }`
  - **境界での正確性**: 権限階層が1段階でも不足すれば確実に拒否
  - **一貫した動作**: すべての管理者専用機能で一貫した拒否
- **テストの目的**: 権限階層境界の厳密性確認
  - **堅牢性の確認**: 境界値での曖昧さがないことを保証
- 🟢 **信頼性レベル**: 要件定義の階層構造から確実に抽出

### TC-010: 権限階層の境界値テスト（instructor→trainer境界）
- **テスト名**: 講師・研修担当者間の境界値テスト
  - **境界値の意味**: instructor権限の上限とtrainer権限の下限の境界
  - **境界値での動作保証**: 最小権限原則による確実な制限
- **入力値**: `UserRole::Instructor` + trainer専用機能の最も権限の低いリソース（教材作成）
  - **境界値選択の根拠**: instructor権限の上限を明確にするため
  - **実際の使用場面**: 講師による教材作成・編集試行
- **期待される結果**: `AuthorizationResult { allowed: false, required_role: Some(UserRole::Trainer) }`
  - **境界での正確性**: 読み取り専用権限を超える操作は確実に拒否
  - **一貫した動作**: すべての作成・編集機能で一貫した拒否
- **テストの目的**: 最小権限原則の厳密な実装確認
  - **堅牢性の確認**: 権限不足による操作が確実に阻止されること
- 🟢 **信頼性レベル**: 要件定義の最小権限原則から確実に抽出

### TC-011: 空文字列・null値による役割指定テスト
- **テスト名**: 空文字列・null値による役割指定テスト
  - **境界値の意味**: 役割データの最小値（空・未定義）での動作確認
  - **境界値での動作保証**: 不正データに対するデフォルト拒否の確実性
- **入力値**: `None`、`""`、`null`による役割指定
  - **境界値選択の根拠**: データ不整合時の最悪ケースを想定
  - **実際の使用場面**: ユーザー作成時の役割未設定やデータ破損
- **期待される結果**: `AuthorizationError { status: 403, message: "役割が設定されていません" }`
  - **境界での正確性**: すべての未定義役割に対して一貫した拒否
  - **一貫した動作**: データ不整合時もセキュアフェイル
- **テストの目的**: データ不整合に対する堅牢性確認
  - **堅牢性の確認**: 想定外のデータ状態でも安全性が保たれること
- 🟡 **信頼性レベル**: セキュリティベストプラクティスから推測

### TC-012: 最大同時セッション数での権限チェック性能テスト
- **テスト名**: 最大同時セッション数での権限チェック性能テスト
  - **境界値の意味**: システムの性能上限（100ユーザー同時）での動作確認
  - **境界値での動作保証**: 負荷時も権限チェック機能が確実に動作
- **入力値**: 100個の同時権限チェック要求（各種役割の組み合わせ）
  - **境界値選択の根拠**: 要件定義の性能要件（100ユーザー同時対応）
  - **実際の使用場面**: ピーク時の大量ユーザーアクセス
- **期待される結果**: 全ての権限チェックが10ms以内で完了、100%の正確性
  - **境界での正確性**: 負荷時も権限判定の精度が維持される
  - **一貫した動作**: 性能劣化時も正確性が優先される
- **テストの目的**: 負荷時の性能と正確性の両立確認
  - **堅牢性の確認**: システムの限界値でも機能が確実に動作すること
- 🟡 **信頼性レベル**: 要件定義の性能要件から推測

---

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント

```rust
#[tokio::test]
#[serial]
async fn 管理者による全機能アクセス許可() {
    // 【テスト目的】: adminユーザーが全ての保護されたリソースにアクセス可能であることを確認
    // 【テスト内容】: 管理者権限による各種リソースへのアクセス権限チェック
    // 【期待される動作】: 管理者は全機能への無制限アクセスが許可される
    // 🟢 要件定義書から直接抽出した確実な仕様
}
```

### Given（準備フェーズ）のコメント

```rust
// 【テストデータ準備】: 管理者権限を持つユーザーセッションの作成
// 【初期条件設定】: 有効なセッションと管理者役割の設定
// 【前提条件確認】: TASK-101のセッション認証が正常動作することを前提
```

### When（実行フェーズ）のコメント

```rust
// 【実際の処理実行】: RBAC権限チェック機能の呼び出し
// 【処理内容】: 管理者権限による各種保護リソースへのアクセス試行
// 【実行タイミング】: セッション認証成功後のRBAC権限チェック段階
```

### Then（検証フェーズ）のコメント

```rust
// 【結果検証】: 管理者権限による全機能アクセスの許可確認
// 【期待値確認】: すべての管理機能へのアクセスが許可されることを確認
// 【品質保証】: 権限階層の最上位機能が正常に動作することを保証

// 【確認内容】: ユーザー管理機能へのアクセスが許可されることを確認 🟢
// 【確認内容】: システム設定機能へのアクセスが許可されることを確認 🟢
```

---

## テストケース統計

### 分類別統計
- **正常系テストケース**: 4個 (33.3%)
- **異常系テストケース**: 4個 (33.3%)
- **境界値テストケース**: 4個 (33.3%)
- **総テストケース**: 12個

### 信頼性レベル統計
- **🟢 青信号（確実）**: 8個 (66.7%)
- **🟡 黄信号（推測）**: 4個 (33.3%)
- **🔴 赤信号（不確実）**: 0個 (0%)

### 対象機能統計
- **権限階層制御**: 6個 (50%)
- **セキュリティ機能**: 4個 (33.3%)
- **統合・性能**: 2個 (16.7%)

---

**テストケース定義完了日**: 2025-08-23
**品質判定**: ✅ 高品質（正常系・異常系・境界値網羅、期待値明確、技術選択確定、実装可能性確実）