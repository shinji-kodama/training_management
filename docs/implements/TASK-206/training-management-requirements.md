# TASK-206: プロジェクト管理機能 - TDD要件定義書

**作成日**: 2025-08-24  
**フェーズ**: TDD Requirements Definition  
**実装対象**: プロジェクト管理機能（Controller層・View層・API層）  
**依存タスク**: TASK-205（研修コース管理機能）✅完了済み

## 📊 要件定義サマリー

**機能名**: プロジェクト管理機能  
**開発ステータス**: Requirements Definition完了  
**既存実装状況**: Model層 95%完成済み（高品質実装済み）  
**技術的リスク**: 低（既存パターン踏襲・高完成度Model層活用）

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

🟢 **プロジェクト管理機能 - 研修実施プロジェクトの包括的管理システム**
- **何をする機能か**: 研修コースを実際の企業で実施するプロジェクトの作成・管理・進捗追跡を支援する管理システム
- **解決する問題**: 研修コースの実施から参加者管理、進捗追跡まで一元化された管理プロセスの自動化
- **想定ユーザー**: 
  - **管理者**: 全プロジェクトの作成・管理・削除
  - **トレーナー**: 担当プロジェクトの作成・管理・参加者管理
  - **講師**: プロジェクト閲覧・参加者状況確認
- **システム内位置づけ**: 研修コース管理機能（TASK-205）と受講者管理機能（TASK-203）を結合し、実際の研修実施を管理する中核機能
- **参照したEARS要件**: REQ-007, REQ-404
- **参照した設計文書**: training-management-tasks.md TASK-206仕様、database-schema.sql projects/project_participants定義

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

🟢 **プロジェクト基本データ**
- **入力パラメータ**:
  ```rust
  struct CreateProjectParams {
      training_id: UUID,            // 必須、研修コースID（TASK-205連携）
      company_id: UUID,            // 必須、実施企業ID（TASK-203連携）
      title: String,               // 必須、1-255文字、プロジェクト名
      start_date: NaiveDate,       // 必須、開始日
      end_date: NaiveDate,         // 必須、終了日（start_date以降）
      created_by: i32,             // 必須、作成者ユーザーID
  }
  ```

🟢 **参加者管理データ**
- **入力パラメータ**:
  ```rust
  struct ProjectParticipantParams {
      project_id: UUID,            // プロジェクトID
      student_id: UUID,            // 受講者ID（TASK-203連携）
      status: i32,                 // 研修状況（1-5段階）1:failed, 2:poor, 3:average, 4:good, 5:excellent
      all_interviews_completed: bool, // 全面談完了フラグ
  }
  ```

🟢 **出力値**
- **プロジェクト一覧**: JSON配列（ページネーション対応）
- **プロジェクト詳細**: プロジェクト情報 + 参加者リスト（研修状況・面談完了状況含む）
- **参加者状況**: 研修進捗サマリー（1-5段階別人数・完了率）
- **HTTP応答**: 200 OK（成功）、302 Found（作成後）、422 Unprocessable Entity（バリデーションエラー）

- **参照したEARS要件**: REQ-007（プロジェクト管理）、REQ-404（参加者管理）
- **参照した設計文書**: データベーススキーマ（projects, project_participants テーブル）

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

🟢 **セキュリティ要件**
- **認証**: セッションベース認証必須（全エンドポイント）
- **認可**: RBAC統合（admin/trainer/instructor 権限制御）
- **企業閲覧制御**: company_id による閲覧スコープ制限
- **CSRF保護**: フォーム送信時のCSRFトークン検証

🟢 **データベース制約**
- **外部キー制約**: projects → trainings/companies/users（RESTRICT削除）
- **外部キー制約**: project_participants → projects/students（CASCADE削除）
- **一意制約**: (project_id, student_id) プロジェクト内重複参加防止
- **チェック制約**: status BETWEEN 1 AND 5、start_date <= end_date
- **NOT NULL制約**: training_id, company_id, title, start_date, end_date, created_by

🟡 **パフォーマンス要件**
- **レスポンス時間**: 2秒以内（一覧表示）、3秒以内（詳細表示）
- **同時接続**: 100ユーザー対応
- **データ量**: プロジェクト1000件、参加者記録10000件まで対応

🟢 **アーキテクチャ制約**
- **MVC アーキテクチャ**: Controller-Model-View分離
- **既存統合**: projects.rs、project_participants.rsモデル活用、TASK-205成功パターン踏襲
- **レスポンシブUI**: タブレット・スマートフォン対応

- **参照したEARS要件**: NFR-102（セキュリティ）、REQ-404（プロジェクト制約）
- **参照した設計文書**: データベーススキーマ、セキュリティ要件、existing models実装

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

🟢 **基本的な使用パターン**
1. **プロジェクト作成フロー**:
   - 管理者/トレーナーがログイン → プロジェクト作成画面表示 → 研修コース選択・企業選択 → 基本情報入力 → 保存
2. **参加者追加フロー**:
   - 既存プロジェクト詳細画面 → 参加者追加ボタン → 受講者検索・選択 → 初期状況設定 → 追加
3. **進捗管理フロー**:
   - プロジェクト一覧 → 詳細画面 → 参加者状況一覧 → ステータス更新 → 面談完了チェック

🟢 **正常ケース**
- 有効なプロジェクトデータでの作成成功
- 参加者追加・状況更新の正常動作
- 企業別プロジェクト閲覧制御の正確な動作

🟡 **エッジケース**
- **大量参加者**: 100名以上の参加者を1プロジェクトに追加
- **期間設定境界値**: 開始日=終了日、長期間プロジェクト（1年以上）
- **ステータス一括更新**: 大量参加者の研修状況同時更新

🟢 **エラーケース**
- **重複参加**: 同一受講者の同一プロジェクト重複参加試行（一意制約違反）
- **存在しない研修/企業選択**: 削除済み研修コース・企業の選択試行
- **権限違反**: instructor による作成・編集試行
- **企業制限違反**: 他社プロジェクトへの不正アクセス試行
- **日付整合性違反**: 終了日 < 開始日の設定試行

- **参照したEARS要件**: REQ-007（基本フロー）、REQ-404（参加者管理フロー）
- **参照した設計文書**: database-schema.sql制約定義、プロジェクトワークフロー

## 5. EARS要件・設計文書との対応関係

**参照したユーザストーリー**: プロジェクト管理（TASK-206）
**参照した機能要件**: 
- REQ-007: プロジェクト基本管理
- REQ-404: 参加者管理機能

**参照した非機能要件**: 
- NFR-102: セキュリティ要件
- NFR-201: UI/UX要件
- NFR-204: パフォーマンス要件

**参照したEdgeケース**: 
- 一意制約違反（重複参加者追加）
- 境界値テスト（日付設定、ステータス範囲）
- 権限違反（不正アクセス）

**参照した設計文書**:
- **データベース**: projects テーブル、project_participants テーブル
- **Model実装**: projects.rs（530行、高完成度）、project_participants.rs（222行）
- **アーキテクチャ**: TASK-205成功パターン（セキュリティ強化済み）
- **API仕様**: RESTful エンドポイント設計

## 6. 技術実装詳細

### 6.1 既存実装活用戦略

🟢 **Model層完全活用**（高完成度実装済み）
- **`src/models/projects.rs`**: 530行、包括的CRUD実装済み
- **`src/models/project_participants.rs`**: 222行、参加者管理完全実装済み
- **データベーススキーマ**: 外部キー制約・インデックス・トリガー設定済み

🟢 **セキュリティパターン活用**（TASK-205成功事例）
- **SessionAuth**: セッションベース認証統合
- **RBAC統合**: 権限ベースアクセス制御
- **CSRF保護**: フォーム送信時の保護機能
- **XSS防止**: 入力値サニタイゼーション

### 6.2 新規実装要件

🟡 **Controller層実装**
```rust
// 新規作成必要ファイル
src/controllers/projects.rs             // Project CRUD API
src/views/projects/                     // HTML テンプレート群
tests/controllers/projects.rs          // Controller テスト
```

🟡 **APIエンドポイント設計**
```
GET    /projects                        # プロジェクト一覧
GET    /projects/new                    # プロジェクト作成フォーム
POST   /projects                        # プロジェクト作成
GET    /projects/{id}                   # プロジェクト詳細
GET    /projects/{id}/edit              # プロジェクト編集フォーム
PUT    /projects/{id}                   # プロジェクト更新
DELETE /projects/{id}                   # プロジェクト削除
POST   /projects/{id}/participants      # 参加者追加
PUT    /projects/{id}/participants/{participant_id}  # 参加者状況更新
DELETE /projects/{id}/participants/{participant_id} # 参加者削除
```

### 6.3 段階的実装戦略

🟢 **Phase 1: 基本CRUD機能**（最優先）
- ProjectController基本実装
- CRUD API（既存モデル活用）
- RBAC統合（既存パターン踏襲）

🟢 **Phase 2: 参加者管理機能**（高優先）
- 参加者追加・削除API
- 研修状況更新・面談完了管理機能
- 受講者検索統合（TASK-203活用）

🟡 **Phase 3: 高度UI機能**（中優先）
- 進捗可視化（参加者状況ダッシュボード）
- 一括状況更新機能
- HTMX部分更新

## 7. 品質保証要件

### 7.1 テスト要件

🟢 **必須テストケース**
- **正常系**: プロジェクト CRUD 操作
- **異常系**: バリデーションエラー、権限違反
- **統合テスト**: 参加者管理・状況更新機能
- **エッジケース**: 境界値、一意制約違反

🟢 **セキュリティテスト**
- **認証テスト**: 未認証アクセス拒否
- **認可テスト**: 権限レベル別アクセス制御
- **企業制限テスト**: 閲覧スコープ制御
- **CSRF保護テスト**: トークン検証

### 7.2 パフォーマンステスト

🟡 **負荷テスト要件**
- **同時接続**: 100ユーザー
- **データ量**: プロジェクト1000件
- **レスポンス**: 2秒以内

## 8. リスク分析・軽減策

### 8.1 技術的リスク

🟡 **UI複雑性リスク**: 参加者一覧・状況更新UIの実装複雑度
- **軽減策**: 段階的実装（基本機能 → 高度UI機能）

🟡 **パフォーマンスリスク**: 大量参加者表示時の性能問題
- **軽減策**: ページネーション、非同期読み込み

🟢 **データ整合性リスク**: プロジェクト-参加者リレーションの一意制約管理
- **軽減策**: 既存高品質Model層の活用、データベース制約

### 8.2 推奨対策

🟢 **既存実装最大活用**: 95%完成済みModel層の活用
🟢 **成功パターン踏襲**: TASK-205セキュリティ強化パターン活用
🟢 **段階的開発**: Phase分けによるリスク分散

---

## 📋 要件品質判定

### ✅ **高品質** - 要件定義完了基準を満たす

**判定根拠**:
- **要件明確性**: 🟢 明確（既存タスク定義・データベーススキーマ明確）
- **入出力定義**: 🟢 完全（構造体定義・API仕様明確）
- **制約条件**: 🟢 明確（セキュリティ・DB制約・パフォーマンス明確）
- **実装可能性**: 🟢 確実（95%完成済みModel層・成功パターン活用可能）

**特筆すべき強み**:
- **既存実装活用**: Model層高完成度により実装リスク最小化
- **成功事例踏襲**: TASK-205パターン活用により品質保証
- **段階的戦略**: Phase分けによる確実な実装進行

---

**要件定義完了**: 2025-08-24  
**次のステップ**: `/tdd-testcases` でテストケースの洗い出しを行います。  
**推奨アプローチ**: Phase 1（基本CRUD）から段階的実装開始