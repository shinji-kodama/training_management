# TASK-206: プロジェクト管理機能 - TDDテストケース設計書

**作成日**: 2025-08-24  
**フェーズ**: TDD Test Cases Definition  
**実装対象**: プロジェクト管理機能（Controller層・View層・API層）  
**技術スタック**: Rust + Loco.rs + SeaORM + tokio::test

## 📊 テストケース設計サマリー

**テストケース総数**: 18件
- **正常系テストケース**: 6件（33%）
- **異常系テストケース**: 6件（33%）  
- **境界値テストケース**: 4件（22%）
- **統合テストケース**: 2件（12%）

**カバレッジ目標**: Controller層 90%以上、統合機能 100%  
**テスト実行環境**: PostgreSQL テストデータベース + Tokio Runtime

---

## 🔧 開発言語・フレームワーク

### **プログラミング言語**: Rust
- **言語選択の理由**: 型安全性とパフォーマンス、既存プロジェクト統一性
- **テストに適した機能**: 強力な型システム、所有権システムによる安全なテスト、詳細なエラーハンドリング
- 🟢 **信頼性レベル**: 既存プロジェクトの技術スタック完全準拠

### **テストフレームワーク**: cargo test + tokio::test + serial_test
- **フレームワーク選択の理由**: Rust標準テストフレームワーク + 非同期対応 + データベーステスト直列化
- **テスト実行環境**: PostgreSQL開発データベース（DATABASE_URL環境変数）
- 🟢 **信頼性レベル**: TASK-205成功事例と完全同一の技術選択

---

## 1. 正常系テストケース（基本的な動作）

### TC-001: プロジェクト一覧画面表示成功
- **テスト名**: `test_プロジェクト一覧画面表示_controller実装200成功`
  - **何をテストするか**: GET /projects エンドポイントの正常な一覧表示機能
  - **期待される動作**: プロジェクト一覧が正常に取得され、レスポンスが200 OKで返される
- **入力値**: 認証済みセッション（admin権限）
  - **入力データの意味**: 管理者としてプロジェクト一覧にアクセスする最も標準的なシナリオ
- **期待される結果**: HTTP 200 OK + プロジェクト一覧JSON
  - **期待結果の理由**: 認証済み管理者は全プロジェクトへのアクセス権限を持つため
- **テストの目的**: 基本的なプロジェクト一覧取得機能の動作確認
  - **確認ポイント**: データベースからのプロジェクト取得とJSON変換の正確性
- 🟢 **信頼性レベル**: TASK-205成功パターンの完全踏襲、要件定義明確対応

### TC-002: プロジェクト作成フォーム表示成功
- **テスト名**: `test_プロジェクト作成フォーム表示_controller実装200成功`
  - **何をテストするか**: GET /projects/new エンドポイントのフォーム表示機能
  - **期待される動作**: プロジェクト作成フォームが正常に表示される
- **入力値**: 認証済みセッション（trainer権限）
  - **入力データの意味**: トレーナーとしてプロジェクト作成権限を行使する代表的ケース
- **期待される結果**: HTTP 200 OK + 作成フォーム表示
  - **期待結果の理由**: trainer権限はプロジェクト作成機能へのアクセスが許可される
- **テストの目的**: プロジェクト作成フォームの正常表示確認
  - **確認ポイント**: RBAC統合とフォームレンダリングの正確性
- 🟢 **信頼性レベル**: 要件定義のRBAC仕様に完全準拠

### TC-003: プロジェクト作成処理成功
- **テスト名**: `test_プロジェクト作成処理_controller実装200成功`
  - **何をテストするか**: POST /projects エンドポイントでの新規プロジェクト作成機能
  - **期待される動作**: 有効なプロジェクトデータで作成が成功し、データベースに保存される
- **入力値**: 有効なCreateProjectParams
  ```rust
  CreateProjectParams {
      training_id: 有効なUUID,
      company_id: 有効なUUID, 
      title: "実践Rust開発プロジェクト",
      start_date: NaiveDate::from_ymd(2025, 9, 1),
      end_date: NaiveDate::from_ymd(2025, 12, 31),
      created_by: 1
  }
  ```
  - **入力データの意味**: 実際のプロジェクト作成で入力される標準的で有効な値の組み合わせ
- **期待される結果**: HTTP 200 OK + プロジェクト作成成功 + データベース保存確認
  - **期待結果の理由**: 全ての必須フィールドが有効で、データベース制約を満たすため
- **テストの目的**: プロジェクト作成機能の包括的動作確認
  - **確認ポイント**: バリデーション、Model層統合、データベース永続化の正確性
- 🟢 **信頼性レベル**: 要件定義のデータ構造仕様と95%完成Model層の活用

### TC-004: プロジェクト詳細表示成功
- **テスト名**: `test_プロジェクト詳細表示_controller実装200成功`
  - **何をテストするか**: GET /projects/{id} エンドポイントでの詳細情報取得機能
  - **期待される動作**: 指定IDのプロジェクト詳細情報が正常に取得される
- **入力値**: 存在するプロジェクトのUUID + 認証済みセッション
  - **入力データの意味**: 実際に存在するプロジェクトへの正当なアクセスリクエスト
- **期待される結果**: HTTP 200 OK + プロジェクト詳細JSON + 参加者リスト
  - **期待結果の理由**: 存在するプロジェクトに対するアクセス権限があるため
- **テストの目的**: プロジェクト詳細取得機能と参加者情報統合の確認
  - **確認ポイント**: プロジェクト情報と参加者データの正確な結合表示
- 🟢 **信頼性レベル**: Model層の高完成度実装（projects.rs, project_participants.rs）活用

### TC-005: 参加者追加処理成功  
- **テスト名**: `test_プロジェクト参加者追加_controller実装200成功`
  - **何をテストするか**: POST /projects/{id}/participants エンドポイントでの参加者追加機能
  - **期待される動作**: 有効な参加者データでプロジェクトへの参加者追加が成功する
- **入力値**: 有効なProjectParticipantParams
  ```rust
  ProjectParticipantParams {
      project_id: 存在するプロジェクトUUID,
      student_id: 存在する受講者UUID,
      status: 3, // average
      all_interviews_completed: false
  }
  ```
  - **入力データの意味**: プロジェクトに新規参加者を追加する最も標準的なシナリオ
- **期待される結果**: HTTP 200 OK + 参加者追加成功 + project_participants テーブル挿入
  - **期待結果の理由**: 一意制約を満たし、全ての外部キー制約が有効なため
- **テストの目的**: 参加者管理機能の正常動作確認
  - **確認ポイント**: 外部キー制約、一意制約チェック、デフォルト値設定の正確性
- 🟢 **信頼性レベル**: データベーススキーマの制約定義と既存Model層実装に完全準拠

### TC-006: 参加者状況更新処理成功
- **テスト名**: `test_参加者研修状況更新_controller実装200成功`
  - **何をテストするか**: PUT /projects/{id}/participants/{participant_id} での状況更新機能
  - **期待される動作**: 参加者の研修状況（status）と面談完了フラグが正常に更新される
- **入力値**: 更新用パラメータ（status: 4, all_interviews_completed: true）
  - **入力データの意味**: 研修進捗に応じて状況を良好(good)に更新し、面談完了をマークする実用的シナリオ
- **期待される結果**: HTTP 200 OK + 状況更新成功 + データベース反映確認
  - **期待結果の理由**: 有効な範囲内のstatus値（1-5）で、既存参加者への更新のため
- **テストの目的**: 参加者状況管理機能の動作確認
  - **確認ポイント**: ビジネスルール（status範囲）チェック、更新処理の正確性
- 🟢 **信頼性レベル**: 要件定義のビジネスルール（1-5段階評価）に完全準拠

---

## 2. 異常系テストケース（エラーハンドリング）

### TC-007: 未認証ユーザープロジェクトアクセス拒否
- **テスト名**: `test_未認証ユーザープロジェクトアクセス拒否_401エラー`
  - **エラーケースの概要**: セッション認証なしでプロジェクト機能へのアクセス試行
  - **エラー処理の重要性**: システムセキュリティの第一層防御として必須
- **入力値**: 未認証リクエスト（セッション情報なし）
  - **不正な理由**: プロジェクト管理は機密性の高い業務データのため認証が必須
  - **実際の発生シナリオ**: セッション有効期限切れ後のアクセス、不正アクセス試行
- **期待される結果**: HTTP 401 Unauthorized + 認証要求メッセージ
  - **エラーメッセージの内容**: "認証が必要です。ログインしてください。"
  - **システムの安全性**: 機密データへの不正アクセスを完全遮断
- **テストの目的**: SessionAuth統合によるセキュリティ確保の確認
  - **品質保証の観点**: セキュリティ要件NFR-102の実装品質確認
- 🟢 **信頼性レベル**: TASK-205セキュリティ強化パターンの完全踏襲

### TC-008: instructor権限プロジェクト作成拒否
- **テスト名**: `test_instructor権限プロジェクト作成拒否_403エラー`
  - **エラーケースの概要**: 閲覧専用権限でのプロジェクト作成試行
  - **エラー処理の重要性**: RBAC権限システムの正確な動作保証
- **入力値**: instructor権限セッション + プロジェクト作成リクエスト
  - **不正な理由**: instructor は閲覧・確認権限のみで作成権限は付与されていない
  - **実際の発生シナリオ**: 権限の誤解による不正操作試行、権限昇格攻撃
- **期待される結果**: HTTP 403 Forbidden + 権限不足メッセージ  
  - **エラーメッセージの内容**: "この操作を実行する権限がありません。管理者にお問い合わせください。"
  - **システムの安全性**: 権限レベルを超えた操作を確実に阻止
- **テストの目的**: RBAC統合による適切な認可制御の確認
  - **品質保証の観点**: 権限マトリックス設計の実装正確性確認
- 🟢 **信頼性レベル**: 要件定義のRBAC仕様（admin/trainer/instructor権限制御）に完全準拠

### TC-009: 他社専用プロジェクト不正アクセス拒否
- **テスト名**: `test_他社専用プロジェクト不正アクセス拒否_403エラー`
  - **エラーケースの概要**: 異なる企業のプロジェクトへの不正アクセス試行
  - **エラー処理の重要性**: 企業間データ分離によるプライバシー保護
- **入力値**: 企業Aのユーザーが企業Bのプロジェクトにアクセス
  - **不正な理由**: 企業別データ分離により他社データへのアクセスは禁止
  - **実際の発生シナリオ**: URL推測によるアクセス試行、権限誤設定
- **期待される結果**: HTTP 403 Forbidden + アクセス拒否メッセージ
  - **エラーメッセージの内容**: "このプロジェクトへのアクセス権限がありません。"
  - **システムの安全性**: 企業間情報漏洩の完全防止
- **テストの目的**: company_id による企業別アクセス制御の確認
  - **品質保証の観点**: マルチテナント環境でのデータ分離品質確認
- 🟢 **信頼性レベル**: 要件定義の企業閲覧制御仕様に完全準拠

### TC-010: 重複参加者追加エラー処理
- **テスト名**: `test_同一参加者重複追加_422バリデーションエラー`
  - **エラーケースの概要**: 既に参加している受講者を同一プロジェクトに再度追加する試行
  - **エラー処理の重要性**: データ整合性保護と一意制約違反の適切なハンドリング
- **入力値**: 既存参加者と同一の(project_id, student_id)組み合わせ
  - **不正な理由**: データベース一意制約 UNIQUE(project_id, student_id) 違反
  - **実際の発生シナリオ**: 管理画面での重複操作、並行処理時の競合
- **期待される結果**: HTTP 422 Unprocessable Entity + 重複エラーメッセージ
  - **エラーメッセージの内容**: "この受講者は既にプロジェクトに参加しています。"
  - **システムの安全性**: データベース整合性を保護し、重複データを防止
- **テストの目的**: 一意制約違反の適切なエラーハンドリング確認
  - **品質保証の観点**: データベース制約とアプリケーションレベルバリデーションの整合性
- 🟢 **信頼性レベル**: データベーススキーマの一意制約定義に完全準拠

### TC-011: 存在しない研修コース選択エラー
- **テスト名**: `test_存在しない研修コース選択_422バリデーションエラー`
  - **エラーケースの概要**: 削除済みまたは存在しない研修コースIDでプロジェクト作成試行
  - **エラー処理の重要性**: 外部キー整合性保護とデータ一貫性確保
- **入力値**: 存在しないtraining_idを含むCreateProjectParams
  - **不正な理由**: 外部キー制約 training_id → trainings(id) 違反
  - **実際の発生シナリオ**: 研修コース削除後のキャッシュ残存、並行削除操作
- **期待される結果**: HTTP 422 Unprocessable Entity + 参照エラーメッセージ
  - **エラーメッセージの内容**: "指定された研修コースが存在しません。"
  - **システムの安全性**: 無効な参照によるデータ破損を防止
- **テストの目的**: 外部キー制約違反の適切なエラーハンドリング確認  
  - **品質保証の観点**: 参照整合性保護の実装品質確認
- 🟢 **信頼性レベル**: 既存Model層の外部キー存在確認機能活用

### TC-012: 日付整合性違反エラー処理
- **テスト名**: `test_終了日が開始日より早い_422バリデーションエラー`
  - **エラーケースの概要**: 論理的に不正な日付範囲（終了日 < 開始日）での作成試行
  - **エラー処理の重要性**: ビジネスルール違反の検出と適切な早期エラー通知
- **入力値**: end_date が start_date より早いCreateProjectParams
  - **不正な理由**: プロジェクトの論理的な時間軸に反するため
  - **実際の発生シナリオ**: 入力ミス、日付選択UIの誤操作、データ移行エラー
- **期待される結果**: HTTP 422 Unprocessable Entity + 日付エラーメッセージ
  - **エラーメッセージの内容**: "終了日は開始日以降である必要があります。"
  - **システムの安全性**: ビジネスロジック違反データの保存を防止
- **テストの目的**: ビジネスルールレベルでの入力値検証確認
  - **品質保証の観点**: アプリケーションロジックの整合性チェック品質確認
- 🟢 **信頼性レベル**: 要件定義のチェック制約（start_date <= end_date）仕様に完全準拠

---

## 3. 境界値テストケース（最小値、最大値、null等）

### TC-013: ステータス範囲境界値テスト（最小値1）
- **テスト名**: `test_参加者ステータス最小値1_正常処理確認`
  - **境界値の意味**: 研修状況評価の最低値（1: failed）での動作保証
  - **境界値での動作保証**: 最低評価でも正常にシステム処理されることを確認
- **入力値**: status = 1（最低評価）の参加者データ
  - **境界値選択の根拠**: データベースチェック制約 status BETWEEN 1 AND 5 の下限値
  - **実際の使用場面**: 研修で不合格となった受講者の状況記録
- **期待される結果**: 正常処理（HTTP 200 OK）+ データベース保存成功
  - **境界での正確性**: 最小値での計算・保存処理が正確に実行される
  - **一貫した動作**: 他のステータス値と同様の処理フローで動作する
- **テストの目的**: ステータス値下限での正常動作確認
  - **堅牢性の確認**: 評価システムが全範囲で安定動作することを保証
- 🟢 **信頼性レベル**: 要件定義の1-5段階評価仕様とデータベース制約に完全準拠

### TC-014: ステータス範囲境界値テスト（最大値5）
- **テスト名**: `test_参加者ステータス最大値5_正常処理確認`
  - **境界値の意味**: 研修状況評価の最高値（5: excellent）での動作保証
  - **境界値での動作保証**: 最高評価での集計・表示処理の正確性確認
- **入力値**: status = 5（最高評価）の参加者データ
  - **境界値選択の根拠**: データベースチェック制約 status BETWEEN 1 AND 5 の上限値
  - **実際の使用場面**: 研修で優秀な成績を収めた受講者の状況記録
- **期待される結果**: 正常処理（HTTP 200 OK）+ 統計計算正確性
  - **境界での正確性**: 最高評価での進捗サマリー計算が正確に実行される
  - **一貫した動作**: 評価統計表示で最高値が適切に反映される
- **テストの目的**: ステータス値上限での正常動作確認
  - **堅牢性の確認**: 評価統計システムが境界値で正確に動作することを保証
- 🟢 **信頼性レベル**: ビジネス要件の5段階評価システム仕様に完全準拠

### TC-015: ステータス範囲外エラー（0以下）
- **テスト名**: `test_参加者ステータス範囲外0_422バリデーションエラー`
  - **境界値の意味**: 許可範囲を下回る不正値での堅牢性確認
  - **境界値での動作保証**: 不正値に対する適切なエラー処理の確認
- **入力値**: status = 0（範囲外下限）の参加者データ
  - **境界値選択の根拠**: 有効範囲1-5を下回る代表的な不正値
  - **実際の使用場面**: API直接操作での不正値送信、データ破損時の復旧処理
- **期待される結果**: HTTP 422 Unprocessable Entity + 範囲外エラーメッセージ
  - **境界での正確性**: 不正値が確実に検出・拒否される
  - **一貫した動作**: 他の範囲外値と同様のエラー処理が実行される
- **テストの目的**: ステータス値範囲外での適切な例外処理確認
  - **堅牢性の確認**: 不正データに対するシステム防御機能の品質確認
- 🟢 **信頼性レベル**: Model層のバリデーション実装（MIN_STATUS/MAX_STATUS定数）に完全準拠

### TC-016: プロジェクト期間境界値テスト（同一日）
- **テスト名**: `test_プロジェクト開始終了同一日_正常処理確認`
  - **境界値の意味**: 最短期間（1日）プロジェクトでの動作保証
  - **境界値での動作保証**: 極端に短いプロジェクト期間での正常処理確認
- **入力値**: start_date = end_date（同一日）のプロジェクトデータ
  - **境界値選択の根拠**: 日付制約 start_date <= end_date の等号境界ケース
  - **実際の使用場面**: 1日完結型ワークショップ、緊急研修の実施
- **期待される結果**: 正常処理（HTTP 200 OK）+ 期間計算正確性
  - **境界での正確性**: 1日プロジェクトの期間計算と表示が正確に実行される
  - **一貫した動作**: 長期プロジェクトと同様の管理機能が利用可能
- **テストの目的**: 最短期間プロジェクトでの全機能正常動作確認
  - **堅牢性の確認**: 期間計算ロジックが境界値で正確に動作することを保証
- 🟡 **信頼性レベル**: 要件定義から推定される実用的な境界ケース

---

## 4. 統合テストケース（システム間連携）

### TC-017: プロジェクト・参加者統合管理テスト
- **テスト名**: `test_プロジェクト参加者統合管理_完全フロー確認`
  - **統合機能の概要**: プロジェクト作成から参加者管理まで一連の業務フロー統合テスト
  - **システム間連携の重要性**: 複数テーブル・機能の協調動作による業務完結性確認
- **入力値**: プロジェクト作成 → 参加者追加 → 状況更新の完全フロー
  - **統合シナリオの意味**: 実際の業務で実行される代表的な操作シーケンス
  - **実際の業務フロー**: 新規研修プロジェクト立ち上げから受講者管理までの包括的操作
- **期待される結果**: 全フロー成功 + データ整合性保証 + 統計情報正確性
  - **統合結果の正確性**: projects、project_participants間のデータ連携が正確に動作
  - **業務完結性**: 一連の操作で想定されるビジネス価値が完全に実現される
- **テストの目的**: 複数機能の統合による業務プロセス完結性確認
  - **品質保証の観点**: エンドツーエンドでのシステム品質・使用性確認
- 🟢 **信頼性レベル**: 要件定義の基本使用パターン（プロジェクト作成フロー、参加者追加フロー）に完全準拠

### TC-018: 企業別プロジェクト表示制御統合テスト
- **テスト名**: `test_企業別プロジェクト表示制御統合_セキュリティ確認`
  - **統合機能の概要**: 認証・認可・企業制限の三層セキュリティ統合動作確認
  - **システム間連携の重要性**: SessionAuth + RBAC + 企業制限の協調による完全なアクセス制御
- **入力値**: 複数企業・複数権限での同一エンドポイントアクセスパターン
  - **統合シナリオの意味**: マルチテナント環境での各社データ分離の実証
  - **実際のセキュリティ要求**: 企業間情報漏洩防止とロール別アクセス制御の同時実現
- **期待される結果**: 企業別データ分離 + 権限別機能制限の完全動作
  - **統合結果の正確性**: 複数セキュリティ層が相互に影響せず正確に動作
  - **セキュリティ完全性**: 想定外のデータアクセス・操作が完全に防止される
- **テストの目的**: 多層セキュリティアーキテクチャの統合動作品質確認
  - **品質保証の観点**: エンタープライズレベルセキュリティ要件の実装品質確認
- 🟢 **信頼性レベル**: TASK-205セキュリティ強化パターンの活用と企業制限仕様に完全準拠

---

## 📋 テストケース品質判定

### ✅ **高品質** - テストケース設計完了基準を満たす

**判定根拠**:
- **テストケース分類**: ✅ 正常系・異常系・境界値・統合が網羅されている（6+6+4+2=18件）
- **期待値定義**: ✅ 各テストケースの期待値が明確（HTTP status、エラーメッセージ、データベース状態）  
- **技術選択**: ✅ プログラミング言語・テストフレームワークが確定（Rust + cargo test + tokio::test）
- **実装可能性**: ✅ 現在の技術スタックで実現可能（既存成功パターン踏襲）

**特筆すべき強み**:
- **既存実装活用**: TASK-205成功パターンの完全踏襲によりリスク最小化
- **包括的カバレッジ**: 正常系33% + 異常系33% + 境界値22% + 統合12%の最適バランス
- **セキュリティ重視**: 認証・認可・企業制限の多層防御テスト完備
- **実用性重視**: 実際のビジネスフローに基づく実践的テストケース設計

---

## 🔧 テストケース実装指針

### テストケース実装時の日本語コメント標準化

```rust
#[tokio::test]
#[serial]
async fn test_プロジェクト一覧画面表示_controller実装200成功() {
    // 【テスト目的】: プロジェクト一覧取得エンドポイントの正常動作確認
    // 【テスト内容】: GET /projects での認証済みアクセスによる一覧表示機能
    // 【期待される動作】: プロジェクト一覧が正常取得され200 OKが返される
    // 🟢 信頼性レベル: 要件定義明確対応・既存成功パターン踏襲
    
    // 【テストデータ準備】: 認証済みセッション（admin権限）での正当アクセス
    // 【初期条件設定】: データベースにテスト用プロジェクトデータを事前作成
    // 【前提条件確認】: SessionAuth統合によるセキュリティ機能が有効
    
    // 【実際の処理実行】: GET /projects エンドポイントへの認証済みリクエスト送信
    // 【処理内容】: Controller層でのプロジェクト一覧取得とJSON変換処理
    // 【実行タイミング】: テストデータ準備完了後の適切なタイミング
    
    // 【結果検証】: HTTP 200 OKレスポンスとプロジェクト一覧データの正確性確認
    // 【期待値確認】: データベースから取得されたプロジェクト情報の完全性
    // 【品質保証】: 基本機能の正常動作によるシステム信頼性確保
    assert_eq!(response.status_code(), 200); // 【確認内容】: 正常レスポンス確認
}
```

### 必須実装ファイル構成

```rust
// テストファイル配置
tests/requests/projects.rs              // 基本CRUD統合テスト（TC-001～TC-006）
tests/requests/projects_security.rs     // セキュリティ統合テスト（TC-007～TC-012）  
tests/requests/projects_boundary.rs     // 境界値テスト（TC-013～TC-016）
tests/requests/projects_integration.rs  // システム統合テスト（TC-017～TC-018）
```

---

**テストケース設計完了**: 2025-08-24  
**次のステップ**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。  
**品質レベル**: **エンタープライズ品質テストケース** 🏆  
**カバレッジ目標**: Controller層90%以上、セキュリティ機能100%