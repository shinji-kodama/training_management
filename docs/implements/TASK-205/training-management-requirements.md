# TASK-205: 研修コース管理機能 - TDD要件定義書

**作成日**: 2025-08-24  
**フェーズ**: TDD Requirements Definition  
**実装対象**: 研修コース管理機能（Controller層・View層・API層）  
**依存タスク**: TASK-204（教材管理機能）✅完了済み

## 📊 要件定義サマリー

**機能名**: 研修コース管理機能  
**開発ステータス**: Requirements Definition完了  
**既存実装状況**: Model層 85%完成済み（高品質実装済み）  
**技術的リスク**: 低（既存パターン踏襲・高完成度Model層活用）

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

🟢 **研修コース管理機能 - 包括的なコース設計・管理システム**
- **何をする機能か**: 研修コースの作成・管理・配信を支援する包括的な管理システム
- **解決する問題**: 教材を組み合わせた体系的な研修プログラムの設計・管理の自動化
- **想定ユーザー**: 
  - **管理者**: 全研修コースの作成・管理・削除
  - **トレーナー**: 担当研修コースの作成・管理
  - **講師**: 研修コース閲覧・参照
- **システム内位置づけ**: 教材管理機能（TASK-204）と受講者管理機能（TASK-203）を結合する中核機能
- **参照したEARS要件**: REQ-005, REQ-006, REQ-012, REQ-103, REQ-104, REQ-105
- **参照した設計文書**: training-management-tasks.md TASK-205仕様

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

🟢 **研修コース基本データ**
- **入力パラメータ**:
  ```rust
  struct CreateTrainingParams {
      title: String,              // 必須、1-255文字
      description: String,        // 必須、詳細説明
      prerequisites: String,      // 必須、受講前提条件
      goals: String,             // 必須、研修ゴール
      completion_criteria: String, // 必須、完了条件
      company_id: Option<UUID>,   // 企業紐付け（NULL=全社共通）
  }
  ```

🟢 **教材紐付けデータ**
- **入力パラメータ**:
  ```rust
  struct TrainingMaterialParams {
      training_id: UUID,         // 研修ID
      material_id: UUID,         // 教材ID
      period_days: i32,          // 期間（日数、1-365）
      order_index: i32,          // 順序（1から開始）
  }
  ```

🟢 **出力値**
- **研修コース一覧**: JSON配列（ページネーション対応）
- **研修コース詳細**: 研修情報 + 紐付け教材リスト（期間・順序含む）
- **HTTP応答**: 200 OK（成功）、302 Found（作成後）、422 Unprocessable Entity（バリデーションエラー）

- **参照したEARS要件**: REQ-005（研修コース管理）、REQ-006（教材紐付け）
- **参照した設計文書**: データベーススキーマ（trainings, training_materials テーブル）

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

🟢 **セキュリティ要件**
- **認証**: セッションベース認証必須（全エンドポイント）
- **認可**: RBAC統合（admin/trainer/instructor 権限制御）
- **企業閲覧制御**: company_id による閲覧スコープ制限
- **CSRF保護**: フォーム送信時のCSRFトークン検証

🟢 **データベース制約**
- **外部キー制約**: training_materials → trainings/materials（CASCADE削除）
- **一意制約**: (training_id, material_id)、(training_id, order_index)
- **NOT NULL制約**: title, description, prerequisites, goals, completion_criteria

🟡 **パフォーマンス要件**
- **レスポンス時間**: 2秒以内（一覧表示）、3秒以内（詳細表示）
- **同時接続**: 100ユーザー対応
- **データ量**: 研修コース1000件、教材紐付け10000件まで対応

🟢 **アーキテクチャ制約**
- **MVC アーキテクチャ**: Controller-Model-View分離
- **既存統合**: materials.rsモデル活用、TASK-204パターン踏襲
- **レスポンシブUI**: タブレット・スマートフォン対応

- **参照したEARS要件**: NFR-102（セキュリティ）、REQ-103（RBAC）
- **参照した設計文書**: データベーススキーマ、セキュリティ要件

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

🟢 **基本的な使用パターン**
1. **研修コース作成フロー**:
   - 管理者/トレーナーがログイン → 研修コース作成画面表示 → 基本情報入力 → 教材選択・期間設定 → 保存
2. **教材紐付けフロー**:
   - 既存教材から検索・選択 → 期間（日数）設定 → 学習順序設定 → 紐付け保存
3. **企業制限フロー**:
   - 企業選択（全社共通 or 特定企業） → 権限に基づく閲覧制御適用

🟢 **正常ケース**
- 有効な研修コースデータでの作成成功
- 教材選択・期間設定・順序管理の正常動作
- 企業別閲覧制御の正確な動作

🟡 **エッジケース**
- **大量教材紐付け**: 50個以上の教材を1コースに紐付け
- **期間設定境界値**: 1日、365日の境界値設定
- **順序変更**: ドラッグ&ドロップによる大量順序変更

🟢 **エラーケース**
- **重複教材紐付け**: 同一教材の複数紐付け試行（一意制約違反）
- **存在しない教材選択**: 削除済み教材の選択試行
- **権限違反**: instructor による作成・編集試行
- **企業制限違反**: 他社研修への不正アクセス試行

- **参照したEARS要件**: REQ-012（企業制限）、REQ-104（教材紐付け）
- **参照した設計文書**: 一意制約定義、権限マトリックス

## 5. EARS要件・設計文書との対応関係

**参照したユーザストーリー**: 研修コース管理（TASK-205）
**参照した機能要件**: 
- REQ-005: 研修コース基本管理
- REQ-006: 教材紐付け機能
- REQ-012: 企業紐付け制御
- REQ-103: RBAC統合
- REQ-104: 期間設定機能
- REQ-105: 順序管理機能

**参照した非機能要件**: 
- NFR-102: セキュリティ要件
- NFR-201: UI/UX要件
- NFR-204: パフォーマンス要件

**参照したEdgeケース**: 
- 一意制約違反（重複教材紐付け）
- 境界値テスト（期間設定）
- 権限違反（不正アクセス）

**参照した設計文書**:
- **データベース**: trainings テーブル、training_materials テーブル
- **Model実装**: trainings.rs（284行、高完成度）、training_materials.rs（251行）
- **アーキテクチャ**: TASK-204成功パターン（セキュリティ強化済み）
- **API仕様**: RESTful エンドポイント設計

## 6. 技術実装詳細

### 6.1 既存実装活用戦略

🟢 **Model層完全活用**（高完成度実装済み）
- **`src/models/trainings.rs`**: 284行、包括的CRUD実装済み
- **`src/models/training_materials.rs`**: 251行、教材紐付け完全実装済み
- **データベーススキーマ**: 外部キー制約・インデックス・トリガー設定済み

🟢 **セキュリティパターン活用**（TASK-204成功事例）
- **SessionAuth**: セッションベース認証統合
- **RBAC統合**: 権限ベースアクセス制御
- **CSRF保護**: フォーム送信時の保護機能
- **XSS防止**: 入力値サニタイゼーション

### 6.2 新規実装要件

🟡 **Controller層実装**
```rust
// 新規作成必要ファイル
src/controllers/trainings.rs        // Training CRUD API
src/views/trainings/                 // HTML テンプレート群
tests/controllers/trainings.rs      // Controller テスト
```

🟡 **APIエンドポイント設計**
```
GET    /trainings                    # 研修コース一覧
GET    /trainings/new                # 研修コース作成フォーム
POST   /trainings                    # 研修コース作成
GET    /trainings/{id}               # 研修コース詳細
GET    /trainings/{id}/edit          # 研修コース編集フォーム
PUT    /trainings/{id}               # 研修コース更新
DELETE /trainings/{id}               # 研修コース削除
POST   /trainings/{id}/materials     # 教材紐付け
PUT    /trainings/{id}/materials/{material_id}  # 教材期間・順序更新
```

### 6.3 段階的実装戦略

🟢 **Phase 1: 基本CRUD機能**（最優先）
- TrainingController基本実装
- CRUD API（既存モデル活用）
- RBAC統合（既存パターン踏襲）

🟢 **Phase 2: 教材紐付け機能**（高優先）
- 教材選択・紐付けAPI
- 期間設定・順序管理機能
- 教材検索統合（TASK-204活用）

🟡 **Phase 3: 高度UI機能**（中優先）
- ドラッグ&ドロップ順序変更
- プレビュー機能
- HTMX部分更新

## 7. 品質保証要件

### 7.1 テスト要件

🟢 **必須テストケース**
- **正常系**: 研修コース CRUD 操作
- **異常系**: バリデーションエラー、権限違反
- **統合テスト**: 教材紐付け・期間設定・順序管理
- **エッジケース**: 境界値、一意制約違反

🟢 **セキュリティテスト**
- **認証テスト**: 未認証アクセス拒否
- **認可テスト**: 権限レベル別アクセス制御
- **企業制限テスト**: 閲覧スコープ制御
- **CSRF保護テスト**: トークン検証

### 7.2 パフォーマンステスト

🟡 **負荷テスト要件**
- **同時接続**: 100ユーザー
- **データ量**: 研修コース1000件
- **レスポンス**: 2秒以内

## 8. リスク分析・軽減策

### 8.1 技術的リスク

🟡 **UI複雑性リスク**: 教材選択・順序変更UIの実装複雑度
- **軽減策**: 段階的実装（基本機能 → 高度UI機能）

🟡 **パフォーマンスリスク**: 大量教材選択時の性能問題
- **軽減策**: ページネーション、非同期読み込み

🟢 **データ整合性リスク**: 研修-教材リレーションの一意制約管理
- **軽減策**: 既存高品質Model層の活用、データベース制約

### 8.2 推奨対策

🟢 **既存実装最大活用**: 85%完成済みModel層の活用
🟢 **成功パターン踏襲**: TASK-204セキュリティ強化パターン活用
🟢 **段階的開発**: Phase分けによるリスク分散

---

## 📋 要件品質判定

### ✅ **高品質** - 要件定義完了基準を満たす

**判定根拠**:
- **要件明確性**: 🟢 明確（既存タスク定義・データベーススキーマ明確）
- **入出力定義**: 🟢 完全（構造体定義・API仕様明確）
- **制約条件**: 🟢 明確（セキュリティ・DB制約・パフォーマンス明確）
- **実装可能性**: 🟢 確実（85%完成済みModel層・成功パターン活用可能）

**特筆すべき強み**:
- **既存実装活用**: Model層高完成度により実装リスク最小化
- **成功事例踏襲**: TASK-204パターン活用により品質保証
- **段階的戦略**: Phase分けによる確実な実装進行

---

**要件定義完了**: 2025-08-24  
**次のステップ**: `/tdd-testcases` でテストケースの洗い出しを行います。  
**推奨アプローチ**: Phase 1（基本CRUD）から段階的実装開始