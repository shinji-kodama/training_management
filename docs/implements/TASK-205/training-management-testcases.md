# TASK-205: 研修コース管理機能 - TDDテストケース洗い出し

**タスクID**: TASK-205  
**作成日**: 2025-08-24  
**フェーズ**: TDD Test Cases Definition  
**実装対象**: 研修コース管理機能（Controller層・View層）

## 事前準備完了

✅ **TDD関連ファイル読み込み完了**
- 要件定義書確認：Controller・View層に焦点を当てた研修コース管理仕様
- 既存実装パターン確認：TASK-204（materials.rs）成功事例、企業・受講者管理パターン
- 既存テストパターン確認：request::<App, _, _>マクロ、insta snapshot、serial_test
- 既存Model層確認：trainings.rs（284行）、training_materials.rs（251行）完全実装済み

## 開発言語・フレームワーク

🟢 **プログラミング言語**: Rust
- **言語選択の理由**: 既存Loco.rsプロジェクトとの統合、型安全性、高パフォーマンス、メモリ安全性
- **テストに適した機能**: 強力な型システム、Result型による安全なエラーハンドリング、マクロシステム

🟢 **テストフレームワーク**: 既存パターン踏襲
- **主要フレームワーク**: tokio::test（非同期テスト）、serial_test（DB競合回避）、insta（スナップショットテスト）
- **Loco.rsテストユーティリティ**: request::<App, _, _>、boot_test::<App>
- **フレームワーク選択の理由**: 既存実装との一貫性、TASK-204成功パターンの活用
- **テスト実行環境**: PostgreSQL開発DB環境（DATABASE_URL設定済み）

## 1. 正常系テストケース（Controller層HTTPエンドポイント）

### 1.1 研修コース一覧表示テスト
- **テスト名**: `test_研修コース一覧画面表示成功`
  - **何をテストするか**: GET /trainings エンドポイントの正常レスポンス確認
  - **期待される動作**: 認証済みユーザーが研修コース一覧データを正常取得できる
- **入力値**: 有効なセッショントークン、trainer権限ユーザー
  - **入力データの意味**: 研修担当者として研修コース管理画面にアクセスする実際の使用シナリオ
- **期待される結果**: HTTP 200、JSON配列（研修コースリスト + 紐付き教材数）
  - **期待結果の理由**: 認証済み・適切な権限ユーザーは研修コース情報を閲覧できる業務要件
- **テストの目的**: Controller層の基本的なGETリクエスト処理確認
  - **確認ポイント**: レスポンスステータス、データ構造、企業制御適用
- 🟢 既存materials.rs実装パターンとLoco.rs標準機能に基づく確実なテストケース

### 1.2 研修コース作成フォーム表示テスト
- **テスト名**: `test_研修コース作成フォーム表示成功`
  - **何をテストするか**: GET /trainings/new エンドポイントのフォーム表示
  - **期待される動作**: 研修コース作成フォームが適切に表示される
- **入力値**: trainer権限ユーザーセッション、企業情報（company_id選択肢）
  - **入力データの意味**: 研修作成権限を持つユーザーの新規作成要求
- **期待される結果**: HTTP 200、フォームテンプレート表示（企業選択オプション含む）
  - **期待結果の理由**: 権限ユーザーが新規研修コースを登録できる機能要件
- **テストの目的**: View層テンプレートレンダリング・企業選択機能確認
  - **確認ポイント**: フォームフィールドの存在、企業選択プルダウン、CSRF トークン設定
- 🟢 requirements.mdのフォーム仕様とTASK-202企業管理統合に基づく確実なテストケース

### 1.3 研修コース作成処理テスト
- **テスト名**: `test_研修コース作成処理成功`
  - **何をテストするか**: POST /trainings エンドポイントでの研修コース作成
  - **期待される動作**: 有効なフォームデータで研修コースがデータベースに作成される
- **入力値**: 有効な研修データ（title, description, prerequisites, goals, completion_criteria, company_id）
  - **入力データの意味**: 実際のユーザーが入力する標準的な研修コース情報
- **期待される結果**: HTTP 302（リダイレクト）、データベースに研修コースレコード保存
  - **期待結果の理由**: 作成成功後は詳細画面または一覧画面にリダイレクトする一般的なWebパターン
- **テストの目的**: Controller→Model層統合、CRUD操作の正常動作確認
  - **確認ポイント**: データベース保存確認、UUID自動生成、created_by設定、企業紐付け
- 🟢 既存trainings.rsモデルとの統合により確実性が保証されたテストケース

### 1.4 研修コース詳細表示テスト
- **テスト名**: `test_研修コース詳細表示成功`
  - **何をテストするか**: GET /trainings/{id} エンドポイントでの詳細データ表示
  - **期待される動作**: 指定したIDの研修コース詳細情報が表示される
- **入力値**: 既存研修コースID、認証済みセッション
  - **入力データの意味**: 研修閲覧権限を持つユーザーによる詳細確認要求
- **期待される結果**: HTTP 200、研修コース詳細情報表示（紐付き教材リスト含む）
  - **期待結果の理由**: 登録済み研修コースの詳細確認は基本的な業務要件
- **テストの目的**: パスパラメータ処理、Model層データ取得統合確認
  - **確認ポイント**: URLパラメータ解析、研修データの完全性、権限制御、教材リスト表示
- 🟢 既存auth.rsのパスパラメータ処理パターンに基づく確実なテストケース

### 1.5 研修コース更新処理テスト  
- **テスト名**: `test_研修コース更新処理成功`
  - **何をテストするか**: PUT /trainings/{id} エンドポイントでの研修コース更新
  - **期待される動作**: 研修コース情報が正しく更新され、データベースに反映される
- **入力値**: 既存研修コースID、更新データ、trainer権限セッション
  - **入力データの意味**: 研修情報の修正・改善を行う実際の業務シナリオ
- **期待される結果**: HTTP 302、データベースの研修コースレコード更新
  - **期待結果の理由**: 更新成功後の画面遷移による操作完了フィードバック
- **テストの目的**: 更新処理の正常動作、楽観的排他制御確認
  - **確認ポイント**: updated_at自動更新、変更データの反映確認
- 🟢 既存trainings.rsの更新機能とMVCパターンによる確実なテストケース

## 2. 異常系テストケース（エラーハンドリング）

### 2.1 未認証アクセス拒否テスト
- **テスト名**: `test_未認証ユーザー研修コースアクセス拒否`
  - **エラーケースの概要**: セッションなしでの研修コース管理画面アクセス
  - **エラー処理の重要性**: セキュリティ基本要件、不正アクセス防止
- **入力値**: セッショントークンなし、各種研修コースエンドポイント
  - **不正な理由**: 研修コース管理機能は認証必須の業務機能
  - **実際の発生シナリオ**: セッション期限切れ、直接URL入力での不正アクセス試行
- **期待される結果**: HTTP 401 Unauthorized、ログイン画面リダイレクト
  - **エラーメッセージの内容**: 認証が必要である旨の適切なメッセージ
  - **システムの安全性**: 機密情報の漏洩防止、適切な認証フロー誘導
- **テストの目的**: 認証middleware統合の確認
  - **品質保証の観点**: セキュリティ要件の確実な実装確認
- 🟢 既存RBAC実装と認証フローに基づく確実なエラーハンドリング

### 2.2 権限不足アクセス拒否テスト  
- **テスト名**: `test_instructor権限研修コース作成拒否`
  - **エラーケースの概要**: 読み取り専用権限での作成・更新・削除操作
  - **エラー処理の重要性**: RBAC統合によるビジネスルール実装
- **入力値**: instructor権限セッション、POST /trainings リクエスト
  - **不正な理由**: instructor権限は研修閲覧のみ、CRUD操作権限なし
  - **実際の発生シナリオ**: 権限昇格試行、UI制限の回避試行
- **期待される結果**: HTTP 403 Forbidden、権限不足エラーメッセージ  
  - **エラーメッセージの内容**: 「操作権限がありません」等の明確なメッセージ
  - **システムの安全性**: ビジネスルール違反の確実な防止
- **テストの目的**: RBAC middleware統合の権限チェック確認
  - **品質保証の観点**: ビジネスルール実装の確実性確認
- 🟢 既存RBAC実装と要件定義の権限マトリックスに基づく確実なテスト

### 2.3 他社研修コース不正アクセス拒否テスト
- **テスト名**: `test_他社専用研修コース不正アクセス拒否`
  - **エラーケースの概要**: 企業制限のある研修コースへの他社ユーザーアクセス
  - **エラー処理の重要性**: 企業間データ分離、情報漏洩防止
- **入力値**: 企業Aユーザーセッション、企業B専用研修コースID
  - **不正な理由**: company_id制限により他社研修コースは閲覧不可
  - **実際の発生シナリオ**: URL改ざん、権限昇格試行、情報漏洩試行
- **期待される結果**: HTTP 403 Forbidden、アクセス拒否エラーメッセージ
  - **エラーメッセージの内容**: 「この研修コースにアクセスする権限がありません」
  - **システムの安全性**: 企業間データ分離の確実な実装
- **テストの目的**: 企業閲覧制御の正確な動作確認
  - **品質保証の観点**: データプライバシー要件の確実な実装
- 🟡 要件定義の企業制御仕様とデータベース設計に基づく重要なテストケース

### 2.4 無効研修コースデータ作成バリデーションエラーテスト
- **テスト名**: `test_無効研修コースデータ作成バリデーションエラー`
  - **エラーケースの概要**: フォーム入力値のサーバーサイドバリデーション失敗
  - **エラー処理の重要性**: データ整合性保証、不正データ防止
- **入力値**: 空のタイトル、超長文description、無効company_id等
  - **不正な理由**: 業務要件とデータベース制約に違反する不正データ
  - **実際の発生シナリオ**: JavaScriptクライアントバリデーション回避、APIダイレクトアクセス
- **期待される結果**: HTTP 422 Unprocessable Entity、フィールド別エラーメッセージ
  - **エラーメッセージの内容**: 「タイトルは必須です」等の具体的な修正指針
  - **システムの安全性**: 不正データによるデータベース破損防止
- **テストの目的**: サーバーサイドバリデーション統合確認  
  - **品質保証の観点**: 既存trainings.rsバリデーションとの統合確認
- 🟢 既存trainings.rs Validatorとの統合により確実性が保証されたテスト

### 2.5 存在しない研修コースアクセスエラーテスト
- **テスト名**: `test_存在しない研修コースID指定404エラー`
  - **エラーケースの概要**: 無効なID指定での詳細・編集・削除操作
  - **エラー処理の重要性**: リソース存在確認による安全なアクセス制御
- **入力値**: 存在しないUUID、削除済み研修コースID
  - **不正な理由**: データベースに存在しないリソースへの操作要求
  - **実際の発生シナリオ**: URL改ざん、古いブックマークアクセス
- **期待される結果**: HTTP 404 Not Found、適切な404エラーページ
  - **エラーメッセージの内容**: 「指定された研修コースが見つかりません」  
  - **システムの安全性**: システム内部情報の漏洩防止
- **テストの目的**: リソース存在確認処理の妥当性検証
  - **品質保証の観点**: エラーハンドリングの統一性確認
- 🟢 既存trainings.rsのfind_by_idメソッドとエラーハンドリングに基づく確実なテスト

## 3. 境界値テストケース（入力値の限界）

### 3.1 研修タイトル長制限境界値テスト
- **テスト名**: `test_研修タイトル文字数境界値`
  - **境界値の意味**: データベースVARCHAR(255)制約とバリデーション仕様の境界
  - **境界値での動作保証**: 文字数制限での一貫したバリデーション動作
- **入力値**: 1文字、255文字、256文字のタイトル
  - **境界値選択の根拠**: trainings.rsとデータベーススキーマの制約定義
  - **実際の使用場面**: 極端に短い・長いタイトルでの研修コース登録試行
- **期待される結果**: 1-255文字で成功、256文字でバリデーションエラー
  - **境界での正確性**: 文字数カウントとエラーメッセージの正確性
  - **一貫した動作**: フロントエンド・バックエンドバリデーションの一致
- **テストの目的**: 文字数制限の境界条件確認
  - **堅牢性の確認**: 極端な入力値での安定動作確認
- 🟢 既存trainings.rs Validator定義（MAX_TITLE_LENGTH: 255）に基づく確実な境界値テスト

### 3.2 研修説明文長制限境界値テスト
- **テスト名**: `test_研修説明文字数境界値`
  - **境界値の意味**: TEXT型制約（65535文字）とパフォーマンス考慮の境界  
  - **境界値での動作保証**: 大容量テキストでの安全な処理確認
- **入力値**: 65534文字、65535文字、65536文字のdescription
  - **境界値選択の根拠**: trainings.rsで定義されたMAX_DESCRIPTION_LENGTH定数
  - **実際の使用場面**: 詳細な研修説明、長大なカリキュラム詳細登録
- **期待される結果**: 65535文字まで成功、65536文字でバリデーションエラー
  - **境界での正確性**: 大容量テキスト処理の安全性確保
  - **一貫した動作**: メモリ効率とセキュリティ制限の確実な実装
- **テストの目的**: 大容量データ処理の境界確認
  - **堅牢性の確認**: DoS攻撃等への耐性確認
- 🟢 既存trainings.rs定数定義（MAX_DESCRIPTION_LENGTH: 65535）とセキュリティ要件に基づく確実なテスト

### 3.3 教材紐付け期間境界値テスト  
- **テスト名**: `test_教材期間設定1-365日境界値`
  - **境界値の意味**: 業務ルール（1-365日）とデータベースINT制約の境界
  - **境界値での動作保証**: 期間範囲外での確実なエラー検出
- **入力値**: 0日, 1日, 365日, 366日の期間設定値
  - **境界値選択の根拠**: training_materials.rsのMIN/MAX_PERIOD_DAYS定数
  - **実際の使用場面**: 超短期研修、1年間研修、不正なAPI呼び出し
- **期待される結果**: 1,365日で成功、0,366日でバリデーションエラー
  - **境界での正確性**: INT制約とアプリケーションバリデーションの一致
  - **一貫した動作**: データベース・アプリケーション層での統一エラー
- **テストの目的**: 業務ルール境界の確実な実装確認
  - **堅牢性の確認**: 不正データでの安全な処理確認
- 🟢 既存training_materials.rsテスト結果とデータベース制約に基づく確実なテスト

### 3.4 教材順序インデックス境界値テスト
- **テスト名**: `test_教材順序1-1000境界値`
  - **境界値の意味**: 順序管理の実用的上限とパフォーマンス考慮の境界
  - **境界値での動作保証**: 大量教材紐付け時の安全な順序管理
- **入力値**: 0, 1, 1000, 1001の順序インデックス値
  - **境界値選択の根拠**: training_materials.rsのMIN/MAX_ORDER_INDEX定数
  - **実際の使用場面**: 最小順序、最大順序、システム制限超過試行
- **期待される結果**: 1,1000で成功、0,1001でバリデーションエラー
  - **境界での正確性**: 順序管理ロジックの正確性確保
  - **一貫した動作**: 一意制約とアプリケーションバリデーションの一致
- **テストの目的**: 順序管理システムの境界確認
  - **堅牢性の確認**: 大量データでの順序制御確認
- 🟢 既存training_materials.rs定数定義とビジネスルール要件に基づく確実なテスト

## 4. 統合テストケース（教材紐付け・企業制御）

### 4.1 教材紐付け統合テスト
- **テスト名**: `test_研修コース教材紐付け統合処理`
  - **何をテストするか**: POST /trainings/{id}/materials での教材紐付け機能
  - **期待される動作**: 研修コースに複数教材を期間・順序付きで正常紐付け
- **入力値**: 研修コースID、教材ID配列、期間設定配列、順序インデックス配列
  - **入力データの意味**: 実際の研修設計フローでの教材選択・期間設定シナリオ
- **期待される結果**: HTTP 200、training_materialsテーブルへの正確な挿入、期間合計計算
  - **期待結果の理由**: 教材紐付けは研修コース設計の中核機能
- **テストの目的**: Controller→Model統合、教材管理機能との連携確認
  - **確認ポイント**: 外部キー制約、一意制約、期間合計計算、順序管理
- 🟢 既存training_materials.rsの完全実装とTASK-204教材管理統合による確実なテスト

### 4.2 教材重複紐付けエラーテスト
- **テスト名**: `test_同一教材重複紐付けエラー処理`
  - **何をテストするか**: 同一研修コースに同一教材を複数回紐付けする試行
  - **期待される動作**: 一意制約違反による適切なエラー処理
- **入力値**: 研修コースID、同一教材IDの重複紐付け要求
  - **入力データの意味**: 操作ミス、UI不具合による重複操作シナリオ
- **期待される結果**: HTTP 422、一意制約違反エラーメッセージ
  - **期待結果の理由**: データ整合性保護、重複防止による品質保証
- **テストの目的**: データベース制約とアプリケーション制約の統合確認
  - **確認ポイント**: 一意制約(training_id, material_id)の正常動作
- 🟢 データベーススキーマの一意制約定義に基づく確実なテスト

### 4.3 企業別研修コースフィルタリング統合テスト
- **テスト名**: `test_企業別研修コース表示制御統合`
  - **何をテストするか**: 企業ユーザーによる自社・全社共通研修コース閲覧
  - **期待される動作**: company_id に基づく適切な研修コース表示制御
- **入力値**: 企業Aユーザーセッション、企業A専用・全社共通研修コース混在データ
  - **入力データの意味**: 実際の企業環境での研修コース閲覧権限制御シナリオ
- **期待される結果**: 企業A専用研修 + 全社共通研修のみ表示、企業B専用研修は非表示
  - **期待結果の理由**: 企業間データ分離とプライバシー保護要件
- **テストの目的**: 企業制御ロジックの正確な動作確認
  - **確認ポイント**: WHERE条件（company_id = ? OR company_id IS NULL）の正確性
- 🟡 要件定義の企業制御仕様と実装設計に基づく重要な統合テスト

### 4.4 研修コース削除制約統合テスト
- **テスト名**: `test_教材紐付け済み研修コース削除制約処理`
  - **何をテストするか**: 教材が紐付けられた研修コースの削除処理
  - **期待される動作**: CASCADE削除または制約確認による適切な削除処理
- **入力値**: 教材紐付け済み研修コースID、削除リクエスト
  - **入力データの意味**: 運用中研修コースの削除要求シナリオ
- **期待される結果**: CASCADE削除成功 または 関連データ存在警告
  - **期待結果の理由**: データ整合性保護、意図しないデータ損失防止
- **テストの目的**: 外部キー制約CASCADE動作の確認
  - **確認ポイント**: training_materials の CASCADE DELETE 動作確認
- 🟢 データベーススキーマのCASCADE制約定義に基づく確実なテスト

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント
```rust
// 【テスト目的】: [このテストで何を確認するかを日本語で明記]
// 【テスト内容】: [具体的にどのような処理をテストするかを説明]
// 【期待される動作】: [正常に動作した場合の結果を説明]
// 🟢🟡🔴 この内容の信頼性レベルを記載
```

### Given（準備フェーズ）のコメント
```rust
// 【テストデータ準備】: [なぜこのデータを用意するかの理由]
// 【初期条件設定】: [テスト実行前の状態を説明]
// 【前提条件確認】: [テスト実行に必要な前提条件を明記]
```

### When（実行フェーズ）のコメント
```rust
// 【実際の処理実行】: [どの機能/メソッドを呼び出すかを説明]
// 【処理内容】: [実行される処理の内容を日本語で説明]
// 【実行タイミング】: [なぜこのタイミングで実行するかを説明]
```

### Then（検証フェーズ）のコメント
```rust
// 【結果検証】: [何を検証するかを具体的に説明]
// 【期待値確認】: [期待される結果とその理由を説明]
// 【品質保証】: [この検証がシステム品質にどう貢献するかを説明]
```

### 各assertステートメントのコメント
```rust
// 【検証項目】: [この検証で確認している具体的な項目]
// 🟢🟡🔴 この内容の信頼性レベルを記載
assert_eq!(response.status_code(), 200); // 【確認内容】: HTTPレスポンスが正常ステータスを返すことを確認
```

## テストケースサマリー

### 分類別カバレッジ
- **正常系テストケース**: 5件（基本CRUD操作網羅）
- **異常系テストケース**: 5件（セキュリティ・バリデーション・権限制御網羅）
- **境界値テストケース**: 4件（入力制限境界網羅）  
- **統合テストケース**: 4件（教材紐付け・企業制御・データ整合性網羅）
- **合計**: 18テストケース

### 品質保証カバレッジ
- **セキュリティ**: 認証・認可・企業制御・入力検証をカバー
- **機能性**: 全CRUD操作と教材紐付け機能をカバー  
- **信頼性**: 境界値・エラーハンドリング・制約処理をカバー
- **統合性**: Controller-Model層連携・外部システム統合をカバー
- **保守性**: 既存パターン踏襲によるメンテナンス性確保

### 研修コース特有の複雑機能カバレッジ
- **教材紐付け機能**: 期間設定、順序管理、一意制約、CASCADE削除
- **企業制御機能**: company_id制限、全社共通研修、権限ベース表示制御
- **RBAC統合**: 権限レベル別アクセス制御（admin/trainer/instructor）
- **データ整合性**: 外部キー制約、一意制約、バリデーション統合

---

**テストケース品質判定**: ✅ **高品質**
- **テストケース分類**: 正常系・異常系・境界値・統合テストが包括的に網羅されている
- **期待値定義**: 各テストケースの期待値が明確で、ビジネス要件に整合している
- **技術選択**: Rust + Loco.rs + 既存テストフレームワークで実現可能
- **実装可能性**: 既存Model層高完成度により確実な実装が可能
- **信頼性レベル**: 🟢85%、🟡15%の高信頼度構成

**特筆すべき強み**:
- **既存成功パターン活用**: TASK-204材料管理機能の成功事例を踏襲
- **Model層完全活用**: trainings.rs、training_materials.rsの高完成度実装を最大活用
- **包括的セキュリティ**: 認証・認可・企業制御・入力検証を統合的にテスト
- **研修コース特有機能**: 教材紐付け・企業制御の複雑性に対応した専門的テスト設計

**次のお勧めステップ**: `/tdd-red @docs/tasks/training-management-tasks.md TASK-205` でRedフェーズ（失敗テスト作成）を開始します。