# TASK-202: 企業管理機能 - TDD要件定義書

**タスクID**: TASK-202  
**作成日**: 2025-08-23  
**フェーズ**: TDD Requirements Definition  
**実装対象**: 企業管理機能の完全実装

## 1. 要件概要

### 【主要機能】
企業情報の総合管理システムを実装し、以下の機能を提供する：

- **企業CRUD操作**: 企業の登録・参照・更新・削除機能
- **企業検索機能**: 名前・連絡先による企業検索
- **関連制約管理**: 受講者が存在する企業の削除制限
- **RBAC統合**: 役割ベースのアクセス制御統合
- **監査ログ**: 企業操作の完全な監査追跡

### 【既存実装状況】
- **85%実装済み**: 基本的な企業エンティティモデルと検索機能
- **必要な追加実装**: RBAC統合、削除制約ビジネスロジック、API層

## 2. 機能要件 (EARS形式)

### 【R-202-001】企業作成機能 🟢
**要件**: システムは、管理者が企業情報を作成した際に、企業データをデータベースに保存しなければならない。

**詳細条件**:
- 企業名、担当者名、連絡先メールは必須項目
- チャットリンクは任意項目
- UUID主キーの自動生成
- 作成日時・更新日時の自動設定
- 入力値検証（メール形式、文字数制限）

**RBAC要件**: Admin権限が必要

### 【R-202-002】企業参照機能 🟢
**要件**: システムは、認証済みユーザーが企業情報を参照した際に、権限に応じた企業データを返却しなければならない。

**詳細条件**:
- 全企業一覧取得（ページネーション対応）
- 企業ID指定での単体取得
- 企業名での部分一致検索
- 連絡先メールでの検索

**RBAC要件**: 全役割でアクセス可能

### 【R-202-003】企業更新機能 🟢
**要件**: システムは、管理者が企業情報を更新した際に、変更内容をデータベースに反映しなければならない。

**詳細条件**:
- 企業名、担当者名、連絡先メール、チャットリンクの更新
- updated_atの自動更新（データベーストリガー）
- 楽観的排他制御による競合状態の回避
- 更新前後の差分による監査ログ生成

**RBAC要件**: Admin権限が必要

### 【R-202-004】企業削除機能（制約付き） 🟢
**要件**: システムは、管理者が企業削除を実行した際に、関連データの整合性を確認してから削除処理を実行しなければならない。

**詳細条件**:
- **制約チェック**: 受講者が1人でも存在する場合は削除拒否
- **関連データ確認**: Projects, Trainingsテーブルの関連チェック
- **エラーレスポンス**: 削除不可理由の明確な提示
- **監査ログ**: 削除試行と結果の記録

**RBAC要件**: Admin権限が必要

### 【R-202-005】企業検索機能 🟢
**要件**: システムは、ユーザーが企業検索を実行した際に、検索条件に合致する企業一覧を返却しなければならない。

**詳細条件**:
- 企業名での部分一致検索
- 連絡先メールでの完全一致検索
- 複合条件検索（名前 + メール）
- ソート機能（作成日順、名前順）

**RBAC要件**: 全役割でアクセス可能

## 3. 技術要件

### 【データベース制約】
- **主キー**: UUID型（自動生成）
- **外部キー制約**: Students → Companies (RESTRICT)
- **インデックス**: name, contact_email
- **トリガー**: updated_at自動更新

### 【バリデーション要件】
```rust
struct CompanyValidator {
    name: String,           // 必須、1-200文字
    contact_person: String, // 必須、1-100文字  
    contact_email: String,  // 必須、有効なメール形式
    chat_link: Option<String>, // 任意、有効なURL形式
}
```

### 【エラーハンドリング】
- **422 Unprocessable Entity**: バリデーションエラー
- **403 Forbidden**: 権限不足
- **409 Conflict**: 削除制約違反
- **404 Not Found**: 企業が存在しない

## 4. テストケース設計

### 【TC-202-001】企業作成テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業作成機能正常() {
    // 管理者権限での企業作成が成功すること
    // UUID主キー、タイムスタンプが自動生成されること
}
```

### 【TC-202-002】企業バリデーションテスト 🟢
```rust
#[tokio::test]
#[serial] 
async fn test_企業バリデーションエラー() {
    // 必須項目未入力でエラーになること
    // 無効なメール形式でエラーになること
}
```

### 【TC-202-003】企業削除制約テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_受講者存在時企業削除拒否() {
    // 受講者が存在する企業の削除が拒否されること  
    // 適切なエラーメッセージが返却されること
}
```

### 【TC-202-004】RBAC統合テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業管理RBAC制御() {
    // Admin権限で企業作成・更新・削除が可能なこと
    // Trainer/Instructor権限で読み取り専用アクセスなこと
}
```

### 【TC-202-005】企業検索テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業検索機能() {
    // 企業名部分一致検索が正常動作すること
    // メール完全一致検索が正常動作すること
}
```

## 5. 実装対象ファイル

### 【必要な実装・修正】
```
src/models/companies.rs          # RBAC統合、削除制約ビジネスロジック
src/controllers/companies.rs    # 新規作成（API層）
tests/models/companies.rs       # テストケース追加
```

### 【既存ファイル状況】
- `src/models/companies.rs`: 85%実装済み（バリデーション、検索機能実装済み）
- `src/models/_entities/companies.rs`: 完全実装済み（SeaORM生成）
- Database Schema: 完全実装済み（制約・インデックス設定済み）

## 6. APIエンドポイント仕様

### 【企業管理API】
```
GET    /api/companies           # 企業一覧取得
GET    /api/companies/{id}      # 企業詳細取得  
POST   /api/companies           # 企業作成 [Admin]
PUT    /api/companies/{id}      # 企業更新 [Admin]
DELETE /api/companies/{id}      # 企業削除 [Admin]
GET    /api/companies/search    # 企業検索
```

## 7. 成功条件

### 【実装完了基準】
- [ ] 全テストケースが通過（5件）
- [ ] RBAC統合テストが成功
- [ ] 企業削除制約テストが成功  
- [ ] バリデーションテストが成功
- [ ] 監査ログ生成テストが成功

### 【品質基準】
- [ ] コードカバレッジ: 95%以上
- [ ] セキュリティレビュー: 合格
- [ ] パフォーマンステスト: 合格

## 8. リスク・注意事項

### 【技術的リスク】
- **データ整合性**: 企業削除時の関連データチェックの複雑性
- **パフォーマンス**: 大量企業データでの検索性能

### 【ビジネスリスク】
- **運用影響**: 企業削除制約による運用フローへの影響

## 9. 実装順序

1. **Phase 1**: 企業削除制約ビジネスロジック実装
2. **Phase 2**: RBAC統合実装  
3. **Phase 3**: API層（Controller）実装
4. **Phase 4**: テストケース実装・検証

---
**信頼性レベル説明**:
- 🟢 青信号: 既存実装・スキーマ・要件書から確実に確認できる仕様
- 🟡 黄信号: 推測だが高い確率で正しいと思われる仕様  
- 🔴 赤信号: 推測で確証がない仕様（実装時要確認）