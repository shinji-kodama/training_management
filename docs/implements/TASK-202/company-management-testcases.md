# TASK-202: 企業管理機能 - TDDテストケース設計書

**タスクID**: TASK-202  
**作成日**: 2025-08-23  
**フェーズ**: TDD Test Cases Design  
**テストケース総数**: 12件（正常系5件、異常系4件、境界値3件）

## 📋 テストケース概要

### 🎯 **テスト対象要件**
- **R-202-001**: 企業作成機能（Admin権限）
- **R-202-002**: 企業参照機能（全役割）
- **R-202-003**: 企業更新機能（Admin権限）
- **R-202-004**: 企業削除機能（制約付き・Admin権限）
- **R-202-005**: 企業検索機能（全役割）

### 🔧 **技術スタック**
- **言語**: Rust（型安全性・非同期処理対応）
- **フレームワーク**: tokio::test + serial_test + Loco.rs testing prelude
- **データベース**: PostgreSQL（テスト専用DB）
- **既存実装活用**: 85%実装済みベース + studentsテストパターン踏襲

---

## 1. 正常系テストケース（基本動作確認）

### 【TC-202-001】企業作成機能正常処理テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業作成機能正常() {
    // 【テスト目的】: 管理者権限での企業作成が正常に動作することを確認
    // 【テスト内容】: 有効な企業データでのActiveModel::insert()実行
    // 【期待される動作】: UUIDとタイムスタンプが自動生成され、データベースに正常保存される
    // 🟢 既存実装とスキーマ定義に基づく確実なテストケース
}
```

**入力データ**:
```rust
name: "テスト株式会社",
contact_person: "田中太郎", 
contact_email: "tanaka@test.co.jp",
chat_link: Some("https://chat.test.co.jp")
```

**期待結果**:
- 企業レコードがデータベースに正常保存
- UUID主キーの自動生成（`uuid::Uuid::nil()`ではない）
- `created_at`, `updated_at`のタイムスタンプ自動設定

### 【TC-202-002】企業参照機能正常処理テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業参照機能正常() {
    // 【テスト目的】: 全役割ユーザーによる企業データ参照機能の確認
    // 【テスト内容】: 企業ID指定での詳細取得、ページネーション付き一覧取得
    // 【期待される動作】: 正確な企業情報取得と適切なレスポンス返却
    // 🟢 既存のfind_by_email、find_by_nameメソッドで確認済み
}
```

**入力データ**:
- 企業ID指定での詳細取得
- ページネーション（page: 1, per_page: 10）

**期待結果**:
- 指定企業の詳細情報を正確に取得
- 一覧取得でページネーション情報を含む

### 【TC-202-003】企業更新機能正常処理テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業更新機能正常() {
    // 【テスト目的】: 管理者権限による企業データ更新機能の確認
    // 【テスト内容】: ActiveModel::update()による企業情報変更処理
    // 【期待される動作】: 変更内容のDB反映とupdated_at自動更新
    // 🟢 データベーストリガー仕様とSeaORM update動作で確実
}
```

**入力データ**:
```rust
name: "更新後株式会社",
contact_person: "佐藤花子",
contact_email: "sato@updated.co.jp", 
chat_link: None // チャットリンク削除
```

**期待結果**:
- 全フィールドが指定値で正常更新
- `updated_at`がトリガーで自動更新
- `created_at`は変更されない

### 【TC-202-004】企業削除機能正常処理テスト（受講者なし） 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業削除機能正常_受講者なし() {
    // 【テスト目的】: 削除制約に抵触しない企業の正常削除機能確認
    // 【テスト内容】: 受講者が存在しない企業のActiveModel::delete()実行
    // 【期待される動作】: データベースから企業レコードの安全な削除
    // 🟢 標準的なActiveModel::deleteパターン
}
```

**入力データ**: 受講者・プロジェクト・研修が紐付いていない企業ID

**期待結果**:
- 企業レコードがデータベースから正常削除
- 削除後の検索で該当企業が取得されない

### 【TC-202-005】企業検索機能正常処理テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業検索機能正常() {
    // 【テスト目的】: 企業名・メールアドレス検索機能の精度確認
    // 【テスト内容】: find_by_name（部分一致）、find_by_email（完全一致）実行
    // 【期待される動作】: 検索条件に合致する企業一覧の正確な返却
    // 🟢 既存実装のfind_by_name、find_by_emailメソッドで動作確認済み
}
```

**入力データ**:
- 企業名部分検索: "株式会社" → 複数企業該当
- メール完全検索: "exact@company.co.jp" → 1企業該当

**期待結果**:
- 企業名検索で部分一致する全企業を取得
- メール検索で完全一致する企業のみを取得

---

## 2. 異常系テストケース（エラーハンドリング）

### 【TC-202-006】企業作成バリデーションエラーテスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業作成バリデーションエラー() {
    // 【テスト目的】: 入力値バリデーション機能の確認
    // 【テスト内容】: 必須項目未入力、無効メール形式での作成試行
    // 【期待される動作】: バリデーションエラー発生とレコード作成失敗
    // 🟢 既存Validatorトレイト実装とvalidator crateの仕様に基づく
}
```

**入力データ**:
```rust
name: "",  // 空文字列（必須項目違反）
contact_person: "田中太郎",
contact_email: "invalid-email"  // 無効メール形式
```

**期待結果**:
- バリデーションエラーが発生しレコード作成失敗
- エラーメッセージに具体的な問題点を含む
- "name: 必須項目です", "contact_email: 有効なメールアドレスを入力してください"

### 【TC-202-007】RBAC権限不足エラーテスト 🟡
```rust
#[tokio::test]
#[serial]
async fn test_RBAC権限不足エラー() {
    // 【テスト目的】: RBAC権限制御の確認
    // 【テスト内容】: Trainer/Instructor権限でのAdmin専用操作試行
    // 【期待される動作】: HTTP 403エラー発生と操作拒否
    // 🟡 RBACシステムは実装済みだが企業管理への統合は推測部分
}
```

**入力データ**:
- ユーザー役割: "trainer" または "instructor"
- 操作: 企業作成・更新・削除の試行

**期待結果**:
- HTTP 403 Forbiddenエラーが発生
- 操作が実行されずデータが変更されない
- "この操作にはAdmin権限が必要です"

### 【TC-202-008】企業削除制約違反エラーテスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業削除制約違反エラー() {
    // 【テスト目的】: 企業削除制約ビジネスロジックの確認
    // 【テスト内容】: 受講者が存在する企業の削除試行
    // 【期待される動作】: 制約違反エラー発生と削除処理失敗
    // 🟢 データベーススキーマのRESTRICT制約で確実、ただしビジネスロジック層は要実装
}
```

**入力データ**: 1人以上の受講者が登録されている企業ID

**期待結果**:
- 削除処理が失敗し企業レコードが残存
- 制約違反の明確なエラーメッセージ表示
- "この企業には受講者が存在するため削除できません。先に受講者を削除してください。"

### 【TC-202-009】存在しない企業操作エラーテスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_存在しない企業操作エラー() {
    // 【テスト目的】: 存在しないリソース操作時のエラーハンドリング確認
    // 【テスト内容】: 存在しない企業IDでの参照・更新・削除試行
    // 【期待される動作】: HTTP 404エラー発生と適切なレスポンス返却
    // 🟢 標準的なORM動作パターンで確実
}
```

**入力データ**: 存在しないUUID（"00000000-0000-0000-0000-000000000000"）

**期待結果**:
- HTTP 404 Not Foundエラーが発生
- 処理が実行されず適切なエラーレスポンス返却
- "指定された企業が見つかりません"

---

## 3. 境界値テストケース（境界条件確認）

### 【TC-202-010】企業名文字数境界値テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_企業名文字数境界値() {
    // 【テスト目的】: 文字数制限バリデーションの境界値動作確認
    // 【テスト内容】: 企業名フィールドの1文字・255文字・0文字・256文字での処理
    // 【期待される動作】: 境界内での成功、境界外での適切なエラー発生
    // 🟢 validator crateの既定動作で確実
}
```

**入力データ**:
- 最小境界: `name: "A"` (1文字)
- 最大境界: `name: "A".repeat(255)` (255文字)  
- 境界外: `name: ""` (0文字), `name: "A".repeat(256)` (256文字)

**期待結果**:
- 1文字、255文字: バリデーション通過し作成成功
- 0文字、256文字: バリデーションエラーで作成失敗

### 【TC-202-011】メールアドレス形式境界値テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_メールアドレス形式境界値() {
    // 【テスト目的】: メールアドレス形式バリデーションの境界確認
    // 【テスト内容】: RFC5322準拠・非準拠メール形式での作成試行
    // 【期待される動作】: 有効形式での通過と無効形式での適切な拒否
    // 🟢 validator crateのemailバリデーション機能で確実
}
```

**入力データ**:
- 有効境界: `"a@b.co"`, `"test.email+tag@example.com"`
- 無効境界: `"invalid-email"`, `"@example.com"`, `"test@"`

**期待結果**:
- 有効形式: バリデーション通過し作成成功
- 無効形式: バリデーションエラーで作成失敗

### 【TC-202-012】チャットリンクURL形式境界値テスト 🟢
```rust
#[tokio::test]
#[serial]
async fn test_チャットリンクURL形式境界値() {
    // 【テスト目的】: 任意項目のURL形式バリデーション境界確認
    // 【テスト内容】: null値・有効URL・無効URLでの作成試行
    // 【期待される動作】: null許可とURL制約の両方を満たす動作
    // 🟢 validator crateのurl機能とOption<String>型の仕様で確実
}
```

**入力データ**:
- null値: `chat_link: None`
- 有効URL: `"https://chat.company.com"`, `"http://localhost:3000"`
- 無効URL: `"invalid-url"`, `"ftp://server.com"`

**期待結果**:
- None値: 正常にnullで作成成功
- 有効URL: バリデーション通過しURL保存
- 無効URL: バリデーションエラーで作成失敗

---

## 📝 実装時のコメント指針

### テストケース共通構造
```rust
#[tokio::test]
#[serial]
async fn test_機能名() {
    // 【テスト目的】: [このテストで確認したい具体的内容]
    // 【テスト内容】: [実行する処理の詳細]
    // 【期待される動作】: [正常動作時の結果]
    // 🟢🟡🔴 [信頼性レベルと根拠]
    
    // 【テスト前準備】: [環境初期化の理由と内容]
    // 【環境初期化】: [テスト環境の状態設定]
    let boot = boot_test::<App>().await.expect("Failed to boot test application");
    
    // 【テストデータ準備】: [使用するデータの意味と選択理由]
    // 【初期条件設定】: [テスト実行前の前提条件]
    
    // 【実際の処理実行】: [実行する機能/メソッドの説明]
    // 【処理内容】: [内部で行われる処理の詳細]
    // 【実行タイミング】: [なぜこのタイミングで実行するか]
    
    // 【結果検証】: [何を検証するかの具体的説明]
    // 【期待値確認】: [期待される結果とその理由]
    // 【品質保証】: [この検証がシステム品質にどう貢献するか]
    assert!(condition, "失敗時メッセージ"); // 【確認内容】: [検証項目の詳細] 🟢
}
```

---

## 🎯 テストケース実装優先度

### 【高優先度】（Phase 1: Red Phase実装対象）
1. **TC-202-001**: 企業作成機能正常処理（基本機能確認）
2. **TC-202-008**: 企業削除制約違反エラー（最重要ビジネスロジック）
3. **TC-202-006**: バリデーションエラー（データ品質保証）

### 【中優先度】（Phase 2: 機能完成度向上）
4. **TC-202-002**: 企業参照機能正常処理
5. **TC-202-003**: 企業更新機能正常処理
6. **TC-202-007**: RBAC権限不足エラー

### 【標準優先度】（Phase 3: 品質・堅牢性確保）
7. **TC-202-005**: 企業検索機能正常処理
8. **TC-202-009**: 存在しない企業操作エラー
9. **TC-202-010～012**: 境界値テスト（3件）

---

## 📊 品質指標

### **テストカバレッジ予測**
- **機能カバレッジ**: 100%（全5要件をカバー）
- **エラーケースカバレッジ**: 95%（主要エラーパターンを網羅）
- **境界値カバレッジ**: 100%（全バリデーション項目の境界確認）

### **実装成功確信度**
- **🟢 高確信（95%+）**: 9件（既存実装・スキーマベース）
- **🟡 中確信（85-95%）**: 3件（RBAC統合・ビジネスロジック）
- **🔴 低確信（<85%）**: 0件

---

**次フェーズ**: TDD Red Phase（失敗テスト実装）  
**推定実装時間**: 6-8時間（12テストケース + ビジネスロジック実装）  
**成功条件**: 12テストケース全通過 + 要件100%充足