# TASK-208 定例会管理機能 TDD要件定義書

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

### 🟢 **機能目的** 
研修プロジェクトにおける定期的な定例会（毎週・隔週）の効率的な管理を実現する機能

### 🟢 **解決する問題**
- 研修プロジェクトの進捗確認・報告会を定期的に実施するための定例会スケジュール管理
- 研修講師の任意参加設定による柔軟な参加者管理
- 面談管理機能との統合による包括的なスケジュール可視化

### 🟢 **想定ユーザー**
- **Admin**: 全プロジェクトの定例会管理・設定変更
- **Trainer**: 担当プロジェクトの定例会作成・管理
- **Instructor**: 任意参加可能な定例会への参加管理

### 🟢 **システム内位置づけ**
- TASK-206プロジェクト管理機能の延長として、プロジェクト運営の定期活動を管理
- TASK-207面談管理機能とカレンダー統合し、包括的なスケジュール表示を実現
- 既存meetings Modelを活用した高効率開発

### 🟢 **参照したEARS要件**: 
- REQ-009: 定例会基本機能
- REQ-014: 定例会関連機能  
- REQ-109: 定例会詳細要件
- REQ-203: 定例会運用要件

### 🟢 **参照した設計文書**: 
- meetings テーブルスキーマ（繰り返し制約・インデックス完備）

## 2. 入力・出力の仕様（EARS機能要件・データベーススキーマベース）

### 🟢 **入力パラメータ**

#### 定例会作成時
```rust
struct CreateMeetingParams {
    title: String,              // 必須、1-200文字
    project_id: Uuid,           // 必須、外部キー制約
    scheduled_at: NaiveDateTime, // 必須、未来日時
    instructor_id: Option<Uuid>, // 任意、研修講師ID
    recurrence_type: String,     // 'none'|'weekly'|'biweekly'
    recurrence_end_date: Option<NaiveDate>, // 繰り返し時必須
    description: Option<String>, // 任意、最大1000文字
    location: Option<String>,    // 任意、最大500文字
}
```

#### 🟢 **制約条件**
- プロジェクト参照整合性: project_id は既存プロジェクトを参照
- 日時制約: scheduled_at は現在時刻より未来
- 繰り返し制約: recurrence_type != 'none' の場合、recurrence_end_date 必須
- 企業スコープ制約: 作成者の企業内プロジェクトのみ作成可能

### 🟢 **出力値**

#### 定例会一覧
```rust
struct MeetingListResponse {
    meetings: Vec<MeetingInfo>,
    pagination: PaginationInfo,
    filters_applied: FilterInfo,
}

struct MeetingInfo {
    id: Uuid,
    title: String,
    project_name: String,
    scheduled_at: NaiveDateTime,
    recurrence_type: String,
    instructor_name: Option<String>,
    status: String, // 'scheduled'|'completed'|'cancelled'
}
```

#### 🟢 **データフロー**
1. **作成**: CreateParams → バリデーション → DB保存 → レスポンス
2. **一覧**: フィルタ → DB検索 → ページネーション → HTML/JSON
3. **繰り返し生成**: 設定値 → スケジュール計算 → 表示（実際の作成は手動）

### 🟢 **参照したEARS要件**: REQ-009（データ構造）, REQ-014（入出力仕様）
### 🟢 **参照した設計文書**: meetings テーブルスキーマ、外部キー制約4つ

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

### 🟢 **セキュリティ要件**
- **認証**: SessionAuth必須（全エンドポイント）
- **認可**: RBAC権限制御
  - Admin: 全プロジェクト定例会管理
  - Trainer: 担当プロジェクトのみ作成・編集
  - Instructor: 参加可能定例会の閲覧・任意参加設定
- **CSRF保護**: フォーム送信時のトークン検証
- **XSS防止**: Markdown記録・HTML出力のサニタイゼーション

### 🟢 **パフォーマンス要件**
- 定例会一覧表示: 2秒以内
- プロジェクト別フィルタリング: 1秒以内  
- 繰り返しスケジュール表示: 3秒以内（最大1年分）
- ページネーション: 100件/ページ制限

### 🟢 **データベース制約**
- PRIMARY KEY: id (UUID, 自動生成)
- FOREIGN KEY: project_id → projects.id
- FOREIGN KEY: instructor_id → users.id  
- FOREIGN KEY: created_by → users.id
- CHECK制約: recurrence_type IN ('none', 'weekly', 'biweekly')
- CHECK制約: 繰り返し設定時のrecurrence_end_date必須

### 🟡 **互換性要件**
- Loco.rs 0.16.3フレームワーク互換
- PostgreSQL 15+対応
- 既存meetings.rs Model完全活用

### 🟢 **参照したEARS要件**: NFR-101（セキュリティ）, NFR-102（パフォーマンス）
### 🟢 **参照した設計文書**: meetings テーブル制約定義、インデックス設定

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

### 🟢 **基本的な使用パターン**

#### シナリオ1: 毎週定例会の設定
```
1. Trainerがプロジェクト「Web開発研修」を選択
2. 毎週火曜日14:00-15:00の定例会を設定
3. 繰り返し終了日を3ヶ月後に設定
4. 研修講師を任意参加で選択
5. 作成完了、カレンダー表示で確認
```

#### シナリオ2: 隔週定例会の管理
```
1. Admin権限でプロジェクト横断表示
2. 隔週金曜日の全社定例会を設定
3. 複数プロジェクトからの参加者確認
4. 定例会記録をMarkdown形式で入力
```

### 🟢 **エッジケース**

#### 🟡 **繰り返し設定の境界値**
- 繰り返し終了日が開始日より前
- 繰り返し終了日が1年以上先
- 祝日・休日との重複
- 同時刻の他定例会・面談との重複

#### 🟡 **権限・アクセス制御**
- 他企業プロジェクトへのアクセス試行
- Instructor権限での作成操作試行
- セッション期限切れ時の操作続行

#### 🟢 **データ整合性エッジケース**
- 削除されたプロジェクトの定例会
- 無効な研修講師IDの指定
- 企業スコープ外プロジェクトへのアクセス

### 🟢 **エラーケース**
- 必須フィールド未入力エラー
- 日時形式不正エラー
- データベース制約違反エラー
- ネットワーク・タイムアウトエラー

### 🟢 **参照したEARS要件**: REQ-109（エッジケース）, REQ-203（エラー処理）

## 5. EARS要件・設計文書との対応関係

### 🟢 **参照した機能要件**
- **REQ-009**: 定例会CRUD基本機能
- **REQ-014**: 定例会詳細管理機能
- **REQ-109**: 定例会高度機能（繰り返し、任意参加）
- **REQ-203**: 定例会運用・記録管理

### 🟢 **参照した非機能要件**
- **NFR-101**: セキュリティ要件（SessionAuth + RBAC）
- **NFR-102**: パフォーマンス要件（応答速度、ページネーション）
- **NFR-103**: 可用性要件（データベース整合性）

### 🟢 **参照した設計文書**
- **データベーススキーマ**: meetings テーブル全構造
  - UUID主キー、外部キー制約4つ、CHECK制約2つ、インデックス4つ
- **既存Model実装**: meetings.rs（161行、バリデーション完備）
- **セキュリティパターン**: TASK-204/206/207成功事例

### 🟢 **既存実装活用度**
- **Model層**: 95%活用（meetings.rs既存実装）
- **Controller層**: 0%（新規実装、既存パターン踏襲）
- **Test層**: 50%活用（既存パターン + 新規テスト）
- **View層**: 30%活用（共通テンプレート + 定例会専用UI）

---

## 📋 実装方針サマリ

### ✅ **高効率実装が期待される理由**
1. **既存Model活用**: meetings.rs 95%完成（161行、バリデーション完備）
2. **成功パターン踏襲**: TASK-204/206/207のController実装パターン活用
3. **データベース基盤**: 制約・インデックス完備済み

### 🎯 **重点実装領域**
1. **Controller層新規実装**: meetings.rs → 5エンドポイント実装
2. **繰り返しスケジュール**: UI表示ロジック（DB制約活用）  
3. **カレンダー統合**: 面談管理機能との表示統合

### 📊 **品質・セキュリティ標準**
- SessionAuth + RBAC統合（既存パターン踏襲）
- CSRF + XSS防御完備
- エンタープライズグレード要件対応

**TDD準備完了率**: 95% - Model層基盤・セキュリティパターン確立済み