# TASK-207 面談管理機能 - TDD テストケース設計書

**作成日**: 2025-08-24  
**対象機能**: TASK-207 面談管理機能（Interview Management System）  
**TDDフェーズ**: Test Cases Design  
**設計者**: Claude Code  

## 📊 テストケース設計サマリー

**総テストケース数**: 16件  
**分類別内訳**: 正常系 5件、異常系 5件、境界値 4件、統合 2件  
**技術スタック**: Rust + 標準テストフレームワーク + SeaORM + Loco.rs  
**既存実装活用率**: 95%（Model層446行、既存テスト4件の基盤活用）  
**要件カバレッジ**: 100%（REQ-008,013,107,108,403 完全対応）

## 🎯 テストケース設計戦略

### 既存実装活用アプローチ 🟢
- **Model層基盤**: 既存446行の高品質実装とテスト4件を最大活用
- **パターン踏襲**: TASK-206セキュリティ・認証パターンの成功事例適用
- **段階実装**: Model拡張 → Controller新規 → 統合テスト の3段階アプローチ

### 技術的制約対応 🔴
- **型不整合問題**: interviewer_id（UUID vs i32）の解決必要
- **Controller層**: 完全新規実装（0%）のためテスト先行開発
- **統合複雑性**: SessionAuth + RBAC + CSRF の多層セキュリティ統合

## 📋 テストケース詳細仕様

### 1. 正常系テストケース（5件）

#### TC-N01: 面談の正常作成
**テスト目的**: 基本的な面談作成機能の動作確認  
**実装ファイル**: `tests/models/interviews.rs`（既存基盤拡張）  
**信頼性**: 🟢 既存Model実装とスキーマ定義に基づく高信頼性  

```rust
// 【テスト目的】: 面談予約の正常作成とデータベース保存機能の確認
// 【テスト内容】: 有効な入力値で面談を作成し、UUIDとタイムスタンプが適切に設定されることを確認
// 【期待される動作】: 面談レコードが正常に作成され、必要な値が自動生成される
#[tokio::test]
#[serial]
async fn test_面談の正常作成() {
    // テスト入力値
    project_participant_id: valid_uuid
    interviewer_id: 1 (trainer)
    scheduled_at: 明日の面談時刻
    status: "scheduled"
    notes: None
    
    // 期待結果
    - 面談レコード作成成功
    - UUID自動生成
    - created_at/updated_at自動設定
    - HTTP 201 Created
}
```

#### TC-N02: Markdown形式面談記録の保存
**テスト目的**: REQ-013 Markdown記録機能の確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟢 要件定義REQ-013に基づく高信頼性  

```rust
// 【テスト目的】: Markdown形式での面談記録保存と取得機能の確認
// 【テスト内容】: Markdown記法を含む記録が正確に保存・取得されることを確認
// 【期待される動作】: Markdownフォーマットが保持され、文字数制限内で正常保存
#[tokio::test]
#[serial]
async fn test_Markdown形式面談記録の保存() {
    // テスト入力値
    notes: "# 面談記録\n\n## 進捗\n- 項目1: 完了\n**次回目標**: プロジェクト完成"
    status: "completed"
    
    // 期待結果
    - Markdown記法の完全保持
    - 取得時のフォーマット一致
    - 10,000文字制限内での正常保存
}
```

#### TC-N03: 面談ステータス遷移（scheduled → completed）
**テスト目的**: ステータス管理機能の正常動作確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟢 既存Model実装パターンに基づく検証済み手法  

```rust
// 【テスト目的】: 面談ステータスの正常遷移処理確認
// 【テスト内容】: scheduled状態からcompleted状態への正常な遷移を確認
// 【期待される動作】: ステータス更新成功、updated_at自動更新、記録関連付け
#[tokio::test]
#[serial]
async fn test_面談ステータス遷移_scheduled_to_completed() {
    // テスト手順
    1. scheduled状態の面談作成
    2. completed状態への更新 + 記録追加
    3. 遷移結果の確認
    
    // 期待結果
    - ステータス更新成功
    - updated_at自動更新
    - 記録の正確な関連付け
}
```

#### TC-N04: プロジェクト参加者別面談一覧取得
**テスト目的**: フィルタリング機能の正確性確認  
**実装ファイル**: `tests/models/interviews.rs`（既存拡張）  
**信頼性**: 🟢 既存テスト`test_プロジェクト参加者別面談一覧取得`を参考  

```rust
// 【テスト目的】: 指定プロジェクト参加者の面談履歴一覧取得機能確認
// 【テスト内容】: 特定参加者に関する面談のみが適切にフィルタされて取得されることを確認
// 【期待される動作】: 対象参加者の面談のみ返却、他者面談の確実な除外
#[tokio::test]
#[serial]
async fn test_プロジェクト参加者別面談一覧取得_拡張() {
    // テストデータ: 対象者2件、他者1件の面談データ
    
    // 期待結果
    - 対象参加者の面談2件のみ取得
    - 他者面談の確実な除外
    - プライバシー保護の確認
}
```

#### TC-N05: 面談担当者別検索（期間指定）
**テスト目的**: 複合検索条件機能の正確性確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟡 Model層検索機能を基に設計した妥当な推測  

```rust
// 【テスト目的】: 面談担当者と期間を指定した面談検索機能確認
// 【テスト内容】: 特定トレーナーの指定期間内面談一覧の正確な取得を確認
// 【期待される動作】: 指定担当者の期間内面談のみが日時順で返される
#[tokio::test]
#[serial]
async fn test_面談担当者別検索_期間指定() {
    // 検索条件
    interviewer_id: 1
    date_from: "2024-01-01"
    date_to: "2024-01-31"
    
    // 期待結果
    - 該当期間の該当トレーナー面談のみ
    - 日時昇順ソート
    - 検索条件外データの除外
}
```

### 2. 異常系テストケース（5件）

#### TC-E01: 存在しないプロジェクト参加者による面談作成エラー
**テスト目的**: 外部キー制約によるデータ整合性保護確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟢 データベーススキーマの外部キー制約定義に基づく確実なテスト  

```rust
// 【テスト目的】: 無効なproject_participant_idでの面談作成拒否確認
// 【テスト内容】: 存在しないプロジェクト参加者IDで面談作成を試行し、適切に拒否されることを確認
// 【期待される動作】: 外部キー制約エラー、面談レコード作成失敗、データ整合性保護
#[tokio::test]
#[serial]
async fn test_存在しないプロジェクト参加者_面談作成エラー() {
    // 不正入力値
    project_participant_id: uuid::Uuid::new_v4() // 存在しないUUID
    
    // 期待結果
    - HTTP 422 Unprocessable Entity
    - 外部キー制約エラー
    - エラーメッセージ: "指定されたプロジェクト参加者が存在しません"
}
```

#### TC-E02: 過去日時での面談予約エラー
**テスト目的**: 日時制約バリデーション機能の確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟢 要件定義の制約条件「scheduled_atは現在時刻以降」に基づく  

```rust
// 【テスト目的】: 過去の日時での面談予約作成拒否確認
// 【テスト内容】: 現在時刻より前の日時で面談予約作成を試行し、適切に拒否されることを確認
// 【期待される動作】: バリデーションエラー、ビジネスロジック整合性保護
#[tokio::test]
#[serial]
async fn test_過去日時_面談予約エラー() {
    // 不正入力値
    scheduled_at: Utc::now() - Duration::hours(1) // 過去日時
    
    // 期待結果
    - HTTP 422 Unprocessable Entity
    - バリデーションエラー
    - エラーメッセージ: "面談日時は現在時刻以降を指定してください"
}
```

#### TC-E03: 面談記録文字数制限オーバーエラー
**テスト目的**: 文字数制限バリデーション機能の確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟢 要件定義REQ-013文字数制限に基づく確実なテスト  

```rust
// 【テスト目的】: 10,000文字を超える面談記録の保存拒否確認
// 【テスト内容】: 制限文字数を超過した記録の保存試行で適切に拒否されることを確認
// 【期待される動作】: 文字数制限エラー、システムリソース保護
#[tokio::test]
#[serial]
async fn test_面談記録_文字数制限オーバーエラー() {
    // 不正入力値
    notes: Some("あ".repeat(10001)) // 10,001文字
    
    // 期待結果
    - HTTP 422 Unprocessable Entity
    - 文字数制限エラー
    - エラーメッセージ: "面談記録は10,000文字以内で入力してください（現在: 10,001文字）"
}
```

#### TC-E04: 同一時間帯での重複面談予約エラー
**テスト目的**: スケジュール競合チェック機能の確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟢 Model実装のスケジュール競合チェック機能とREQ-403に基づく  

```rust
// 【テスト目的】: 同一面談担当者の同時刻重複予約の拒否確認
// 【テスト内容】: 1人のトレーナーが同時間に複数面談を予約する試行で適切に拒否されることを確認
// 【期待される動作】: スケジュール競合エラー、1対1面談制約保護
#[tokio::test]
#[serial]
async fn test_同一時間帯_重複面談予約エラー() {
    // 競合シナリオ
    既存面談: interviewer_id=1, scheduled_at="2024-01-15 14:00:00"
    新規面談: interviewer_id=1, scheduled_at="2024-01-15 14:30:00" // 30分後
    
    // 期待結果
    - HTTP 409 Conflict
    - スケジュール競合エラー
    - エラーメッセージ: "指定の時間帯に既に面談が予約されています"
}
```

#### TC-E05: 権限外面談アクセスエラー（instructor権限）
**テスト目的**: RBAC権限制御機能の確認  
**実装ファイル**: `tests/requests/interviews.rs`（新規作成）  
**信頼性**: 🟢 TASK-102 RBAC設計とTASK-206成功パターンに基づく  

```rust
// 【テスト目的】: instructor権限でのCUD操作拒否確認
// 【テスト内容】: 読み取り専用権限のinstructorが面談CUD操作を試行し、適切に拒否されることを確認
// 【期待される動作】: 権限エラー、RBAC制御の確実な実行
#[tokio::test]
#[serial]
async fn test_instructor権限_CUD操作拒否() {
    // 権限外操作試行
    ユーザー権限: instructor（読み取り専用）
    操作: POST /interviews（面談作成）
    
    // 期待結果
    - HTTP 403 Forbidden
    - 権限エラー
    - エラーメッセージ: "この操作を実行する権限がありません"
}
```

### 3. 境界値テストケース（4件）

#### TC-B01: 面談記録9,999文字（制限境界値-1）
**テスト目的**: 制限境界付近でのシステム安定性確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟢 要件定義REQ-013文字数制限10,000文字に基づく明確な境界値  

```rust
// 【テスト目的】: 文字数制限境界値での面談記録保存確認
// 【テスト内容】: 10,000文字制限の直下値でのシステム安定性と正確な処理を確認
// 【期待される動作】: 正常保存、レスポンス時間維持、メモリ使用量適正
#[tokio::test]
#[serial]
async fn test_面談記録_9999文字_境界値() {
    // 境界値入力
    notes: Some("あ".repeat(9999)) // 制限内最大級
    
    // 期待結果
    - 正常保存成功
    - レスポンス時間3秒以内
    - メモリ使用量適正
    - エラー発生なし
}
```

#### TC-B02: 面談記録10,000文字（制限境界値）
**テスト目的**: 制限値での正確な動作確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟢 要件定義の明確な制限値仕様に基づく  

```rust
// 【テスト目的】: 文字数制限上限値での面談記録保存確認
// 【テスト内容】: システム仕様で許可される最大文字数での処理成功を確認
// 【期待される動作】: 制限値での正常処理、オフバイワンエラーの防止
#[tokio::test]
#[serial]
async fn test_面談記録_10000文字_制限値() {
    // 制限値入力
    notes: Some("あ".repeat(10000)) // 制限値ちょうど
    
    // 期待結果
    - 正常保存成功
    - 制限値での適切な処理
    - 制限超過との明確な区別
    - 警告なし
}
```

#### TC-B03: 面談予定日時（現在時刻ちょうど）
**テスト目的**: 時刻境界値処理の正確性確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟡 時刻処理の複雑性を考慮した妥当な境界値テスト  

```rust
// 【テスト目的】: 現在時刻ちょうどでの面談予約作成確認
// 【テスト内容】: 「現在時刻以降」制約の下限境界での処理一貫性を確認
// 【期待される動作】: 時刻比較処理の正確性、マイクロ秒レベル精度確認
#[tokio::test]
#[serial]
async fn test_面談予定日時_現在時刻境界値() {
    // 境界値入力
    scheduled_at: Utc::now() // 現在時刻ちょうど
    
    // 期待結果
    - 正常作成または明確な拒否
    - 曖昧な動作なし
    - 時刻比較処理の正確性
    - タイムゾーン処理の適切性
}
```

#### TC-B04: 空の面談記録（null値）
**テスト目的**: Option型境界値処理の確認  
**実装ファイル**: `tests/models/interviews.rs`（新規追加）  
**信頼性**: 🟢 データベーススキーマとRustのOption型仕様に基づく確実なテスト  

```rust
// 【テスト目的】: 面談記録なしでの面談作成確認
// 【テスト内容】: Option型の下限値（null）での正常動作を確認
// 【期待される動作】: null値での正常動作、Option型の正確なハンドリング
#[tokio::test]
#[serial]
async fn test_面談記録_null値境界() {
    // null境界値
    notes: None // 記録なし
    status: "scheduled" // 予定状態（記録なしは正常）
    
    // 期待結果
    - 正常作成
    - notes列にNULL保存
    - 取得時にNone返却
    - null値エラーなし
}
```

### 4. 統合テストケース（2件）

#### TC-I01: 面談予約から記録完了までの完全フロー
**テスト目的**: システム全体の統合品質確認  
**実装ファイル**: `tests/requests/interviews_integration.rs`（新規作成）  
**信頼性**: 🟢 TASK-206パターンと実際の業務フローに基づく  

```rust
// 【テスト目的】: 面談管理の完全ワークフロー統合テスト
// 【テスト内容】: 予約作成から記録完了まで一連の処理の整合性を確認
// 【期待される動作】: 全段階で正常動作、データ一貫性維持、トランザクション管理
#[tokio::test]
#[serial]
async fn test_面談管理_完全ワークフロー統合() {
    // 統合フロー
    1. トレーナーログイン（SessionAuth）
    2. プロジェクト参加者選択
    3. 面談予約作成（scheduled状態）
    4. 面談実施後の記録入力
    5. ステータス更新（completed状態）
    6. 面談履歴確認
    
    // 期待結果
    - 全段階正常動作
    - データ一貫性維持
    - エラー時状態保護
    - 実用性確認
}
```

#### TC-I02: 権限別アクセス制御統合テスト
**テスト目的**: 権限制御システムの統合品質確認  
**実装ファイル**: `tests/requests/interviews_rbac.rs`（新規作成）  
**信頼性**: 🟢 TASK-102 RBAC設計とTASK-206成功事例に基づく  

```rust
// 【テスト目的】: 3つの権限レベルでの面談アクセス制御確認
// 【テスト内容】: admin/trainer/instructorの権限差異と制御の確実性を確認
// 【期待される動作】: 権限レベル別適切なアクセス制御、権限外操作の確実な拒否
#[tokio::test]
#[serial]
async fn test_面談_権限別アクセス制御統合() {
    // 権限テストシナリオ
    Admin: 全プロジェクト面談のCRUD可能
    Trainer: 担当プロジェクト面談のCRUD可能
    Instructor: 全プロジェクト面談の参照のみ可能
    
    // 期待結果
    - 権限レベル別適切な制御
    - 権限外操作の確実拒否
    - セキュリティ漏れなし
    - 適切なエラーメッセージ
}
```

## 🔧 実装技術仕様

### テストフレームワーク構成
- **言語**: Rust（型安全性、メモリ安全性、既存コード整合性）
- **テストフレームワーク**: 標準テストフレームワーク + SeaORM + Loco.rs統合
- **データベース**: PostgreSQL開発環境（DATABASE_URL設定）
- **並行制御**: `#[serial]`属性による排他実行
- **非同期処理**: `#[tokio::test]`による非同期テスト対応

### コメント記述標準
```rust
// 【テスト目的】: このテストで確認する具体的な機能・動作
// 【テスト内容】: 実際に実行するテスト処理の詳細説明
// 【期待される動作】: 正常に動作した場合の期待結果
// 🟢🟡🔴 信頼性レベル + 根拠説明

// 【テストデータ準備】: 必要なテストデータ作成の理由と内容
// 【初期条件設定】: テスト実行前の環境・状態設定
// 【前提条件確認】: 必要な前提条件の確認処理

// 【実際の処理実行】: テスト対象機能の実行
// 【処理内容】: 実行される処理の具体的内容
// 【実行タイミング】: この処理を実行するタイミングの理由

// 【結果検証】: テスト結果の検証内容
// 【期待値確認】: 期待される結果とその理由
// 【品質保証】: この検証がシステム品質に与える効果

// 【検証項目】: 個別検証項目の説明
// 🟢🟡🔴 この検証の信頼性レベル
```

## 📈 テストケース品質判定結果

### ✅ **高品質** - TDDテストケース設計完了基準を満たす

**判定根拠**:
- **テストケース分類**: ✅ 正常系(5)・異常系(5)・境界値(4)・統合(2) = 16テストケースで完全網羅
- **期待値定義**: ✅ 全テストケースで具体的な入力値・期待結果・検証ポイントが明確定義
- **技術選択**: ✅ Rust + 標準テストフレームワーク + SeaORM、既存技術スタックと完全整合
- **実装可能性**: ✅ 既存Model層95%活用、TASK-206成功パターン踏襲で確実に実現可能

**特筆すべき品質要素**:
- **既存実装活用度**: 95%（Model層446行の高品質実装、既存テスト4件の安定基盤）
- **要件カバレッジ**: 100%（REQ-008,013,107,108,403 全要件完全対応）
- **セキュリティ対応**: 100%（SessionAuth・RBAC・CSRF・XSS全対応）
- **エラーハンドリング**: 網羅的（5つの主要エラーケース + 4つの境界値ケース）
- **統合品質**: 実用的（実際の業務フロー + 権限制御の完全統合）

**実装推奨順序**:
1. **Phase1**: Model層テスト拡張（TC-N01〜N05, TC-E01〜E04, TC-B01〜B04）
2. **Phase2**: 型不整合解決 + Controller層テスト作成（TC-E05）
3. **Phase3**: 統合テスト実装（TC-I01, TC-I02）

---

**テストケース設計完了**: 2025-08-24  
**総合品質**: ✅ 高品質（16テストケース、100%要件網羅、95%既存活用）  
**次のステップ**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。