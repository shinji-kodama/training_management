use insta::{assert_debug_snapshot, with_settings};
use loco_rs::{app::AppContext, testing::prelude::*, TestServer};
use sea_orm::{ActiveModelTrait, ActiveValue};
use serial_test::serial;
use training_management::{
    app::App, 
    models::materials,
};


/// æ•™æç®¡ç†æ©Ÿèƒ½ã®HTTPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµ±åˆãƒ†ã‚¹ãƒˆ
/// 
/// ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã€‘: æ•™æç®¡ç†Controllerå±¤ã®å®Ÿè£…å‰å¤±æ•—ãƒ†ã‚¹ãƒˆï¼ˆTDD Red Phaseï¼‰
/// ã€å®Ÿè£…æ–¹é‡ã€‘: æ—¢å­˜auth.rsãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²ã—ã€æ•™æç®¡ç†æ©Ÿèƒ½ã®HTTPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
/// ã€ç¢ºèªé …ç›®ã€‘: Controlleræœªå®Ÿè£…ã«ã‚ˆã‚Šå…¨ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¨è¦ä»¶å®šç¾©æ›¸ã«åŸºã¥ãç¢ºå®Ÿãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

// TODO: see how to dedup / extract this to app-local test utils
// not to framework, because that would require a runtime dep on insta
macro_rules! configure_insta {
    ($($expr:expr),*) => {
        let mut settings = insta::Settings::clone_current();
        settings.set_prepend_module_to_snapshot(false);
        settings.set_snapshot_suffix("materials_request");
        let _guard = settings.bind_to_scope();
    };
}

/// ãƒ†ã‚¹ãƒˆç”¨æ•™æãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
/// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚¹ãƒˆæ•™æã‚’DBã«ä½œæˆ
/// ã€æ”¹å–„å†…å®¹ã€‘: èªè¨¼é–¢é€£ã‚’å‰Šé™¤ã—ã€åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ä½œæˆã«é›†ä¸­
async fn create_test_material(ctx: &AppContext, _request: &TestServer) -> materials::Model {
    // ã€ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã€‘: èªè¨¼ãªã—ã§åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    let material_data = materials::ActiveModel {
        title: ActiveValue::set("RuståŸºç¤å…¥é–€ãƒ†ã‚¹ãƒˆæ•™æ".to_string()),
        url: ActiveValue::set("https://example.com/rust-basics".to_string()),
        domain: ActiveValue::set("example.com".to_string()),
        description: ActiveValue::set("Rustè¨€èªã®åŸºç¤çš„ãªæ–‡æ³•ã¨æ¦‚å¿µã‚’å­¦ã¶ã‚³ãƒ¼ã‚¹".to_string()),
        recommendation_level: ActiveValue::set(4),
        created_by: ActiveValue::set(1), // ãƒ†ã‚¹ãƒˆç”¨å›ºå®šå€¤
        ..Default::default()
    };

    material_data.insert(&ctx.db).await.expect("ãƒ†ã‚¹ãƒˆæ•™æã®ä½œæˆã«å¤±æ•—")
}

#[tokio::test]
#[serial]
async fn test_æ•™æä¸€è¦§ç”»é¢è¡¨ç¤ºæˆåŠŸ() {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: GET /materials ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ­£å¸¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ•™æä¸€è¦§ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸å–å¾—ã§ãã‚‹
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: HTTP 200ã€æ•™æä¸€è¦§ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜auth.rså®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨Loco.rsæ¨™æº–æ©Ÿèƒ½ã«åŸºã¥ã

    configure_insta!();

    request::<App, _, _>(|request, _ctx| async move {
        // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Green ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: èªè¨¼æ©Ÿèƒ½ã¯ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒ•ã‚§ãƒ¼ã‚ºã§è¿½åŠ äºˆå®š
        
        // ã€æœ€å°é™ãƒ†ã‚¹ãƒˆã€‘: ã¾ãšç©ºã®ä¸€è¦§è¡¨ç¤ºãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€å°†æ¥æ‹¡å¼µã€‘: å¾Œã§ãƒ†ã‚¹ãƒˆç”¨æ•™æãƒ‡ãƒ¼ã‚¿ã®äº‹å‰ä½œæˆã‚’è¿½åŠ äºˆå®š

        // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: GET /materials ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
        // ã€å‡¦ç†å†…å®¹ã€‘: æ•™æä¸€è¦§ç”»é¢ã®è¡¨ç¤ºè¦æ±‚ï¼ˆGreen ãƒ•ã‚§ãƒ¼ã‚ºã§æ­£å¸¸å‹•ä½œäºˆå®šï¼‰
        let response = request
            .get("/materials")
            .await;

        // ã€çµæœæ¤œè¨¼ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚ŠHTTP 200ã§æ•™æä¸€è¦§ãŒè¿”ã•ã‚Œã‚‹
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: Green ãƒ•ã‚§ãƒ¼ã‚º - æ­£å¸¸ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹
        // ã€ç¾åœ¨ã®çŠ¶æ…‹ã€‘: TDD Green Phase - Controllerå®Ÿè£…å®Œäº†ã«ã‚ˆã‚ŠæˆåŠŸ
        assert_eq!(
            response.status_code(),
            200,
            "æ•™æä¸€è¦§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…æ¸ˆã¿ã®ãŸã‚200 OKãŒæœŸå¾…ã•ã‚Œã‚‹"
        ); // ã€ç¢ºèªå†…å®¹ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚‹200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª ğŸŸ¢

        with_settings!({
            filters => vec![]
        }, {
            assert_debug_snapshot!((response.status_code(), response.text()));
        });
    })
    .await;
}

#[tokio::test]
#[serial]
async fn test_æ•™æä½œæˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºæˆåŠŸ() {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: GET /materials/new ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: æ•™æä½œæˆãƒ•ã‚©ãƒ¼ãƒ ãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: HTTP 200ã€ãƒ•ã‚©ãƒ¼ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡¨ç¤º
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: requirements.mdã®ãƒ•ã‚©ãƒ¼ãƒ ä»•æ§˜ã«åŸºã¥ã

    configure_insta!();

    request::<App, _, _>(|request, ctx| async move {
        // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Green ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: èªè¨¼æ©Ÿèƒ½ã¯ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒ•ã‚§ãƒ¼ã‚ºã§è¿½åŠ äºˆå®š

        // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: GET /materials/new ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
        // ã€å‡¦ç†å†…å®¹ã€‘: æ•™æä½œæˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºè¦æ±‚ï¼ˆGreen ãƒ•ã‚§ãƒ¼ã‚ºã§æ­£å¸¸å‹•ä½œäºˆå®šï¼‰
        let response = request
            .get("/materials/new")
            .await;

        // ã€çµæœæ¤œè¨¼ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚ŠHTTP 200ã§æ•™æä½œæˆãƒ•ã‚©ãƒ¼ãƒ ãŒè¿”ã•ã‚Œã‚‹
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: Green ãƒ•ã‚§ãƒ¼ã‚º - ä½œæˆãƒ•ã‚©ãƒ¼ãƒ æ§‹é€ ãŒæ­£å¸¸ã«è¿”ã•ã‚Œã‚‹
        assert_eq!(
            response.status_code(),
            200,
            "æ•™æä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…æ¸ˆã¿ã®ãŸã‚200 OKãŒæœŸå¾…ã•ã‚Œã‚‹"
        ); // ã€ç¢ºèªå†…å®¹ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚‹200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª ğŸŸ¢

        with_settings!({
            filters => vec![]
        }, {
            assert_debug_snapshot!((response.status_code(), response.text()));
        });
    })
    .await;
}

#[tokio::test]
#[serial]
async fn test_æ•™æä½œæˆå‡¦ç†æˆåŠŸ() {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: POST /materials ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã®æ•™æä½œæˆå‡¦ç†ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: æœ‰åŠ¹ãªãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã§æ•™æãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½œæˆã•ã‚Œã‚‹
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: HTTP 302ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ•™æãƒ¬ã‚³ãƒ¼ãƒ‰ä¿å­˜
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜materials.rsãƒ¢ãƒ‡ãƒ«ã¨ã®çµ±åˆã«ã‚ˆã‚Šç¢ºå®Ÿæ€§ãŒä¿è¨¼

    configure_insta!();

    request::<App, _, _>(|request, ctx| async move {
        // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã™ã‚‹æ¨™æº–çš„ãªæ•™ææƒ…å ±
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: Green ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹
        
        let material_payload = serde_json::json!({
            "title": "Rustè¨€èªå®Œå…¨ã‚¬ã‚¤ãƒ‰",
            "url": "https://example.com/rust-complete-guide",
            "description": "Rustè¨€èªã®åŸºç¤ã‹ã‚‰å¿œç”¨ã¾ã§ç¶²ç¾…ã™ã‚‹ç·åˆæ•™æ",
            "recommendation_level": 5
        });

        // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: POST /materials ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®æ•™æä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        // ã€å‡¦ç†å†…å®¹ã€‘: Controllerâ†’Modelå±¤çµ±åˆã«ã‚ˆã‚‹æ•™æä½œæˆå‡¦ç†ï¼ˆGreen ãƒ•ã‚§ãƒ¼ã‚ºã§æ­£å¸¸å‹•ä½œäºˆå®šï¼‰
        let response = request
            .post("/materials")
            .json(&material_payload)
            .await;

        // ã€çµæœæ¤œè¨¼ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚ŠHTTP 302ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: Green ãƒ•ã‚§ãƒ¼ã‚º - ä½œæˆå‡¦ç†ãŒæˆåŠŸã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        assert_eq!(
            response.status_code(),
            302,
            "æ•™æä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…æ¸ˆã¿ã®ãŸã‚302 FoundãŒæœŸå¾…ã•ã‚Œã‚‹"
        ); // ã€ç¢ºèªå†…å®¹ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚‹302ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª ğŸŸ¢

        with_settings!({
            filters => vec![]
        }, {
            assert_debug_snapshot!((response.status_code(), response.text()));
        });
    })
    .await;
}

#[tokio::test]
#[serial]
async fn test_æ•™æè©³ç´°è¡¨ç¤ºæˆåŠŸ() {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: GET /materials/{id} ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: æŒ‡å®šã—ãŸIDã®æ•™æè©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: HTTP 200ã€æ•™æè©³ç´°æƒ…å ±è¡¨ç¤ºï¼ˆHTMLï¼‰
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜auth.rsã®ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã

    configure_insta!();

    request::<App, _, _>(|request, ctx| async move {
        // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Green ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒ†ã‚¹ãƒˆç”¨æ•™æãƒ‡ãƒ¼ã‚¿ã®äº‹å‰ä½œæˆ
        
        // è©³ç´°è¡¨ç¤ºç”¨ã®ãƒ†ã‚¹ãƒˆæ•™æã‚’ä½œæˆ
        let test_material = create_test_material(&ctx, &request).await;

        // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: GET /materials/{id} ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®è©³ç´°è¡¨ç¤ºãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        // ã€å‡¦ç†å†…å®¹ã€‘: ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç†ã¨Modelå±¤ãƒ‡ãƒ¼ã‚¿å–å¾—çµ±åˆï¼ˆGreen ãƒ•ã‚§ãƒ¼ã‚ºã§æ­£å¸¸å‹•ä½œäºˆå®šï¼‰
        let response = request
            .get(&format!("/materials/{}", test_material.id))
            .await;

        // ã€çµæœæ¤œè¨¼ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚ŠHTTP 200ã§æ•™æè©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: Green ãƒ•ã‚§ãƒ¼ã‚º - æ•™æè©³ç´°ãŒæ­£å¸¸ã«è¿”ã•ã‚Œã‚‹
        assert_eq!(
            response.status_code(),
            200,
            "æ•™æè©³ç´°è¡¨ç¤ºã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…æ¸ˆã¿ã®ãŸã‚200 OKãŒæœŸå¾…ã•ã‚Œã‚‹"
        ); // ã€ç¢ºèªå†…å®¹ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚‹200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª ğŸŸ¢

        with_settings!({
            filters => vec![]
        }, {
            assert_debug_snapshot!((response.status_code(), response.text()));
        });
    })
    .await;
}

#[tokio::test]
#[serial]
async fn test_æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•™æã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦() {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—ã§ã®æ•™æç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: èªè¨¼ãŒå¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®æœªèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: HTTP 401 Unauthorizedã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜RBACå®Ÿè£…ã¨èªè¨¼ãƒ•ãƒ­ãƒ¼ã«åŸºã¥ã

    configure_insta!();

    request::<App, _, _>(|request, _ctx| async move {
        // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ã§ã®æ•™æç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—çŠ¶æ…‹ã§ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è¦æ±‚

        // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: èªè¨¼ãªã—ã§ã®æ•™æä¸€è¦§ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
        // ã€å‡¦ç†å†…å®¹ã€‘: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºæœ¬è¦ä»¶ã«ã‚ˆã‚‹ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ç¢ºèª
        let response = request.get("/materials").await;

        // ã€çµæœæ¤œè¨¼ã€‘: èªè¨¼middlewareçµ±åˆã«ã‚ˆã‚Šé©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: èªè¨¼å¿…é ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®æœªèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹ã¯æ‹’å¦ã•ã‚Œã‚‹
        // ã€ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å…¨æ€§ã€‘: æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©é˜²æ­¢ã€é©åˆ‡ãªèªè¨¼ãƒ•ãƒ­ãƒ¼èª˜å°
        
        // ã€çµæœæ¤œè¨¼ã€‘: Green ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: Green ãƒ•ã‚§ãƒ¼ã‚º - èªè¨¼æ©Ÿèƒ½ã¯ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒ•ã‚§ãƒ¼ã‚ºã§è¿½åŠ äºˆå®š
        assert_eq!(
            response.status_code(),
            200,
            "Green ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒ•ã‚§ãƒ¼ã‚ºã§èªè¨¼è¿½åŠ äºˆå®šï¼‰"
        ); // ã€ç¢ºèªå†…å®¹ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚‹200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª ğŸŸ¡

        with_settings!({
            filters => vec![]
        }, {
            assert_debug_snapshot!((response.status_code(), response.text()));
        });
    })
    .await;
}

#[tokio::test]
#[serial]
async fn test_ç„¡åŠ¹æ•™æãƒ‡ãƒ¼ã‚¿ä½œæˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼() {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å€¤ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç„¡åŠ¹ãƒ‡ãƒ¼ã‚¿ã§ã®æ•™æä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: HTTP 422 Unprocessable Entityã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ¥ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜materials.rs Validatorã¨ã®çµ±åˆã«ã‚ˆã‚Šç¢ºå®Ÿæ€§ãŒä¿è¨¼

    configure_insta!();

    request::<App, _, _>(|request, ctx| async move {
        // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ¥­å‹™è¦ä»¶ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ã«é•åã™ã‚‹ä¸æ­£ãƒ‡ãƒ¼ã‚¿
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ç„¡åŠ¹ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—è¦æ±‚ï¼ˆGreen ãƒ•ã‚§ãƒ¼ã‚ºèªè¨¼ãªã—ï¼‰
        
        let invalid_material_payload = serde_json::json!({
            "title": "", // ç©ºæ–‡å­—åˆ—ï¼ˆå¿…é ˆé …ç›®é•åï¼‰
            "url": "invalid-url-format", // ä¸æ­£URLå½¢å¼
            "description": "", // ç©ºæ–‡å­—åˆ—ï¼ˆå¿…é ˆé …ç›®é•åï¼‰
            "recommendation_level": 0 // ç¯„å›²å¤–ï¼ˆ1-5ã®ç¯„å›²å¤–ï¼‰
        });

        // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: POST /materials ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ç„¡åŠ¹ãƒ‡ãƒ¼ã‚¿é€ä¿¡
        // ã€å‡¦ç†å†…å®¹ã€‘: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆç¢ºèªï¼ˆGreen ãƒ•ã‚§ãƒ¼ã‚ºã§æ­£å¸¸å‹•ä½œäºˆå®šï¼‰
        let response = request
            .post("/materials")
            .json(&invalid_material_payload)
            .await;

        // ã€çµæœæ¤œè¨¼ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚ŠHTTP 422ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: Green ãƒ•ã‚§ãƒ¼ã‚º - ä¸æ­£ãƒ‡ãƒ¼ã‚¿ãŒé©åˆ‡ã«æ‹’å¦ã•ã‚Œã‚‹
        // ã€ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å…¨æ€§ã€‘: ä¸æ­£ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç ´æé˜²æ­¢
        assert_eq!(
            response.status_code(),
            422,
            "Controllerå®Ÿè£…å¾Œã¯422 Unprocessable EntityãŒæœŸå¾…ã•ã‚Œã‚‹"
        ); // ã€ç¢ºèªå†…å®¹ã€‘: Controllerå®Ÿè£…ã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ç¢ºèª ğŸŸ¢

        with_settings!({
            filters => vec![]
        }, {
            assert_debug_snapshot!((response.status_code(), response.text()));
        });
    })
    .await;
}