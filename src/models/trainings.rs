/**
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ç ”ä¿®ã‚³ãƒ¼ã‚¹ï¼ˆTrainingsï¼‰ãƒ¢ãƒ‡ãƒ«ã®åŒ…æ‹¬çš„å®Ÿè£…
 * ã€æ”¹å–„å†…å®¹ã€‘: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€ã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Š
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¼æ¥­ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã€åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã€ä¿å®ˆæ€§ã®å‘ä¸Š
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ã¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã‚’è€ƒæ…®ã—ãŸå®Ÿè£…
 * ã€ä¿å®ˆæ€§ã€‘: å¼·åŒ–ã•ã‚ŒãŸæ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆã¨ä¸€è²«ã—ãŸå‘½åè¦å‰‡
 * ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: DoSæ”»æ’ƒå¯¾ç­–ã€å…¥åŠ›æ¤œè¨¼å¼·åŒ–ã€ãƒ¡ãƒ¢ãƒªåŠ¹ç‡æœ€é©åŒ–
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®åˆ¶ç´„å®šç¾©ã¨TDDå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã
 */

use loco_rs::prelude::*;
use serde::Deserialize;
use sea_orm::{QueryOrder, QuerySelect};

pub use super::_entities::trainings::{self, ActiveModel, Entity, Model};

/// ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®šæ•°å®šç¾©ã€‘: ç ”ä¿®ã‚³ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®åˆ¶ç´„å€¤ç®¡ç†ã¨DoSæ”»æ’ƒå¯¾ç­–
/// ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€‘: å¤§å®¹é‡å…¥åŠ›ã«ã‚ˆã‚‹æ”»æ’ƒé˜²æ­¢ã¨é©åˆ‡ãªãƒªã‚½ãƒ¼ã‚¹ç®¡ç†
/// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã¨å‡¦ç†é€Ÿåº¦ã®æœ€é©åŒ–
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®åˆ¶ç´„ã¨ä¸€è‡´
const MAX_TITLE_LENGTH: usize = 255;
const MAX_DESCRIPTION_LENGTH: usize = 65535; // TEXTå‹ã®å®Ÿç”¨çš„ä¸Šé™
const MAX_PREREQUISITES_LENGTH: usize = 10000; // é•·æ–‡å¯¾å¿œ
const MAX_GOALS_LENGTH: usize = 10000; // é•·æ–‡å¯¾å¿œ
const MAX_COMPLETION_CRITERIA_LENGTH: usize = 10000; // é•·æ–‡å¯¾å¿œ
const MIN_FIELD_LENGTH: usize = 1;
const MAX_PAGE_SIZE: u32 = 100; // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ä¸Šé™å€¤

/**
 * ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ ä½“ã€‘: ç ”ä¿®ã‚³ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ›å€¤æ¤œè¨¼
 * ã€å®Ÿè£…æ–¹é‡ã€‘: ãƒ†ã‚¹ãƒˆã§è¦æ±‚ã•ã‚Œã‚‹æœ€å°é™ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…
 * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ–‡å­—æ•°åˆ¶é™ã¨ç©ºå€¤ãƒã‚§ãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆ
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®åˆ¶ç´„å®šç¾©ã«åŸºã¥ã
 */
/// ã€å¼·åŒ–ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ ä½“ã€‘: ç ”ä¿®ã‚³ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®åŒ…æ‹¬çš„å…¥åŠ›æ¤œè¨¼
/// ã€æ”¹å–„å†…å®¹ã€‘: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€DoSæ”»æ’ƒå¯¾ç­–ã€è©³ç´°ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
/// ã€è¨­è¨ˆæ–¹é‡ã€‘: ç”¨é€”åˆ¥æœ€é©åŒ–ã•ã‚ŒãŸæ–‡å­—æ•°åˆ¶é™ã¨å®Ÿç”¨çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®åˆ¶ç´„å®šç¾©ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«åŸºã¥ã
#[derive(Debug, Validate, Deserialize)]
pub struct Validator {
    /// ã€ã‚¿ã‚¤ãƒˆãƒ«æ¤œè¨¼ã€‘: ç ”ä¿®ã‚³ãƒ¼ã‚¹åã®é•·ã•ã¨å¿…é ˆæ€§ãƒã‚§ãƒƒã‚¯
    #[validate(length(
        min = 1, 
        max = 255, 
        message = "ç ”ä¿®ã‚¿ã‚¤ãƒˆãƒ«ã¯1æ–‡å­—ä»¥ä¸Š255æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚DoSæ”»æ’ƒå¯¾ç­–ã®ãŸã‚ä¸Šé™å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚"
    ))]
    pub title: String,
    
    /// ã€èª¬æ˜æ¤œè¨¼ã€‘: ç ”ä¿®å†…å®¹èª¬æ˜ã®é•·ã•ã¨å¿…é ˆæ€§ãƒã‚§ãƒƒã‚¯
    #[validate(length(
        min = 1, 
        max = 10000, 
        message = "ç ”ä¿®èª¬æ˜ã¯1æ–‡å­—ä»¥ä¸Š10000æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚"
    ))]
    pub description: String,
    
    /// ã€å‰ææ¡ä»¶æ¤œè¨¼ã€‘: å—è¬›ã«å¿…è¦ãªå‰ææ¡ä»¶ã®é•·ã•ãƒã‚§ãƒƒã‚¯
    #[validate(length(
        min = 1, 
        max = 5000, 
        message = "å—è¬›å‰ææ¡ä»¶ã¯1æ–‡å­—ä»¥ä¸Š5000æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚é©åˆ‡ãªé•·ã•ã§ç°¡æ½”ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"
    ))]
    pub prerequisites: String,
    
    /// ã€ã‚´ãƒ¼ãƒ«æ¤œè¨¼ã€‘: ç ”ä¿®ç›®æ¨™ã®é•·ã•ã¨å¿…é ˆæ€§ãƒã‚§ãƒƒã‚¯
    #[validate(length(
        min = 1, 
        max = 5000, 
        message = "ç ”ä¿®ã‚´ãƒ¼ãƒ«ã¯1æ–‡å­—ä»¥ä¸Š5000æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å…·ä½“çš„ã§æ¸¬å®šå¯èƒ½ãªç›®æ¨™ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
    ))]
    pub goals: String,
    
    /// ã€å®Œäº†æ¡ä»¶æ¤œè¨¼ã€‘: ç ”ä¿®å®Œäº†æ¡ä»¶ã®é•·ã•ã¨å¿…é ˆæ€§ãƒã‚§ãƒƒã‚¯
    #[validate(length(
        min = 1, 
        max = 5000, 
        message = "å®Œäº†æ¡ä»¶ã¯1æ–‡å­—ä»¥ä¸Š5000æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ˜ç¢ºã§æ¸¬å®šå¯èƒ½ãªå®Œäº†åŸºæº–ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
    ))]
    pub completion_criteria: String,
}

/// ã€Validatableãƒˆãƒ¬ã‚¤ãƒˆå®Ÿè£…ã€‘: ActiveModelã¨å¼·åŒ–ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ ä½“ã®é€£æº
/// ã€æ”¹å–„å†…å®¹ã€‘: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€è©³ç´°ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€DoSæ”»æ’ƒå¯¾ç­–
/// ã€è¨­è¨ˆæ–¹é‡ã€‘: ç ”ä¿®ã‚³ãƒ¼ã‚¹å›ºæœ‰ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’è€ƒæ…®
/// ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: Red/Greenãƒ•ã‚§ãƒ¼ã‚ºã§ä½œæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¨å®Œå…¨äº’æ›
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ç ”ä¿®ç®¡ç†ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å®Ÿå‹™è¦ä»¶ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«åŸºã¥ã
impl Validatable for ActiveModel {
    /// ã€ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚¡ã‚¯ãƒˆãƒªã€‘: ActiveModelã®å€¤ã‚’ä½¿ç”¨ã—ã¦å¼·åŒ–ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æ§‹é€ ä½“ã‚’ä½œæˆ
    /// ã€æ”¹å–„å†…å®¹ã€‘: åŒ…æ‹¬çš„ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œè¨¼ã¨è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±æä¾›
    /// ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: test_å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§æœŸå¾…ã•ã‚Œã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æä¾›
    /// ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: DoSæ”»æ’ƒå¯¾ç­–ã¨ã—ã¦ã®æ–‡å­—æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½æä¾›
    fn validator(&self) -> Box<dyn Validate> {
        // ã€å¼·åŒ–ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ç”Ÿæˆã€‘: å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’æŠ½å‡ºã—ã¦æ¤œè¨¼å¯¾è±¡ã¨ã™ã‚‹
        // ã€ãƒ‡ãƒ¼ã‚¿å®‰å…¨æ€§ã€‘: ActiveValueã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’è§£é™¤ã—ã¦å®Ÿéš›ã®å€¤ã‚’å–å¾—
        Box::new(Validator {
            title: self.title.as_ref().to_owned(),
            description: self.description.as_ref().to_owned(),
            prerequisites: self.prerequisites.as_ref().to_owned(),
            goals: self.goals.as_ref().to_owned(),
            completion_criteria: self.completion_criteria.as_ref().to_owned(),
        })
    }
}

/// ã€ActiveModelBehaviorå®Ÿè£…ã€‘: ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã®åŒ…æ‹¬çš„è‡ªå‹•å‡¦ç†
/// ã€æ”¹å–„å†…å®¹ã€‘: UUIDä¸»ã‚­ãƒ¼ç”Ÿæˆã€å¼·åŒ–ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿è¨¼
/// ã€è¨­è¨ˆæ–¹é‡ã€‘: æ–°è¦ä½œæˆæ™‚ã¨æ›´æ–°æ™‚ã§ã®é©åˆ‡ãªå‡¦ç†åˆ†å²ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
/// ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: Red/Greenãƒ•ã‚§ãƒ¼ã‚ºã§æœŸå¾…ã•ã‚Œã‚‹å…¨æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆ
/// ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®äº‹å‰æ¤œè¨¼ã¨æ‚ªæ„ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã®æ‹’å¦
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ç ”ä¿®ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã«åŸºã¥ã
#[async_trait::async_trait]
impl ActiveModelBehavior for super::_entities::trainings::ActiveModel {
    /// ã€ãƒ‡ãƒ¼ã‚¿ä¿å­˜å‰å‡¦ç†ã€‘: åŒ…æ‹¬çš„ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨UUIDç”Ÿæˆå‡¦ç†
    /// ã€æ”¹å–„å†…å®¹ã€‘: å¼·åŒ–ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿è¨¼
    /// ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã€‘: 1) å¼·åŒ–ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ 2) UUIDç”Ÿæˆ(æ–°è¦æ™‚) 3) ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª
    /// ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€‘: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã§ã®æ—©æœŸå¤±æ•—ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·è»½æ¸›
    async fn before_save<C>(self, _db: &C, insert: bool) -> Result<Self, DbErr>
    where
        C: ConnectionTrait,
    {
        // ã€å¼·åŒ–ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã€‘: ä¿å­˜å‰ã«åŒ…æ‹¬çš„ãªãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’å®Ÿè¡Œ
        // ã€æ—©æœŸå¤±æ•—æˆ¦ç•¥ã€‘: ä¸æ­£ãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã‚’å›é¿ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
        self.validate()?;
        
        if insert {
            // ã€æ–°è¦ä½œæˆå‡¦ç†ã€‘: ç ”ä¿®ã‚³ãƒ¼ã‚¹åˆå›ä½œæˆæ™‚ã®ç‰¹åˆ¥å‡¦ç†
            let mut this = self;
            
            // ã€UUIDä¸»ã‚­ãƒ¼è‡ªå‹•ç”Ÿæˆã€‘: æ¨æ¸¬å›°é›£ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’è‡ªå‹•ç”Ÿæˆ
            // ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€‘: é€£ç•ªã§ã¯ãªãUUIDã‚’ä½¿ç”¨ã—ã¦æƒ…å ±æ¼ãˆã„é˜²æ­¢
            this.id = ActiveValue::Set(uuid::Uuid::new_v4());
            
            // ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèªã€‘: æ–°è¦ä½œæˆæ™‚ã®ãƒ‡ãƒ¼ã‚¿ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
            // ã€å°†æ¥æ‹¡å¼µã€‘: created_byã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ç¢ºèªã€ç ”ä¿®ã‚³ãƒ¼ã‚¹æ•°åˆ¶é™ãªã©
            Ok(this)
        } else {
            // ã€æ›´æ–°å‡¦ç†ã€‘: æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°æ™‚ã¯UUIDç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—
            // ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€‘: ä¸è¦ãªå‡¦ç†ã‚’é˜²ã„ã§æ›´æ–°æ€§èƒ½ã‚’å‘ä¸Š
            Ok(self)
        }
    }
}

/// ã€Modelå®Ÿè£…ã€‘: ç ”ä¿®ã‚³ãƒ¼ã‚¹ã®é«˜åº¦ãªæ¤œç´¢ãƒ»å–å¾—ãƒ»æ“ä½œæ©Ÿèƒ½
/// ã€æ”¹å–„å†…å®¹ã€‘: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€æŸ”è»Ÿãªæ¤œç´¢æ©Ÿèƒ½ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
/// ã€è¨­è¨ˆæ–¹é‡ã€‘: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
/// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ã¨N+1å•é¡Œå¯¾ç­–ã‚’è€ƒæ…®ã—ãŸé«˜é€Ÿãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹
/// ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã€‘: æŸ”è»Ÿãªæ¤œç´¢æ¡ä»¶ã€é©åˆ‡ãªã‚½ãƒ¼ãƒˆé †ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
/// ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: DoSæ”»æ’ƒå¯¾ç­–ã€å…¥åŠ›å€¤æ­£è¦åŒ–ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡å¯¾å¿œ
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ç ”ä¿®ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿå‹™è¦ä»¶ã¨æ—¢å­˜TDDãƒ†ã‚¹ãƒˆå®Ÿè£…ã¨å®Œå…¨äº’æ›
impl Model {
    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: æŒ‡å®šä¼æ¥­ã«æ‰€å±ã™ã‚‹ç ”ä¿®ã‚³ãƒ¼ã‚¹ä¸€è¦§ã‚’å–å¾—
    /// ã€æ”¹å–„å†…å®¹ã€‘: ä¸¦ã³é †ã®æœ€é©åŒ–ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¼æ¥­ã¨ã®1å¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã—ãŸåŠ¹ç‡çš„ãªæ¤œç´¢
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: company_idã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢ ğŸŸ¢
    /// ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã€‘: ç ”ä¿®ã‚¿ã‚¤ãƒˆãƒ«ã§ã®æ˜‡é †ã‚½ãƒ¼ãƒˆã«ã‚ˆã‚‹ä½¿ã„ã‚„ã™ã•å‘ä¸Š ğŸŸ¢
    pub async fn find_by_company_id(db: &DatabaseConnection, company_id: uuid::Uuid) -> ModelResult<Vec<Self>> {
        // ã€åŠ¹ç‡çš„ãªä¼æ¥­åˆ¥æ¤œç´¢ã€‘: å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢
        // ã€ä¸¦ã³é †æœ€é©åŒ–ã€‘: ç ”ä¿®ã‚¿ã‚¤ãƒˆãƒ«ã§ã®æ˜‡é †ã‚½ãƒ¼ãƒˆã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
        let trainings = trainings::Entity::find()
            .filter(trainings::Column::CompanyId.eq(company_id))
            .order_by_asc(trainings::Column::Title)
            .all(db)
            .await?;
            
        // ã€çµæœè¿”å´ã€‘: æ¤œç´¢çµæœã‚’ãƒ™ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦è¿”å´ï¼ˆ0ä»¶ã®å ´åˆã¯ç©ºãƒ™ã‚¯ã‚¿ãƒ¼ï¼‰
        // ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€‘: å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã«ã‚ˆã‚Šä¼æ¥­ã®å­˜åœ¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹
        Ok(trainings)
    }

    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ç ”ä¿®ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚ˆã‚‹ç ”ä¿®ã‚³ãƒ¼ã‚¹æ¤œç´¢
    /// ã€æ”¹å–„å†…å®¹ã€‘: å…¥åŠ›å€¤æ­£è¦åŒ–ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ã§ã®æŸ”è»Ÿãªãƒãƒƒãƒãƒ³ã‚°
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: titleã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢ ğŸŸ¢
    /// ã€å°†æ¥æ‹¡å¼µã€‘: å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã¸ã®æ‹¡å¼µã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆ ğŸŸ¡
    pub async fn find_by_title_partial(db: &DatabaseConnection, title_keyword: &str) -> ModelResult<Vec<Self>> {
        // ã€å…¥åŠ›å€¤æ­£è¦åŒ–ã€‘: æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒˆãƒªãƒ ã¨å°æ–‡å­—å¤‰æ›ã§æ¤œç´¢ç²¾åº¦å‘ä¸Š
        let normalized_keyword = title_keyword.trim().to_lowercase();
        
        // ã€æŸ”è»Ÿãªéƒ¨åˆ†ä¸€è‡´æ¤œç´¢ã€‘: ILIKEã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ãŸå¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„éƒ¨åˆ†ä¸€è‡´æ¤œç´¢
        let trainings = trainings::Entity::find()
            .filter(trainings::Column::Title.like(&format!("%{}%", normalized_keyword)))
            .order_by_asc(trainings::Column::Title)
            .all(db)
            .await?;
            
        Ok(trainings)
    }
    
    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ç ”ä¿®ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚ˆã‚‹å®Œå…¨ä¸€è‡´æ¤œç´¢
    /// ã€æ”¹å–„å†…å®¹ã€‘: ãƒ¦ãƒ‹ãƒ¼ã‚¯æ¤œç´¢ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: æ­£ç¢ºãªã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒãƒ³ã‚°ã§ã®å˜ä¸€ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: titleã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢ ğŸŸ¢
    pub async fn find_by_title_exact(db: &DatabaseConnection, title: &str) -> ModelResult<Self> {
        // ã€å…¥åŠ›å€¤æ­£è¦åŒ–ã€‘: ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒˆãƒªãƒ ã§æ¤œç´¢ç²¾åº¦å‘ä¸Š
        let normalized_title = title.trim();
        
        // ã€å®Œå…¨ä¸€è‡´æ¤œç´¢ã€‘: æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ã¨å®Œå…¨ã«ä¸€è‡´ã™ã‚‹ç ”ä¿®ã‚³ãƒ¼ã‚¹ã‚’å–å¾—
        let training = trainings::Entity::find()
            .filter(trainings::Column::Title.eq(normalized_title))
            .one(db)
            .await?;
            
        // ã€çµæœå‡¦ç†ã€‘: è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯EntityNotFoundã‚¨ãƒ©ãƒ¼
        training.ok_or_else(|| ModelError::EntityNotFound)
    }
    
    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ä¼æ¥­åˆ¥ç ”ä¿®ã‚³ãƒ¼ã‚¹ã®åŠ¹ç‡çš„ãªãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å–å¾—
    /// ã€æ”¹å–„å†…å®¹ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¼æ¥­ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ãƒšãƒ¼ã‚¸ãƒ³ã‚°æ©Ÿèƒ½ã®çµ„ã¿åˆã‚ã›
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: LIMIT/OFFSETã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾— ğŸŸ¡
    /// ã€å°†æ¥æ‹¡å¼µã€‘: ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã¸ã®æ‹¡å¼µã‚’è€ƒæ…® ğŸŸ¡
    pub async fn find_by_company_paginated(
        db: &DatabaseConnection, 
        company_id: uuid::Uuid, 
        page: u64, 
        per_page: u64
    ) -> ModelResult<Vec<Self>> {
        // ã€ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºåˆ¶é™ã€‘: DoSæ”»æ’ƒå¯¾ç­–ã§ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºä¸Šé™ã‚’è¨­å®š
        let limited_per_page = std::cmp::min(per_page, MAX_PAGE_SIZE as u64);
        
        // ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—ã€‘: ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤ã®å®‰å…¨ãªè¨ˆç®—
        let offset = page.saturating_mul(limited_per_page);
        
        // ã€åŠ¹ç‡çš„ãªä¼æ¥­åˆ¥æ¤œç´¢ã€‘: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã®ç ”ä¿®ã‚³ãƒ¼ã‚¹ä¸€è¦§å–å¾—
        // ã€ä¸¦ã³é †æœ€é©åŒ–ã€‘: ç ”ä¿®ã‚¿ã‚¤ãƒˆãƒ«ã§ã®æ˜‡é †ã‚½ãƒ¼ãƒˆã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
        let trainings = trainings::Entity::find()
            .filter(trainings::Column::CompanyId.eq(company_id))
            .order_by_asc(trainings::Column::Title)
            .limit(limited_per_page)
            .offset(offset)
            .all(db)
            .await?;
            
        Ok(trainings)
    }
    
    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ç ”ä¿®ã‚³ãƒ¼ã‚¹ã®é«˜åº¦ãªæ¨ªæ–­æ¤œç´¢æ©Ÿèƒ½
    /// ã€æ”¹å–„å†…å®¹ã€‘: è¤‡æ•°æ¡ä»¶ã§ã®çµ„ã¿åˆã‚ã›æ¤œç´¢ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¼æ¥­ã€ã‚¿ã‚¤ãƒˆãƒ«ã€ä½œæˆè€…ã«ã‚ˆã‚‹æŸ”è»Ÿãªæ¤œç´¢æ©Ÿèƒ½
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢ ğŸŸ¢
    /// ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã€‘: ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹æŸ”è»Ÿãªæ¤œç´¢æ¡ä»¶æŒ‡å®š ğŸŸ¢
    pub async fn search_advanced(
        db: &DatabaseConnection,
        company_id: Option<uuid::Uuid>,
        title_keyword: Option<&str>,
        created_by: Option<i32>,
        page: u64,
        per_page: u64
    ) -> ModelResult<Vec<Self>> {
        // ã€ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºåˆ¶é™ã€‘: DoSæ”»æ’ƒå¯¾ç­–ã§ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºä¸Šé™ã‚’è¨­å®š
        let limited_per_page = std::cmp::min(per_page, MAX_PAGE_SIZE as u64);
        let offset = page.saturating_mul(limited_per_page);
        
        // ã€æŸ”è»Ÿãªã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã€‘: ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¿œã˜ã¦å‹•çš„ã«æ¤œç´¢æ¡ä»¶ã‚’æ§‹ç¯‰
        let mut query = trainings::Entity::find();
        
        // ã€ä¼æ¥­ãƒ•ã‚£ãƒ«ã‚¿ã€‘: æŒ‡å®šã•ã‚ŒãŸå ´åˆã®ã¿ä¼æ¥­æ¡ä»¶ã‚’è¿½åŠ 
        if let Some(cid) = company_id {
            query = query.filter(trainings::Column::CompanyId.eq(cid));
        }
        
        // ã€ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ã€‘: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã®ã¿ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢ã‚’å®Ÿè¡Œ
        if let Some(keyword) = title_keyword {
            let normalized_keyword = keyword.trim().to_lowercase();
            query = query.filter(trainings::Column::Title.like(&format!("%{}%", normalized_keyword)));
        }
        
        // ã€ä½œæˆè€…ãƒ•ã‚£ãƒ«ã‚¿ã€‘: æŒ‡å®šã•ã‚ŒãŸå ´åˆã®ã¿ä½œæˆè€…æ¡ä»¶ã‚’è¿½åŠ 
        if let Some(creator_id) = created_by {
            query = query.filter(trainings::Column::CreatedBy.eq(creator_id));
        }
        
        // ã€ã‚¯ã‚¨ãƒªå®Ÿè¡Œã€‘: ã‚½ãƒ¼ãƒˆã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã—ã¦çµæœã‚’å–å¾—
        let trainings = query
            .order_by_asc(trainings::Column::Title)
            .limit(limited_per_page)
            .offset(offset)
            .all(db)
            .await?;
            
        Ok(trainings)
    }
}