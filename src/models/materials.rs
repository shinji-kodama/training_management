/**
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: æ•™æï¼ˆMaterialsï¼‰ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…
 * ã€å®Ÿè£…æ–¹é‡ã€‘: Companiesã¨Studentsãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²ã—ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹æœ€å°é™ã®æ©Ÿèƒ½ã‚’å®Ÿè£…
 * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: Redãƒ•ã‚§ãƒ¼ã‚ºã§ä½œæˆã•ã‚ŒãŸMaterialsãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’é€šã™ãŸã‚ã®å®Ÿè£…
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜Companiesã¨Studentsãƒ¢ãƒ‡ãƒ«ã¨åŒç­‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®Ÿè£…
 */

use loco_rs::prelude::*;
use sea_orm::{QueryOrder, QuerySelect}; // ã€æ¤œç´¢æ©Ÿèƒ½æ‹¡å¼µã€‘: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¨ä¸¦ã³é †åˆ¶å¾¡ã«å¿…è¦ãªãƒˆãƒ¬ã‚¤ãƒˆ
use serde::Deserialize;

pub use super::_entities::materials::{self, ActiveModel, Entity, Model};

// ã€è¨­å®šå®šæ•°ã€‘: URLãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³å‡¦ç†ã®å®‰å…¨æ€§ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ä¿è¨¼ã™ã‚‹åˆ¶é™å€¤
// ã€èª¿æ•´å¯èƒ½æ€§ã€‘: å°†æ¥çš„ãªè¦ä»¶å¤‰æ›´ã«å¯¾å¿œã§ãã‚‹è¨­å®šå€¤ã¨ã—ã¦å®šç¾©
const MAX_URL_LENGTH: usize = 2048; // ã€URLé•·åˆ¶é™ã€‘: RFC 2616ã«åŸºã¥ãå®Ÿç”¨çš„ãªä¸Šé™å€¤ ğŸŸ¢
const MAX_DOMAIN_LENGTH: usize = 253; // ã€ãƒ‰ãƒ¡ã‚¤ãƒ³é•·åˆ¶é™ã€‘: RFC 1035ã«åŸºã¥ããƒ‰ãƒ¡ã‚¤ãƒ³åã®æœ€å¤§é•· ğŸŸ¢
const FALLBACK_DOMAIN: &str = "unknown"; // ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ã€‘: è§£æå¤±æ•—æ™‚ã®å®‰å…¨ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ ğŸŸ¢
const MIN_RECOMMENDATION_LEVEL: i32 = 1; // ã€æ¨å¥¨ãƒ¬ãƒ™ãƒ«ä¸‹é™ã€‘: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹CHECKåˆ¶ç´„ã¨åŒæœŸã—ãŸæœ€å°å€¤ ğŸŸ¢
const MAX_RECOMMENDATION_LEVEL: i32 = 5; // ã€æ¨å¥¨ãƒ¬ãƒ™ãƒ«ä¸Šé™ã€‘: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹CHECKåˆ¶ç´„ã¨åŒæœŸã—ãŸæœ€å¤§å€¤ ğŸŸ¢
const MAX_PAGE_SIZE: u32 = 100; // ã€ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºä¸Šé™ã€‘: ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ€§èƒ½ã‚’è€ƒæ…®ã—ãŸå®Ÿç”¨çš„åˆ¶é™ ğŸŸ¢

#[derive(Debug, Validate, Deserialize)]
pub struct Validator {
    #[validate(length(min = 1, max = 255, message = "æ•™æã‚¿ã‚¤ãƒˆãƒ«ã¯1æ–‡å­—ä»¥ä¸Š255æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"))]
    pub title: String,
    #[validate(url(message = "æœ‰åŠ¹ãªURLå½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"))]
    pub url: String,
    #[validate(length(min = 1, max = 255, message = "ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯1æ–‡å­—ä»¥ä¸Š255æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"))]
    pub domain: String,
    #[validate(length(min = 1, message = "æ•™æèª¬æ˜ã¯1æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"))]
    pub description: String,
    #[validate(custom(function = "validate_recommendation_level"))]
    pub recommendation_level: i32,
}

/**
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: æ¨å¥¨ãƒ¬ãƒ™ãƒ«ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¼·åŒ–ç‰ˆã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
 * ã€æ”¹å–„å†…å®¹ã€‘: ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨è¨­å®šå€¤ã®å¤–éƒ¨åŒ–ã«ã‚ˆã‚Šãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’å‘ä¸Š
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶ç´„ã®äºŒé‡ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚‹å …ç‰¢æ€§ç¢ºä¿
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: åˆ†å²å‡¦ç†ã‚’æœ€å°åŒ–ã—ã€åŠ¹ç‡çš„ãªç¯„å›²ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…
 * ã€ä¿å®ˆæ€§ã€‘: åˆ¶é™å€¤ã‚’å®šæ•°åŒ–ã—ã¦å°†æ¥çš„ãªå¤‰æ›´ã«å¯¾å¿œã—ã‚„ã™ã„æ§‹é€ 
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã¨ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ä»•æ§˜ã«åŸºã¥ãç¢ºå®Ÿãªå®Ÿè£…
 */
fn validate_recommendation_level(recommendation_level: i32) -> Result<(), validator::ValidationError> {
    // ã€æ¨å¥¨ãƒ¬ãƒ™ãƒ«ç¯„å›²ãƒã‚§ãƒƒã‚¯ã€‘: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãå³å¯†ãªç¯„å›²æ¤œè¨¼
    // ã€åŠ¹ç‡çš„åˆ¤å®šã€‘: å˜ä¸€ã®æ¡ä»¶å¼ã«ã‚ˆã‚‹é«˜é€Ÿãªç¯„å›²ãƒã‚§ãƒƒã‚¯
    if (MIN_RECOMMENDATION_LEVEL..=MAX_RECOMMENDATION_LEVEL).contains(&recommendation_level) {
        Ok(())
    } else {
        // ã€è©³ç´°ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦åˆ†ã‹ã‚Šã‚„ã™ã„å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        // ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã€‘: æœ‰åŠ¹ãªç¯„å›²ã‚’æ˜ç¤ºã™ã‚‹ã“ã¨ã§ä¿®æ­£æ–¹é‡ã‚’æ˜ç¢ºåŒ–
        let mut error = validator::ValidationError::new("invalid_recommendation_level");
        error.message = Some(format!(
            "æ¨å¥¨ãƒ¬ãƒ™ãƒ«ã¯{}ã‹ã‚‰{}ã®ç¯„å›²å†…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå…¥åŠ›å€¤: {}ï¼‰",
            MIN_RECOMMENDATION_LEVEL, MAX_RECOMMENDATION_LEVEL, recommendation_level
        ).into());
        Err(error)
    }
}

impl Validatable for ActiveModel {
    fn validator(&self) -> Box<dyn Validate> {
        Box::new(Validator {
            title: self.title.as_ref().to_owned(),
            url: self.url.as_ref().to_owned(),
            domain: self.domain.as_ref().to_owned(),
            description: self.description.as_ref().to_owned(),
            recommendation_level: self.recommendation_level.as_ref().to_owned(),
        })
    }
}

#[async_trait::async_trait]
impl ActiveModelBehavior for super::_entities::materials::ActiveModel {
    /**
     * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ãƒ‡ãƒ¼ã‚¿ä¿å­˜å‰ã®å‰å‡¦ç†ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã€UUIDç”Ÿæˆã€ãƒ‰ãƒ¡ã‚¤ãƒ³æŠ½å‡ºï¼‰
     * ã€å®Ÿè£…æ–¹é‡ã€‘: Companiesã¨Studentsãƒ¢ãƒ‡ãƒ«ã¨åŒæ§˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§åŸºæœ¬æ©Ÿèƒ½ã‚’å®Ÿè£…
     * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: test_æ•™ææƒ…å ±ã®æ­£å¸¸ä½œæˆãƒ†ã‚¹ãƒˆã®UUIDç”Ÿæˆè¦ä»¶ã«å¯¾å¿œ
     * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¸è¥²ã«ã‚ˆã‚‹ç¢ºå®Ÿãªå®Ÿè£…
     */
    async fn before_save<C>(self, _db: &C, insert: bool) -> Result<Self, DbErr>
    where
        C: ConnectionTrait,
    {
        // ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã€‘: ä¿å­˜å‰ã«ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        self.validate()?;
        
        if insert {
            let mut this = self;
            // ã€UUIDä¸»ã‚­ãƒ¼ç”Ÿæˆã€‘: æ–°è¦ä½œæˆæ™‚ã«UUIDã‚’è‡ªå‹•ç”Ÿæˆ
            this.id = ActiveValue::Set(uuid::Uuid::new_v4());
            
            // ã€ãƒ‰ãƒ¡ã‚¤ãƒ³æŠ½å‡ºã€‘: URLã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†ã‚’è‡ªå‹•æŠ½å‡º
            // ğŸŸ¡ ç°¡æ˜“å®Ÿè£…: ãƒªãƒ•ã‚¡ã‚¯ã‚¿æ®µéšã§ã‚ˆã‚Šå³å¯†ãªãƒ‰ãƒ¡ã‚¤ãƒ³æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã«æ”¹å–„äºˆå®š
            if let ActiveValue::Set(url) = &this.url {
                let domain = extract_domain_from_url(url);
                this.domain = ActiveValue::Set(domain);
            }
            
            Ok(this)
        } else {
            Ok(self)
        }
    }
}

/**
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: URLã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å®‰å…¨ã«æŠ½å‡ºã™ã‚‹æ”¹å–„ç‰ˆå®Ÿè£…
 * ã€æ”¹å–„å†…å®¹ã€‘: ã‚ˆã‚Šå³å¯†ãªURLè§£æã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œè¨¼ã‚’å®Ÿè£…
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: RFC 3986ã«æº–æ‹ ã—ãŸURLè§£æã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®é©ç”¨
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: ä¸è¦ãªæ–‡å­—åˆ—ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ€å°åŒ–ã—ã€åŠ¹ç‡çš„ãªå‡¦ç†ã‚’å®Ÿç¾
 * ã€ä¿å®ˆæ€§ã€‘: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚’æ˜ç¢ºã«åˆ†é¡ã—ã€å°†æ¥ã®æ©Ÿèƒ½æ‹¡å¼µã«å¯¾å¿œã—ã‚„ã™ã„æ§‹é€ 
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: RFCæ¨™æº–ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«åŸºã¥ãç¢ºå®Ÿãªå®Ÿè£…
 */
fn extract_domain_from_url(url: &str) -> String {
    // ã€å…¥åŠ›å€¤äº‹å‰æ¤œè¨¼ã€‘: ç©ºæ–‡å­—åˆ—ã‚„ç•°å¸¸ã«é•·ã„URLã®æ—©æœŸæ¤œå‡º
    // ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ã€‘: DoSæ”»æ’ƒã‚’é˜²ããŸã‚ã®URLé•·åˆ¶é™ãƒã‚§ãƒƒã‚¯
    if url.is_empty() || url.len() > MAX_URL_LENGTH {
        return FALLBACK_DOMAIN.to_string();
    }
    
    // ã€å®‰å…¨ãªURLè§£æã€‘: RFC 3986æº–æ‹ ã®å³å¯†ãªURLè§£æã‚’å®Ÿè¡Œ
    // ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€‘: è§£æå¤±æ•—æ™‚ã®é©åˆ‡ãªåˆ†é¡ã¨å¯¾å‡¦
    match url::Url::parse(url) {
        Ok(parsed_url) => {
            match parsed_url.host_str() {
                Some(host) => {
                    // ã€ãƒ‰ãƒ¡ã‚¤ãƒ³æ­£è¦åŒ–ã€‘: å®‰å…¨ãªãƒ‰ãƒ¡ã‚¤ãƒ³åã¸ã®æ­£è¦åŒ–å‡¦ç†
                    // ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã€‘: æ‚ªæ„ã®ã‚ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º
                    normalize_domain(host)
                },
                None => {
                    // ã€URLæ§‹é€ ã‚¨ãƒ©ãƒ¼ã€‘: ãƒ›ã‚¹ãƒˆéƒ¨åˆ†ãŒå­˜åœ¨ã—ãªã„URLï¼ˆfile:// ç­‰ï¼‰
                    FALLBACK_DOMAIN.to_string()
                }
            }
        },
        Err(_) => {
            // ã€URLå½¢å¼ã‚¨ãƒ©ãƒ¼ã€‘: ä¸æ­£ãªå½¢å¼ã®URLæ–‡å­—åˆ—
            // ã€ãƒ­ã‚°è¨˜éŒ²ã€‘: å°†æ¥ã®ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¨˜éŒ²ï¼ˆæœ¬å®Ÿè£…ã§ã¯çœç•¥ï¼‰
            FALLBACK_DOMAIN.to_string()
        }
    }
}

/**
 * ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€‘: ãƒ‰ãƒ¡ã‚¤ãƒ³åã®æ­£è¦åŒ–ã¨å®‰å…¨æ€§æ¤œè¨¼
 * ã€å†åˆ©ç”¨æ€§ã€‘: ãƒ‰ãƒ¡ã‚¤ãƒ³é–¢é€£ã®å‡¦ç†ã§å…±é€šåˆ©ç”¨å¯èƒ½
 * ã€å˜ä¸€è²¬ä»»ã€‘: ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ­£è¦åŒ–ã®ã¿ã«ç‰¹åŒ–ã—ãŸè²¬ä»»åˆ†é›¢
 */
fn normalize_domain(domain: &str) -> String {
    // ã€æ­£è¦åŒ–å‡¦ç†ã€‘: ãƒ‰ãƒ¡ã‚¤ãƒ³åã®å°æ–‡å­—å¤‰æ›ã¨ä¸è¦æ–‡å­—é™¤å»
    // ã€å¯èª­æ€§å‘ä¸Šã€‘: ä¸€è²«ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³è¡¨è¨˜ã¸ã®çµ±ä¸€
    let normalized = domain.to_lowercase().trim().to_string();
    
    // ã€é•·ã•åˆ¶é™ã€‘: ç•°å¸¸ã«é•·ã„ãƒ‰ãƒ¡ã‚¤ãƒ³åã®æ¤œå‡ºã¨åˆ¶é™
    // ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ã€‘: ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼æ”»æ’ƒã®é˜²æ­¢
    if normalized.len() > MAX_DOMAIN_LENGTH {
        FALLBACK_DOMAIN.to_string()
    } else {
        normalized
    }
}

impl Model {
    /**
     * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: æ•™æã‚’ã‚¿ã‚¤ãƒˆãƒ«ã§æ¤œç´¢ã™ã‚‹æ©Ÿèƒ½ï¼ˆä¸€æ„æ¤œç´¢ï¼‰
     * ã€æ”¹å–„å†…å®¹ã€‘: å…¥åŠ›å€¤ã®æ­£è¦åŒ–ã¨è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ 
     * ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¸€æ„æ€§ã‚’å‰æã¨ã—ãŸå˜ä¸€ãƒ¬ã‚³ãƒ¼ãƒ‰æ¤œç´¢ã«ç‰¹åŒ–
     * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸåŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒªå®Ÿè¡Œ
     * ã€ä¿å®ˆæ€§ã€‘: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®æ˜ç¢ºãªåˆ†é¡ã¨å‡¦ç†
     * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã«åŸºã¥ãç¢ºå®Ÿãªå®Ÿè£…
     */
    pub async fn find_by_title(db: &DatabaseConnection, title: &str) -> ModelResult<Self> {
        // ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: ç©ºæ–‡å­—åˆ—ã‚„ç•°å¸¸ã«é•·ã„ã‚¿ã‚¤ãƒˆãƒ«ã®æ—©æœŸæ¤œå‡º
        if title.is_empty() || title.len() > 255 {
            return Err(ModelError::EntityNotFound);
        }
        
        let material = materials::Entity::find()
            .filter(materials::Column::Title.eq(title.trim()))
            .one(db)
            .await?;
        material.ok_or_else(|| ModelError::EntityNotFound)
    }

    /**
     * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: æ•™æã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ã§æ¤œç´¢ã™ã‚‹æ©Ÿèƒ½ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
     * ã€æ”¹å–„å†…å®¹ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã¨ä¸¦ã³é †åˆ¶å¾¡ã‚’è¿½åŠ 
     * ã€è¨­è¨ˆæ–¹é‡ã€‘: ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªæ¤œç´¢ä½“é¨“ã®æä¾›ã¨ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®æœ€é©åŒ–
     * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: LIMIT/OFFSETã‚¯ã‚¨ãƒªã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾—
     * ã€ä¿å®ˆæ€§ã€‘: ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºåˆ¶é™ã«ã‚ˆã‚‹äºˆæœŸã—ãªã„å¤§é‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã®é˜²æ­¢
     * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆã«åŸºã¥ãç¢ºå®Ÿãªå®Ÿè£…
     */
    pub async fn find_by_domain_paginated(
        db: &DatabaseConnection, 
        domain: &str,
        page: u32,
        page_size: u32
    ) -> ModelResult<Vec<Self>> {
        // ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®åˆ¶é™ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³åã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
        // ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ã€‘: éå¤§ãªãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªæ¯æ¸‡æ”»æ’ƒã®é˜²æ­¢
        if page_size == 0 || page_size > MAX_PAGE_SIZE || domain.is_empty() {
            return Ok(vec![]);
        }
        
        let offset = page.saturating_mul(page_size);
        
        let materials = materials::Entity::find()
            .filter(materials::Column::Domain.eq(domain.trim().to_lowercase()))
            .order_by_asc(materials::Column::Title) // ã€ä¸¦ã³é †ã€‘: ä¸€è²«ã—ãŸè¡¨ç¤ºé †åºã®ä¿è¨¼
            .limit(page_size as u64)
            .offset(offset as u64)
            .all(db)
            .await?;
        Ok(materials)
    }

    /**
     * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: æ¨å¥¨ãƒ¬ãƒ™ãƒ«åˆ¥ã®æ•™ææ¤œç´¢æ©Ÿèƒ½ï¼ˆç¯„å›²æ¤œç´¢å¯¾å¿œï¼‰
     * ã€æ”¹å–„å†…å®¹ã€‘: ç¯„å›²æ¤œç´¢æ©Ÿèƒ½ã¨ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦æ¤œç´¢ä½“é¨“ã‚’å‘ä¸Š
     * ã€è¨­è¨ˆæ–¹é‡ã€‘: æŸ”è»Ÿãªæ¤œç´¢æ¡ä»¶è¨­å®šã«ã‚ˆã‚‹é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
     * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸåŠ¹ç‡çš„ãªç¯„å›²æ¤œç´¢
     * ã€ä¿å®ˆæ€§ã€‘: æ¨å¥¨ãƒ¬ãƒ™ãƒ«ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ã¨å®‰å…¨ãªç¯„å›²æ¤œç´¢
     * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã¨ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãç¢ºå®Ÿãªå®Ÿè£…
     */
    pub async fn find_by_recommendation_range(
        db: &DatabaseConnection, 
        min_level: i32, 
        max_level: i32
    ) -> ModelResult<Vec<Self>> {
        // ã€ç¯„å›²æ¤œè¨¼ã€‘: æ¨å¥¨ãƒ¬ãƒ™ãƒ«ç¯„å›²ã®å¦¥å½“æ€§ã¨è«–ç†çš„æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯
        // ã€ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«æ¤œè¨¼ã€‘: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ã¨åŒæœŸã—ãŸå€¤åŸŸãƒã‚§ãƒƒã‚¯
        if min_level < MIN_RECOMMENDATION_LEVEL || max_level > MAX_RECOMMENDATION_LEVEL || min_level > max_level {
            return Ok(vec![]);
        }
        
        let materials = materials::Entity::find()
            .filter(materials::Column::RecommendationLevel.gte(min_level))
            .filter(materials::Column::RecommendationLevel.lte(max_level))
            .order_by_desc(materials::Column::RecommendationLevel) // ã€å„ªå…ˆé †åºã€‘: é«˜è©•ä¾¡é †ã§ã®è¡¨ç¤º
            .order_by_asc(materials::Column::Title) // ã€å‰¯æ¬¡ã‚½ãƒ¼ãƒˆã€‘: åŒè©•ä¾¡å†…ã§ã®ã‚¿ã‚¤ãƒˆãƒ«é †
            .all(db)
            .await?;
        Ok(materials)
    }

    /**
     * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: æ¨å¥¨ãƒ¬ãƒ™ãƒ«åˆ¥ã®æ•™ææ¤œç´¢æ©Ÿèƒ½ï¼ˆå˜ä¸€ãƒ¬ãƒ™ãƒ«æ¤œç´¢ã€ä¸‹ä½äº’æ›æ€§ç¶­æŒï¼‰
     * ã€æ”¹å–„å†…å®¹ã€‘: æ—¢å­˜APIã¨ã®äº’æ›æ€§ã‚’ä¿ã¡ã¤ã¤å†…éƒ¨å®Ÿè£…ã‚’ç¯„å›²æ¤œç´¢ã«çµ±ä¸€
     * ã€è¨­è¨ˆæ–¹é‡ã€‘: ãƒ¬ã‚¬ã‚·ãƒ¼APIã‚µãƒãƒ¼ãƒˆã¨æ–°æ©Ÿèƒ½ã®çµ±åˆã«ã‚ˆã‚‹ä¸€è²«æ€§ç¢ºä¿
     * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: å†…éƒ¨ã§ç¯„å›²æ¤œç´¢ã‚’æ´»ç”¨ã—ãŸåŠ¹ç‡çš„ãªå®Ÿè£…
     * ã€ä¿å®ˆæ€§ã€‘: å˜ä¸€å®Ÿè£…ã«ã‚ˆã‚‹ä¿å®ˆã‚³ã‚¹ãƒˆã®å‰Šæ¸›
     * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ–°æ©Ÿèƒ½ã¸ã®çµ±åˆã«ã‚ˆã‚‹ç¢ºå®Ÿæ€§ã®å‘ä¸Š
     */
    pub async fn find_by_recommendation_level(db: &DatabaseConnection, level: i32) -> ModelResult<Vec<Self>> {
        // ã€å®Ÿè£…çµ±ä¸€ã€‘: ç¯„å›²æ¤œç´¢æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ãŸå˜ä¸€ãƒ¬ãƒ™ãƒ«æ¤œç´¢ã®å®Ÿç¾
        // ã€ä¸‹ä½äº’æ›æ€§ã€‘: æ—¢å­˜ã®APIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç¶­æŒ
        Self::find_by_recommendation_range(db, level, level).await
    }
}