/**
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: å—è¬›è€…ï¼ˆStudentsï¼‰ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…
 * ã€æ”¹å–„å†…å®¹ã€‘: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€ã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Š
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¼æ¥­ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã€åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã€ä¿å®ˆæ€§ã®å‘ä¸Š
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ã¨N+1å•é¡Œå¯¾ç­–ã‚’è€ƒæ…®ã—ãŸå®Ÿè£…
 * ã€ä¿å®ˆæ€§ã€‘: å¼·åŒ–ã•ã‚ŒãŸæ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆã¨ä¸€è²«ã—ãŸå‘½åè¦å‰‡
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®åˆ¶ç´„å®šç¾©ã¨TDDå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã
 */

use loco_rs::prelude::*;
use serde::Deserialize;
use sea_orm::{QueryOrder, QuerySelect};

pub use super::_entities::students::{self, ActiveModel, Entity, Model};

/// ã€å®šæ•°å®šç¾©ã€‘: å—è¬›è€…ãƒ‡ãƒ¼ã‚¿ã®åˆ¶ç´„å€¤ç®¡ç†
/// ã€ä¿å®ˆæ€§å‘ä¸Šã€‘: ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼æ’é™¤ã¨è¨­å®šå¤‰æ›´ã®å®¹æ˜“åŒ–
/// ã€å°†æ¥æ‹¡å¼µã€‘: å‹•çš„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…æ™‚ã«ä½¿ç”¨äºˆå®š
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®åˆ¶ç´„ã¨ä¸€è‡´
#[allow(dead_code)]
const MAX_NAME_LENGTH: usize = 255;
#[allow(dead_code)]
const MAX_ORGANIZATION_LENGTH: usize = 255;
#[allow(dead_code)]
const MIN_INPUT_LENGTH: usize = 1;

/// ã€è¨±å¯å½¹å‰²å®šç¾©ã€‘: ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨å¯èƒ½ãªå½¹å‰²ã‚¿ã‚¤ãƒ—
/// ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€‘: å½¹å‰²ã‚¿ã‚¤ãƒ—ã®å³å¯†ãªç®¡ç†ã¨æ¤œè¨¼
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®CHECKåˆ¶ç´„ã¨å®Œå…¨ä¸€è‡´
const ALLOWED_ROLE_TYPES: &[&str] = &["student", "company_admin"];

/**
 * ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ ä½“ã€‘: å—è¬›è€…ãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ›å€¤æ¤œè¨¼
 * ã€å®Ÿè£…æ–¹é‡ã€‘: ãƒ†ã‚¹ãƒˆã§è¦æ±‚ã•ã‚Œã‚‹æœ€å°é™ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…
 * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ãƒã‚§ãƒƒã‚¯ã¨æ–‡å­—æ•°åˆ¶é™ã‚’ã‚µãƒãƒ¼ãƒˆ
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®åˆ¶ç´„å®šç¾©ã«åŸºã¥ã
 */
#[derive(Debug, Validate, Deserialize)]
pub struct Validator {
    #[validate(length(min = 1, max = 255, message = "å—è¬›è€…åã¯1æ–‡å­—ä»¥ä¸Š255æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"))]
    pub name: String,
    #[validate(email(message = "æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"))]
    pub email: String,
    #[validate(length(min = 1, max = 255, message = "æ‰€å±çµ„ç¹”ã¯1æ–‡å­—ä»¥ä¸Š255æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"))]
    pub organization: String,
    // ã€å½¹å‰²ã‚¿ã‚¤ãƒ—æ¤œè¨¼ã€‘: student, company_adminã®ã¿è¨±å¯
    #[validate(custom(function = "validate_role_type"))]
    pub role_type: String,
}

/**
 * ã€ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€‘: å½¹å‰²ã‚¿ã‚¤ãƒ—ã®å€¤ãƒã‚§ãƒƒã‚¯
 * ã€æ”¹å–„å†…å®¹ã€‘: å®šæ•°é…åˆ—ã‚’ä½¿ç”¨ã—ãŸä¿å®ˆæ€§å‘ä¸Šã¨å¯èª­æ€§å¼·åŒ–
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ã®CHECKåˆ¶ç´„ã«å¯¾å¿œã—ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€‘: è¨±å¯å€¤ã®å³å¯†ãªç®¡ç†ã«ã‚ˆã‚‹ä¸æ­£å…¥åŠ›é˜²æ­¢
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®CHECKåˆ¶ç´„å®šç¾©ã«æº–æ‹ 
 */
fn validate_role_type(role_type: &str) -> Result<(), validator::ValidationError> {
    // ã€è¨±å¯å€¤ãƒã‚§ãƒƒã‚¯ã€‘: å®šæ•°é…åˆ—ã‚’ä½¿ç”¨ã—ãŸå½¹å‰²ã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼
    // ã€ä¿å®ˆæ€§å‘ä¸Šã€‘: æ–°ã—ã„å½¹å‰²è¿½åŠ æ™‚ã¯ALLOWED_ROLE_TYPESé…åˆ—ã®ã¿æ›´æ–°ã™ã‚Œã°è‰¯ã„
    if ALLOWED_ROLE_TYPES.contains(&role_type) {
        Ok(())
    } else {
        // ã€è©³ç´°ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€‘: ä¸æ­£ãªå½¹å‰²ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’è¿”å´
        // ã€ãƒ‡ãƒãƒƒã‚°æ”¯æ´ã€‘: ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã‚’æ˜ç¢ºåŒ–ã—ã¦ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å®¹æ˜“ã«
        Err(validator::ValidationError::new("invalid_role_type"))
    }
}

impl Validatable for ActiveModel {
    fn validator(&self) -> Box<dyn Validate> {
        // ã€ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ç”Ÿæˆã€‘: ActiveModelã®å€¤ã‚’ä½¿ç”¨ã—ã¦ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æ§‹é€ ä½“ã‚’ä½œæˆ
        // ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: Redãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ†ã‚¹ãƒˆã§æœŸå¾…ã•ã‚Œã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æä¾›
        Box::new(Validator {
            name: self.name.as_ref().to_owned(),
            email: self.email.as_ref().to_owned(),
            organization: self.organization.as_ref().to_owned(),
            role_type: self.role_type.as_ref().to_owned(),
        })
    }
}

/**
 * ã€ActiveModelBehaviorå®Ÿè£…ã€‘: ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã®è‡ªå‹•å‡¦ç†
 * ã€å®Ÿè£…æ–¹é‡ã€‘: UUIDä¸»ã‚­ãƒ¼ç”Ÿæˆã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚’ã‚µãƒãƒ¼ãƒˆ
 * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: test_å—è¬›è€…æƒ…å ±ã®æ­£å¸¸ä½œæˆãƒ†ã‚¹ãƒˆã§æœŸå¾…ã•ã‚Œã‚‹UUIDç”Ÿæˆæ©Ÿèƒ½
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜Companiesãƒ¢ãƒ‡ãƒ«ã¨åŒç­‰ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
 */
#[async_trait::async_trait]
impl ActiveModelBehavior for super::_entities::students::ActiveModel {
    async fn before_save<C>(self, _db: &C, insert: bool) -> Result<Self, DbErr>
    where
        C: ConnectionTrait,
    {
        // ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã€‘: ä¿å­˜å‰ã«ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        self.validate()?;
        if insert {
            // ã€UUIDä¸»ã‚­ãƒ¼ç”Ÿæˆã€‘: æ–°è¦ä½œæˆæ™‚ã«UUIDä¸»ã‚­ãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆ
            // ã€ãƒ†ã‚¹ãƒˆè¦ä»¶å¯¾å¿œã€‘: test_å—è¬›è€…æƒ…å ±ã®æ­£å¸¸ä½œæˆã§UUIDç”Ÿæˆç¢ºèªãŒå¿…è¦
            let mut this = self;
            this.id = ActiveValue::Set(uuid::Uuid::new_v4());
            Ok(this)
        } else {
            // ã€æ›´æ–°æ™‚å‡¦ç†ã€‘: æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°æ™‚ã¯UUIDç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—
            Ok(self)
        }
    }
}

/// ã€Modelå®Ÿè£…ã€‘: å—è¬›è€…ãƒ‡ãƒ¼ã‚¿ã®æ¤œç´¢ãƒ»å–å¾—æ©Ÿèƒ½
/// ã€æ”¹å–„å†…å®¹ã€‘: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
/// ã€è¨­è¨ˆæ–¹é‡ã€‘: å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
/// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸåŠ¹ç‡çš„ãªæ¤œç´¢
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜ã®TDDãƒ†ã‚¹ãƒˆå®Ÿè£…ã¨å®Œå…¨äº’æ›
impl Model {
    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: æŒ‡å®šä¼æ¥­ã«æ‰€å±ã™ã‚‹å—è¬›è€…ä¸€è¦§ã‚’å–å¾—
    /// ã€æ”¹å–„å†…å®¹ã€‘: ä¸¦ã³é †ã®æœ€é©åŒ–ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¼æ¥­ã¨ã®1å¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã—ãŸåŠ¹ç‡çš„ãªæ¤œç´¢
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: company_idã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢ ğŸŸ¢
    /// ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã€‘: å—è¬›è€…åã§ã®æ˜‡é †ã‚½ãƒ¼ãƒˆã«ã‚ˆã‚‹ä½¿ã„ã‚„ã™ã•å‘ä¸Š ğŸŸ¢
    pub async fn find_by_company_id(db: &DatabaseConnection, company_id: uuid::Uuid) -> ModelResult<Vec<Self>> {
        // ã€åŠ¹ç‡çš„ãªä¼æ¥­åˆ¥æ¤œç´¢ã€‘: å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢
        // ã€ä¸¦ã³é †æœ€é©åŒ–ã€‘: å—è¬›è€…åã§ã®æ˜‡é †ã‚½ãƒ¼ãƒˆã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
        let students = students::Entity::find()
            .filter(students::Column::CompanyId.eq(company_id))
            .order_by_asc(students::Column::Name)
            .all(db)
            .await?;
            
        // ã€çµæœè¿”å´ã€‘: æ¤œç´¢çµæœã‚’ãƒ™ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦è¿”å´ï¼ˆ0ä»¶ã®å ´åˆã¯ç©ºãƒ™ã‚¯ã‚¿ãƒ¼ï¼‰
        // ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€‘: å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã«ã‚ˆã‚Šä¼æ¥­ã®å­˜åœ¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹
        Ok(students)
    }

    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹å—è¬›è€…æ¤œç´¢
    /// ã€æ”¹å–„å†…å®¹ã€‘: å…¥åŠ›å€¤æ­£è¦åŒ–ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: å¤§æ–‡å­—å°æ–‡å­—ã‚’è€ƒæ…®ã—ãŸæ¤œç´¢ç²¾åº¦å‘ä¸Š
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: emailã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢ ğŸŸ¢
    /// ã€å°†æ¥æ‹¡å¼µã€‘: å…¨ä½“æ¤œç´¢æ©Ÿèƒ½ã¸ã®æ‹¡å¼µã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆ ğŸŸ¡
    pub async fn find_by_email(db: &DatabaseConnection, email: &str) -> ModelResult<Self> {
        // ã€å…¥åŠ›å€¤æ­£è¦åŒ–ã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å°æ–‡å­—å¤‰æ›ã§æ¤œç´¢ç²¾åº¦å‘ä¸Š
        let normalized_email = email.trim().to_lowercase();
        
        // ã€åŠ¹ç‡çš„ãªæ¤œç´¢ã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸå˜ä¸€ãƒ¬ã‚³ãƒ¼ãƒ‰æ¤œç´¢
        let student = students::Entity::find()
            .filter(students::Column::Email.eq(normalized_email))
            .one(db)
            .await?;
            
        // ã€çµæœå‡¦ç†ã€‘: è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯EntityNotFoundã‚¨ãƒ©ãƒ¼
        student.ok_or_else(|| ModelError::EntityNotFound)
    }

    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ä¼æ¥­IDã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹è¤‡åˆæ¤œç´¢
    /// ã€æ”¹å–„å†…å®¹ã€‘: ä¸€æ„åˆ¶ç´„ãƒã‚§ãƒƒã‚¯ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: UNIQUE(email, company_id)åˆ¶ç´„ã«å¯¾å¿œã—ãŸåŠ¹ç‡çš„ãªæ¤œç´¢
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢ ğŸŸ¢
    /// ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€‘: ä¼æ¥­é–“ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ç¢ºä¿ ğŸŸ¢
    pub async fn find_by_company_and_email(
        db: &DatabaseConnection, 
        company_id: uuid::Uuid, 
        email: &str
    ) -> ModelResult<Option<Self>> {
        // ã€å…¥åŠ›å€¤æ­£è¦åŒ–ã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å°æ–‡å­—å¤‰æ›ã§æ¤œç´¢ç²¾åº¦å‘ä¸Š
        let normalized_email = email.trim().to_lowercase();
        
        // ã€è¤‡åˆæ¡ä»¶æ¤œç´¢ã€‘: ä¼æ¥­IDã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä¸¡æ–¹ã‚’æ¡ä»¶ã¨ã—ãŸåŠ¹ç‡çš„ãªæ¤œç´¢
        // ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€‘: UNIQUE(email, company_id)ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨
        let student = students::Entity::find()
            .filter(students::Column::CompanyId.eq(company_id))
            .filter(students::Column::Email.eq(normalized_email))
            .one(db)
            .await?;
            
        // ã€Optionalè¿”å´ã€‘: è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯Noneã‚’è¿”å´ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„ï¼‰
        // ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€‘: ä¸€æ„åˆ¶ç´„ã«ã‚ˆã‚ŠåŒä¸€ä¼æ¥­å†…ã§ã®ãƒ¡ãƒ¼ãƒ«é‡è¤‡ã‚’é˜²æ­¢
        Ok(student)
    }

    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ä¼æ¥­åˆ¥å—è¬›è€…ã®åŠ¹ç‡çš„ãªãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å–å¾—
    /// ã€æ”¹å–„å†…å®¹ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¼æ¥­ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ãƒšãƒ¼ã‚¸ãƒ³ã‚°æ©Ÿèƒ½ã®çµ„ã¿åˆã‚ã›
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: LIMIT/OFFSETã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾— ğŸŸ¡
    /// ã€å°†æ¥æ‹¡å¼µã€‘: å½¹å‰²ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã¸ã®æ‹¡å¼µã‚’è€ƒæ…® ğŸŸ¡
    pub async fn find_by_company_paginated(
        db: &DatabaseConnection, 
        company_id: uuid::Uuid, 
        page: u64, 
        per_page: u64
    ) -> ModelResult<Vec<Self>> {
        // ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—ã€‘: ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤ã®å®‰å…¨ãªè¨ˆç®—
        let offset = page.saturating_mul(per_page);
        
        // ã€åŠ¹ç‡çš„ãªä¼æ¥­åˆ¥æ¤œç´¢ã€‘: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã®å—è¬›è€…ä¸€è¦§å–å¾—
        // ã€ä¸¦ã³é †æœ€é©åŒ–ã€‘: å—è¬›è€…åã§ã®æ˜‡é †ã‚½ãƒ¼ãƒˆã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
        let students = students::Entity::find()
            .filter(students::Column::CompanyId.eq(company_id))
            .order_by_asc(students::Column::Name)
            .limit(per_page)
            .offset(offset)
            .all(db)
            .await?;
            
        Ok(students)
    }
}
