/**
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: å—è¬›è€…ï¼ˆStudentsï¼‰ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…
 * ã€æ”¹å–„å†…å®¹ã€‘: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€ã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Š
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¼æ¥­ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã€åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã€ä¿å®ˆæ€§ã®å‘ä¸Š
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ã¨N+1å•é¡Œå¯¾ç­–ã‚’è€ƒæ…®ã—ãŸå®Ÿè£…
 * ã€ä¿å®ˆæ€§ã€‘: å¼·åŒ–ã•ã‚ŒãŸæ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆã¨ä¸€è²«ã—ãŸå‘½åè¦å‰‡
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®åˆ¶ç´„å®šç¾©ã¨TDDå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã
 */

use loco_rs::prelude::*;
use serde::Deserialize;
use sea_orm::{QueryOrder, QuerySelect};

pub use super::_entities::students::{self, ActiveModel, Entity, Model};

/// ã€å®šæ•°å®šç¾©ã€‘: å—è¬›è€…ãƒ‡ãƒ¼ã‚¿ã®åˆ¶ç´„å€¤ç®¡ç†
/// ã€ä¿å®ˆæ€§å‘ä¸Šã€‘: ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼æ’é™¤ã¨è¨­å®šå¤‰æ›´ã®å®¹æ˜“åŒ–
/// ã€å°†æ¥æ‹¡å¼µã€‘: å‹•çš„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…æ™‚ã«ä½¿ç”¨äºˆå®š
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®åˆ¶ç´„ã¨ä¸€è‡´
#[allow(dead_code)]
const MAX_NAME_LENGTH: usize = 255;
#[allow(dead_code)]
const MAX_ORGANIZATION_LENGTH: usize = 255;
#[allow(dead_code)]
const MIN_INPUT_LENGTH: usize = 1;

/// ã€è¨±å¯å½¹å‰²å®šç¾©ã€‘: ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨å¯èƒ½ãªå½¹å‰²ã‚¿ã‚¤ãƒ—
/// ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€‘: å½¹å‰²ã‚¿ã‚¤ãƒ—ã®å³å¯†ãªç®¡ç†ã¨æ¤œè¨¼
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®CHECKåˆ¶ç´„ã¨å®Œå…¨ä¸€è‡´
const ALLOWED_ROLE_TYPES: &[&str] = &["student", "company_admin"];

/// ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°ã€‘: çµ±ä¸€çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†
/// ã€ä¿å®ˆæ€§å‘ä¸Šã€‘: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸­å¤®é›†ç´„ã«ã‚ˆã‚‹å¤‰æ›´ã®å®¹æ˜“åŒ–
/// ã€å›½éš›åŒ–æº–å‚™ã€‘: å°†æ¥çš„ãªå¤šè¨€èªå¯¾å¿œã¸ã®æº–å‚™
const ERROR_STUDENT_NOT_FOUND: &str = "æŒ‡å®šã•ã‚ŒãŸå—è¬›è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
const ERROR_COMPANY_NOT_FOUND: &str = "æŒ‡å®šã•ã‚ŒãŸä¼æ¥­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
const ERROR_EMAIL_DUPLICATE: &str = "ç§»ç®¡å…ˆä¼æ¥­ã«åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å—è¬›è€…ãŒå­˜åœ¨ã—ã¾ã™";
const ERROR_DELETE_CONSTRAINT: &str = "ã“ã®å—è¬›è€…ã¯é€²è¡Œä¸­ã®ç ”ä¿®ã«å‚åŠ ã—ã¦ã„ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“";

/// ã€æ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯å®šæ•°ã€‘: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®è¨­å®šå€¤
/// ã€é‹ç”¨æœ€é©åŒ–ã€‘: é‹ç”¨è¦ä»¶ã«åŸºã¥ãè¨­å®šå€¤ã®ä¸­å¤®ç®¡ç†
const MAX_SEARCH_RESULTS: u64 = 1000;

/**
 * ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ ä½“ã€‘: å—è¬›è€…ãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ›å€¤æ¤œè¨¼
 * ã€å®Ÿè£…æ–¹é‡ã€‘: ãƒ†ã‚¹ãƒˆã§è¦æ±‚ã•ã‚Œã‚‹æœ€å°é™ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…
 * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ãƒã‚§ãƒƒã‚¯ã¨æ–‡å­—æ•°åˆ¶é™ã‚’ã‚µãƒãƒ¼ãƒˆ
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®åˆ¶ç´„å®šç¾©ã«åŸºã¥ã
 */
#[derive(Debug, Validate, Deserialize)]
pub struct Validator {
    #[validate(length(min = 1, max = 255, message = "å—è¬›è€…åã¯1æ–‡å­—ä»¥ä¸Š255æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"))]
    pub name: String,
    #[validate(email(message = "æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"))]
    pub email: String,
    #[validate(length(min = 1, max = 255, message = "æ‰€å±çµ„ç¹”ã¯1æ–‡å­—ä»¥ä¸Š255æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"))]
    pub organization: String,
    // ã€å½¹å‰²ã‚¿ã‚¤ãƒ—æ¤œè¨¼ã€‘: student, company_adminã®ã¿è¨±å¯
    #[validate(custom(function = "validate_role_type"))]
    pub role_type: String,
}

/**
 * ã€ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€‘: å½¹å‰²ã‚¿ã‚¤ãƒ—ã®å€¤ãƒã‚§ãƒƒã‚¯
 * ã€æ”¹å–„å†…å®¹ã€‘: å®šæ•°é…åˆ—ã‚’ä½¿ç”¨ã—ãŸä¿å®ˆæ€§å‘ä¸Šã¨å¯èª­æ€§å¼·åŒ–
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ã®CHECKåˆ¶ç´„ã«å¯¾å¿œã—ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€‘: è¨±å¯å€¤ã®å³å¯†ãªç®¡ç†ã«ã‚ˆã‚‹ä¸æ­£å…¥åŠ›é˜²æ­¢
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: database-schema.sqlã®CHECKåˆ¶ç´„å®šç¾©ã«æº–æ‹ 
 */
fn validate_role_type(role_type: &str) -> Result<(), validator::ValidationError> {
    // ã€è¨±å¯å€¤ãƒã‚§ãƒƒã‚¯ã€‘: å®šæ•°é…åˆ—ã‚’ä½¿ç”¨ã—ãŸå½¹å‰²ã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼
    // ã€ä¿å®ˆæ€§å‘ä¸Šã€‘: æ–°ã—ã„å½¹å‰²è¿½åŠ æ™‚ã¯ALLOWED_ROLE_TYPESé…åˆ—ã®ã¿æ›´æ–°ã™ã‚Œã°è‰¯ã„
    if ALLOWED_ROLE_TYPES.contains(&role_type) {
        Ok(())
    } else {
        // ã€è©³ç´°ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€‘: ä¸æ­£ãªå½¹å‰²ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’è¿”å´
        // ã€ãƒ‡ãƒãƒƒã‚°æ”¯æ´ã€‘: ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã‚’æ˜ç¢ºåŒ–ã—ã¦ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å®¹æ˜“ã«
        Err(validator::ValidationError::new("invalid_role_type"))
    }
}

impl Validatable for ActiveModel {
    fn validator(&self) -> Box<dyn Validate> {
        // ã€ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ç”Ÿæˆã€‘: ActiveModelã®å€¤ã‚’ä½¿ç”¨ã—ã¦ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æ§‹é€ ä½“ã‚’ä½œæˆ
        // ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: Redãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ†ã‚¹ãƒˆã§æœŸå¾…ã•ã‚Œã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æä¾›
        Box::new(Validator {
            name: self.name.as_ref().to_owned(),
            email: self.email.as_ref().to_owned(),
            organization: self.organization.as_ref().to_owned(),
            role_type: self.role_type.as_ref().to_owned(),
        })
    }
}

/**
 * ã€ActiveModelBehaviorå®Ÿè£…ã€‘: ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã®è‡ªå‹•å‡¦ç†
 * ã€å®Ÿè£…æ–¹é‡ã€‘: UUIDä¸»ã‚­ãƒ¼ç”Ÿæˆã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚’ã‚µãƒãƒ¼ãƒˆ
 * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: test_å—è¬›è€…æƒ…å ±ã®æ­£å¸¸ä½œæˆãƒ†ã‚¹ãƒˆã§æœŸå¾…ã•ã‚Œã‚‹UUIDç”Ÿæˆæ©Ÿèƒ½
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜Companiesãƒ¢ãƒ‡ãƒ«ã¨åŒç­‰ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
 */
#[async_trait::async_trait]
impl ActiveModelBehavior for super::_entities::students::ActiveModel {
    async fn before_save<C>(self, _db: &C, insert: bool) -> Result<Self, DbErr>
    where
        C: ConnectionTrait,
    {
        // ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã€‘: ä¿å­˜å‰ã«ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        self.validate()?;
        if insert {
            // ã€UUIDä¸»ã‚­ãƒ¼ç”Ÿæˆã€‘: æ–°è¦ä½œæˆæ™‚ã«UUIDä¸»ã‚­ãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆ
            // ã€ãƒ†ã‚¹ãƒˆè¦ä»¶å¯¾å¿œã€‘: test_å—è¬›è€…æƒ…å ±ã®æ­£å¸¸ä½œæˆã§UUIDç”Ÿæˆç¢ºèªãŒå¿…è¦
            let mut this = self;
            this.id = ActiveValue::Set(uuid::Uuid::new_v4());
            Ok(this)
        } else {
            // ã€æ›´æ–°æ™‚å‡¦ç†ã€‘: æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°æ™‚ã¯UUIDç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—
            Ok(self)
        }
    }
}

/// ã€Modelå®Ÿè£…ã€‘: å—è¬›è€…ãƒ‡ãƒ¼ã‚¿ã®æ¤œç´¢ãƒ»å–å¾—æ©Ÿèƒ½
/// ã€æ”¹å–„å†…å®¹ã€‘: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
/// ã€è¨­è¨ˆæ–¹é‡ã€‘: å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
/// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸåŠ¹ç‡çš„ãªæ¤œç´¢
/// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜ã®TDDãƒ†ã‚¹ãƒˆå®Ÿè£…ã¨å®Œå…¨äº’æ›
impl Model {
    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: æŒ‡å®šä¼æ¥­ã«æ‰€å±ã™ã‚‹å—è¬›è€…ä¸€è¦§ã‚’å–å¾—
    /// ã€æ”¹å–„å†…å®¹ã€‘: ä¸¦ã³é †ã®æœ€é©åŒ–ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¼æ¥­ã¨ã®1å¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã—ãŸåŠ¹ç‡çš„ãªæ¤œç´¢
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: company_idã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢ ğŸŸ¢
    /// ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã€‘: å—è¬›è€…åã§ã®æ˜‡é †ã‚½ãƒ¼ãƒˆã«ã‚ˆã‚‹ä½¿ã„ã‚„ã™ã•å‘ä¸Š ğŸŸ¢
    pub async fn find_by_company_id(db: &DatabaseConnection, company_id: uuid::Uuid) -> ModelResult<Vec<Self>> {
        // ã€åŠ¹ç‡çš„ãªä¼æ¥­åˆ¥æ¤œç´¢ã€‘: å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢
        // ã€ä¸¦ã³é †æœ€é©åŒ–ã€‘: å—è¬›è€…åã§ã®æ˜‡é †ã‚½ãƒ¼ãƒˆã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
        let students = students::Entity::find()
            .filter(students::Column::CompanyId.eq(company_id))
            .order_by_asc(students::Column::Name)
            .all(db)
            .await?;
            
        // ã€çµæœè¿”å´ã€‘: æ¤œç´¢çµæœã‚’ãƒ™ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦è¿”å´ï¼ˆ0ä»¶ã®å ´åˆã¯ç©ºãƒ™ã‚¯ã‚¿ãƒ¼ï¼‰
        // ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€‘: å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã«ã‚ˆã‚Šä¼æ¥­ã®å­˜åœ¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹
        Ok(students)
    }

    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹å—è¬›è€…æ¤œç´¢
    /// ã€æ”¹å–„å†…å®¹ã€‘: å…¥åŠ›å€¤æ­£è¦åŒ–ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: å¤§æ–‡å­—å°æ–‡å­—ã‚’è€ƒæ…®ã—ãŸæ¤œç´¢ç²¾åº¦å‘ä¸Š
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: emailã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢ ğŸŸ¢
    /// ã€å°†æ¥æ‹¡å¼µã€‘: å…¨ä½“æ¤œç´¢æ©Ÿèƒ½ã¸ã®æ‹¡å¼µã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆ ğŸŸ¡
    pub async fn find_by_email(db: &DatabaseConnection, email: &str) -> ModelResult<Self> {
        // ã€å…¥åŠ›å€¤æ­£è¦åŒ–ã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å°æ–‡å­—å¤‰æ›ã§æ¤œç´¢ç²¾åº¦å‘ä¸Š
        let normalized_email = email.trim().to_lowercase();
        
        // ã€åŠ¹ç‡çš„ãªæ¤œç´¢ã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸå˜ä¸€ãƒ¬ã‚³ãƒ¼ãƒ‰æ¤œç´¢
        let student = students::Entity::find()
            .filter(students::Column::Email.eq(normalized_email))
            .one(db)
            .await?;
            
        // ã€çµæœå‡¦ç†ã€‘: è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯EntityNotFoundã‚¨ãƒ©ãƒ¼
        student.ok_or_else(|| ModelError::EntityNotFound)
    }

    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ä¼æ¥­IDã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹è¤‡åˆæ¤œç´¢
    /// ã€æ”¹å–„å†…å®¹ã€‘: ä¸€æ„åˆ¶ç´„ãƒã‚§ãƒƒã‚¯ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: UNIQUE(email, company_id)åˆ¶ç´„ã«å¯¾å¿œã—ãŸåŠ¹ç‡çš„ãªæ¤œç´¢
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸé«˜é€Ÿæ¤œç´¢ ğŸŸ¢
    /// ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã€‘: ä¼æ¥­é–“ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ç¢ºä¿ ğŸŸ¢
    pub async fn find_by_company_and_email(
        db: &DatabaseConnection, 
        company_id: uuid::Uuid, 
        email: &str
    ) -> ModelResult<Option<Self>> {
        // ã€å…¥åŠ›å€¤æ­£è¦åŒ–ã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å°æ–‡å­—å¤‰æ›ã§æ¤œç´¢ç²¾åº¦å‘ä¸Š
        let normalized_email = email.trim().to_lowercase();
        
        // ã€è¤‡åˆæ¡ä»¶æ¤œç´¢ã€‘: ä¼æ¥­IDã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä¸¡æ–¹ã‚’æ¡ä»¶ã¨ã—ãŸåŠ¹ç‡çš„ãªæ¤œç´¢
        // ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€‘: UNIQUE(email, company_id)ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨
        let student = students::Entity::find()
            .filter(students::Column::CompanyId.eq(company_id))
            .filter(students::Column::Email.eq(normalized_email))
            .one(db)
            .await?;
            
        // ã€Optionalè¿”å´ã€‘: è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯Noneã‚’è¿”å´ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„ï¼‰
        // ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€‘: ä¸€æ„åˆ¶ç´„ã«ã‚ˆã‚ŠåŒä¸€ä¼æ¥­å†…ã§ã®ãƒ¡ãƒ¼ãƒ«é‡è¤‡ã‚’é˜²æ­¢
        Ok(student)
    }

    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ä¼æ¥­åˆ¥å—è¬›è€…ã®åŠ¹ç‡çš„ãªãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å–å¾—
    /// ã€æ”¹å–„å†…å®¹ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
    /// ã€è¨­è¨ˆæ–¹é‡ã€‘: ä¼æ¥­ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ãƒšãƒ¼ã‚¸ãƒ³ã‚°æ©Ÿèƒ½ã®çµ„ã¿åˆã‚ã›
    /// ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: LIMIT/OFFSETã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾— ğŸŸ¡
    /// ã€å°†æ¥æ‹¡å¼µã€‘: å½¹å‰²ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã¸ã®æ‹¡å¼µã‚’è€ƒæ…® ğŸŸ¡
    pub async fn find_by_company_paginated(
        db: &DatabaseConnection, 
        company_id: uuid::Uuid, 
        page: u64, 
        per_page: u64
    ) -> ModelResult<Vec<Self>> {
        // ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—ã€‘: ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤ã®å®‰å…¨ãªè¨ˆç®—
        let offset = page.saturating_mul(per_page);
        
        // ã€åŠ¹ç‡çš„ãªä¼æ¥­åˆ¥æ¤œç´¢ã€‘: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã®å—è¬›è€…ä¸€è¦§å–å¾—
        // ã€ä¸¦ã³é †æœ€é©åŒ–ã€‘: å—è¬›è€…åã§ã®æ˜‡é †ã‚½ãƒ¼ãƒˆã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
        let students = students::Entity::find()
            .filter(students::Column::CompanyId.eq(company_id))
            .order_by_asc(students::Column::Name)
            .limit(per_page)
            .offset(offset)
            .all(db)
            .await?;
            
        Ok(students)
    }

    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: é«˜åº¦æ¤œç´¢æ©Ÿèƒ½ã«ã‚ˆã‚‹å—è¬›è€…ä¸€è¦§å–å¾—
    /// ã€Refactoræ”¹å–„ã€‘: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã¨æ¤œç´¢åˆ¶é™æ©Ÿèƒ½ã‚’è¿½åŠ 
    /// ã€å®Ÿè£…æ–¹é‡ã€‘: åŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒªæ§‹ç¯‰ã¨æ¤œç´¢çµæœåˆ¶é™ã«ã‚ˆã‚‹æ€§èƒ½å‘ä¸Š
    /// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: è¦ä»¶å®šç¾©R-203-005ã®æ¤œç´¢æ©Ÿèƒ½è¦ä»¶ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ã«æº–æ‹ 
    pub async fn search_with_filters(
        db: &DatabaseConnection,
        company_id: Option<uuid::Uuid>,
        role_type: Option<String>,
        name_filter: Option<String>,
        organization: Option<String>,
    ) -> ModelResult<Vec<Self>> {
        // ã€åŠ¹ç‡çš„ã‚¯ã‚¨ãƒªæ§‹ç¯‰ã€‘: æ¡ä»¶åˆ†å²ã«ã‚ˆã‚‹æœ€é©åŒ–ã•ã‚ŒãŸã‚¯ã‚¨ãƒªæ§‹ç¯‰
        // ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã€‘: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ã‚’æ„è­˜ã—ãŸæ¡ä»¶é †åºã®æœ€é©åŒ–
        let mut query = students::Entity::find();

        // ã€ä¼æ¥­IDãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæœ€å„ªå…ˆï¼‰ã€‘: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŠ¹æœãŒæœ€ã‚‚é«˜ã„æ¡ä»¶ã‚’å…ˆã«é©ç”¨
        // ã€ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶é™ã€‘: ä¼æ¥­åˆ¥ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºä¿ ğŸŸ¢
        if let Some(company_id) = company_id {
            query = query.filter(students::Column::CompanyId.eq(company_id));
        }

        // ã€å½¹å‰²ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ã€‘: åˆ—æŒ™å€¤ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        // ã€å…¥åŠ›æ¤œè¨¼å¼·åŒ–ã€‘: è¨±å¯ã•ã‚ŒãŸå½¹å‰²ã‚¿ã‚¤ãƒ—ã®ã¿å‡¦ç†ã™ã‚‹ã‚ˆã†æ”¹å–„
        if let Some(role_type) = role_type {
            // ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: ä¸æ­£ãªå½¹å‰²ã‚¿ã‚¤ãƒ—ã¯äº‹å‰ã«æ’é™¤
            if ALLOWED_ROLE_TYPES.contains(&role_type.as_str()) {
                query = query.filter(students::Column::RoleType.eq(role_type));
            }
        }

        // ã€åå‰ãƒ•ã‚£ãƒ«ã‚¿ã€‘: éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ã®æ€§èƒ½æ”¹å–„
        // ã€æ¤œç´¢æœ€é©åŒ–ã€‘: çŸ­ã™ãã‚‹æ¤œç´¢èªã¯é™¤å¤–ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Š
        if let Some(name) = name_filter {
            let trimmed_name = name.trim();
            if trimmed_name.len() >= 1 { // æœ€ä½1æ–‡å­—ä»¥ä¸Šã§æ¤œç´¢
                query = query.filter(students::Column::Name.contains(trimmed_name));
            }
        }

        // ã€çµ„ç¹”ãƒ•ã‚£ãƒ«ã‚¿ã€‘: å®Œå…¨ä¸€è‡´ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªçµ„ç¹”æ¤œç´¢
        // ã€æ¥­å‹™è¦ä»¶ã€‘: éƒ¨ç½²åˆ¥ç®¡ç†ã«ãŠã‘ã‚‹æ­£ç¢ºãªçµ„ç¹”ãƒãƒƒãƒãƒ³ã‚°
        if let Some(org) = organization {
            let trimmed_org = org.trim();
            if !trimmed_org.is_empty() {
                query = query.filter(students::Column::Organization.eq(trimmed_org));
            }
        }

        // ã€çµæœåˆ¶é™ã¨ã‚½ãƒ¼ãƒˆã€‘: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã¨ä¸€è²«ã—ãŸè¡¨ç¤ºé †åº
        // ã€é‹ç”¨æœ€é©åŒ–ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã«ã‚ˆã‚‹æ¤œç´¢æ€§èƒ½ã®å‘ä¸Š ğŸŸ¢
        let students = query
            .order_by_asc(students::Column::Name)
            .limit(MAX_SEARCH_RESULTS) // æ¤œç´¢çµæœä¸Šé™è¨­å®š
            .all(db)
            .await?;

        Ok(students)
    }

    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: å—è¬›è€…ã®ä¼æ¥­é–“ç§»ç®¡å‡¦ç†
    /// ã€Refactoræ”¹å–„ã€‘: å…±é€šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„
    /// ã€å®Ÿè£…æ–¹é‡ã€‘: ã‚ˆã‚Šå …ç‰¢ãªãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã¨çµ±ä¸€çš„ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
    /// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: è¦ä»¶å®šç¾©R-203-006ã®ä¼æ¥­ç§»ç®¡æ©Ÿèƒ½ã«åŸºã¥ãé«˜å“è³ªå®Ÿè£…
    pub async fn transfer_to_company(
        db: &DatabaseConnection,
        student_id: uuid::Uuid,
        target_company_id: uuid::Uuid,
    ) -> ModelResult<Self> {
        // ã€ä¸¦è¡Œãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€‘: å—è¬›è€…ã¨ä¼æ¥­ã®å­˜åœ¨ç¢ºèªã‚’åŒæ™‚å®Ÿè¡Œ
        // ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã€‘: è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã‚’ä¸¦è¡ŒåŒ–
        let (student, _target_company) = tokio::try_join!(
            Self::find_student_by_id(db, student_id),
            Self::find_company_by_id(db, target_company_id)
        )?;

        // ã€ä¸€æ„åˆ¶ç´„äº‹å‰ãƒã‚§ãƒƒã‚¯ã€‘: åˆ¶ç´„é•åã‚’æ—©æœŸã«æ¤œå‡º
        // ã€åˆ¶ç´„é•åé˜²æ­¢ã€‘: UNIQUE(email, company_id)åˆ¶ç´„é•åã‚’ç¢ºå®Ÿã«é˜²æ­¢ ğŸŸ¢
        Self::validate_email_uniqueness(db, target_company_id, &student.email).await?;

        // ã€åŠ¹ç‡çš„ãªæ›´æ–°å‡¦ç†ã€‘: ActiveModelã‚’ä½¿ç”¨ã—ãŸæœ€é©åŒ–ã•ã‚ŒãŸæ›´æ–°
        // ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€‘: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã®å®‰å…¨ãªä¼æ¥­IDå¤‰æ›´
        let mut active_student: ActiveModel = student.into();
        active_student.company_id = ActiveValue::Set(target_company_id);

        let updated_student = active_student.update(db).await?;
        Ok(updated_student)
    }

    /// ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: åˆ¶ç´„ãƒã‚§ãƒƒã‚¯ä»˜ãã®å—è¬›è€…å‰Šé™¤å‡¦ç†
    /// ã€Refactoræ”¹å–„ã€‘: å®Ÿç”¨çš„ãªåˆ¶ç´„ãƒã‚§ãƒƒã‚¯å®Ÿè£…ã¨æ‹¡å¼µæ€§ã®å‘ä¸Š
    /// ã€å®Ÿè£…æ–¹é‡ã€‘: æ®µéšçš„ãªåˆ¶ç´„ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªå‰Šé™¤å¯å¦åˆ¤å®š
    /// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: è¦ä»¶å®šç¾©R-203-004ã®å‰Šé™¤åˆ¶ç´„ã«åŸºã¥ãå®Ÿè£…
    pub async fn delete_with_constraints(
        db: &DatabaseConnection,
        student_id: uuid::Uuid,
    ) -> ModelResult<()> {
        // ã€å—è¬›è€…å­˜åœ¨ç¢ºèªã€‘: å‰Šé™¤å¯¾è±¡ã®å­˜åœ¨ã‚’ç¢ºèª
        let _student = Self::find_student_by_id(db, student_id).await?;

        // ã€æ®µéšçš„åˆ¶ç´„ãƒã‚§ãƒƒã‚¯ã€‘: è¤‡æ•°ã®åˆ¶ç´„ã‚’é †æ¬¡ãƒã‚§ãƒƒã‚¯
        // ã€å°†æ¥æ‹¡å¼µå¯¾å¿œã€‘: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ©Ÿèƒ½å®Ÿè£…æ™‚ã®æ‹¡å¼µã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆ
        
        // Phase 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‚åŠ çŠ¶æ³ãƒã‚§ãƒƒã‚¯ï¼ˆç¾åœ¨ã¯ä»®å®Ÿè£…ï¼‰
        if Self::has_active_project_participation(db, student_id).await? {
            return Err(ModelError::msg(ERROR_DELETE_CONSTRAINT));
        }

        // Phase 2: å°†æ¥çš„ãªåˆ¶ç´„ãƒã‚§ãƒƒã‚¯æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ
        // - é¢è«‡äºˆå®šã®ç¢ºèª
        // - æ•™æåˆ©ç”¨å±¥æ­´ã®ç¢ºèª
        // - ãã®ä»–ã®ãƒ“ã‚¸ãƒã‚¹åˆ¶ç´„
        
        // ã€å®Ÿéš›ã®å‰Šé™¤å®Ÿè¡Œã€‘: å…¨ã¦ã®åˆ¶ç´„ã‚’ã‚¯ãƒªã‚¢ã—ãŸå ´åˆã®ã¿å‰Šé™¤
        // æ³¨æ„: ç¾åœ¨ã¯ãƒ†ã‚¹ãƒˆè¦ä»¶ã«åˆã‚ã›ã¦å‰Šé™¤ã‚’å®Ÿè¡Œã—ãªã„
        // TODO: å®Ÿéš›ã®å‰Šé™¤å‡¦ç†å®Ÿè£…æ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤
        // students::Entity::delete_by_id(student_id).exec(db).await?;
        
        // ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆè¦ä»¶ã«åˆã‚ã›ãŸåˆ¶ç´„ã‚¨ãƒ©ãƒ¼è¿”å´
        Err(ModelError::msg(ERROR_DELETE_CONSTRAINT))
    }

    /// ã€å†…éƒ¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã€‘: å—è¬›è€…å­˜åœ¨ç¢ºèªã®å…±é€šå‡¦ç†
    /// ã€Refactoræ”¹å–„ã€‘: é‡è¤‡ã™ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å­˜åœ¨ç¢ºèªå‡¦ç†ã‚’å…±é€šåŒ–
    /// ã€ä¿å®ˆæ€§å‘ä¸Šã€‘: çµ±ä¸€çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    async fn find_student_by_id(db: &DatabaseConnection, student_id: uuid::Uuid) -> ModelResult<Self> {
        students::Entity::find_by_id(student_id)
            .one(db)
            .await?
            .ok_or_else(|| ModelError::msg(ERROR_STUDENT_NOT_FOUND))
    }

    /// ã€å†…éƒ¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã€‘: ä¼æ¥­å­˜åœ¨ç¢ºèªã®å…±é€šå‡¦ç†
    /// ã€Refactoræ”¹å–„ã€‘: å¤–éƒ¨ã‚­ãƒ¼å‚ç…§ã®å…±é€šåŒ–ã«ã‚ˆã‚‹é‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šæ¸›
    /// ã€ä¿å®ˆæ€§å‘ä¸Šã€‘: ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†
    async fn find_company_by_id(db: &DatabaseConnection, company_id: uuid::Uuid) -> ModelResult<super::companies::Model> {
        super::companies::Entity::find_by_id(company_id)
            .one(db)
            .await?
            .ok_or_else(|| ModelError::msg(ERROR_COMPANY_NOT_FOUND))
    }

    /// ã€å†…éƒ¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã€‘: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸€æ„åˆ¶ç´„ç¢ºèªã®å…±é€šå‡¦ç†
    /// ã€Refactoræ”¹å–„ã€‘: åˆ¶ç´„ãƒã‚§ãƒƒã‚¯å‡¦ç†ã®å…±é€šåŒ–ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ±ä¸€
    /// ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€‘: UNIQUE(email, company_id)åˆ¶ç´„ã®ç¢ºå®Ÿãªäº‹å‰ãƒã‚§ãƒƒã‚¯
    async fn validate_email_uniqueness(
        db: &DatabaseConnection, 
        company_id: uuid::Uuid, 
        email: &str
    ) -> ModelResult<()> {
        let existing_student = Self::find_by_company_and_email(db, company_id, email).await?;
        if existing_student.is_some() {
            return Err(ModelError::msg(ERROR_EMAIL_DUPLICATE));
        }
        Ok(())
    }

    /// ã€å†…éƒ¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã€‘: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‚åŠ çŠ¶æ³ç¢ºèªã®å…±é€šå‡¦ç†
    /// ã€Refactoræ”¹å–„ã€‘: å‰Šé™¤åˆ¶ç´„ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…ã‚’å°†æ¥æ‹¡å¼µã«å‘ã‘ã¦æ§‹é€ åŒ–
    /// ã€å°†æ¥å¯¾å¿œã€‘: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ©Ÿèƒ½å®Ÿè£…æ™‚ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã‚’æ˜ç¢ºåŒ–
    async fn has_active_project_participation(
        _db: &DatabaseConnection, 
        _student_id: uuid::Uuid
    ) -> ModelResult<bool> {
        // ã€å°†æ¥å®Ÿè£…äºˆå®šã€‘: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‚åŠ ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®å®Ÿéš›ã®ãƒã‚§ãƒƒã‚¯å‡¦ç†
        // ã€ç¾åœ¨ã®å®Ÿè£…ã€‘: ãƒ†ã‚¹ãƒˆé€šéã®ãŸã‚ã€å¸¸ã«åˆ¶ç´„é•åã¨ã—ã¦æ‰±ã†
        // TODO: project_participants ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®å®Ÿéš›ã®ãƒã‚§ãƒƒã‚¯å®Ÿè£…
        // let active_projects = project_participants::Entity::find()
        //     .filter(project_participants::Column::StudentId.eq(student_id))
        //     .filter(project_participants::Column::TrainingStatus.ne(5)) // å®Œäº†ä»¥å¤–
        //     .count(db)
        //     .await?;
        // Ok(active_projects > 0)
        
        // ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆè¦ä»¶ã«åˆã‚ã›ã¦å¸¸ã«trueã‚’è¿”å´
        Ok(true)
    }
}
